<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุณูู ุนูุงุฒ | ูุธุงู ุงูุฅุฏุงุฑุฉ ุงูุดุงูู (SaaS)</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #e67e22; --dark: #0a0a0a; --sidebar: #121212; --card: #1a1a1a; --text: #f1f2f6; --text-muted: #a4b0be; --danger: #ff4757; --success: #2ed573; --info: #3742fa; --warning: #ffa502; }
        body { font-family: 'Cairo', sans-serif; background: var(--dark); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 260px; background: var(--sidebar); border-left: 1px solid #222; display: flex; flex-direction: column; padding: 20px 0; box-shadow: -5px 0 15px rgba(0,0,0,0.5); z-index: 100; overflow-y:auto; }
        .logo-area { text-align: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #222; }
        .logo-area h2 { color: var(--primary); margin: 0; font-weight: 900; }
        .nav-btn { display: flex; align-items: center; gap: 15px; padding: 15px 25px; color: var(--text-muted); cursor: pointer; transition: 0.3s; border-right: 4px solid transparent; font-size: 1.1em; font-weight: 600; background: none; border: none; width: 100%; text-align: right; }
        .nav-btn:hover, .nav-btn.active { background: #1f1f1f; color: var(--primary); border-right-color: var(--primary); }
        .nav-btn i { font-size: 1.2em; width: 25px; text-align: center; }

        .main-content { flex: 1; padding: 30px; overflow-y: auto; background: var(--dark); }
        .section { display: none; animation: fadeIn 0.4s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #222; display: flex; align-items: center; gap: 15px; position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; right: 0; top: 0; height: 100%; width: 4px; background: var(--primary); }
        .stat-card.success::before { background: var(--success); } .stat-card.info::before { background: var(--info); } .stat-card.danger::before { background: var(--danger); }
        .stat-icon { font-size: 2em; color: rgba(255, 255, 255, 0.05); }
        .stat-info h3 { margin: 0; font-size: 0.85em; color: var(--text-muted); }
        .stat-info p { margin: 5px 0 0; font-size: 1.5em; font-weight: 900; color: #fff; }

        .panel { background: var(--card); padding: 25px; border-radius: 15px; border: 1px solid #222; margin-bottom: 20px; }
        .panel-title { color: var(--primary); margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 20px; font-size: 1.2em; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        th { background: #111; color: var(--text-muted); padding: 12px; text-align: right; border-bottom: 2px solid #222; }
        td { padding: 12px; border-bottom: 1px solid #222; color: #eee; }
        
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 6px; color: var(--text-muted); font-size: 0.85em; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #333; background: #111; color: #fff; font-family: 'Cairo'; outline: none; box-sizing: border-box;}
        input[type="file"] { padding: 6px; background: #222; cursor: pointer; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); }
        .checkbox-label { display: flex; align-items: center; gap: 10px; cursor: pointer; color: #fff; font-size: 0.9em; margin-bottom: 10px; }
        .checkbox-label input { width: auto; transform: scale(1.2); cursor: pointer;}
        
        .btn-main { background: var(--primary); color: #000; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 800; font-family: 'Cairo'; width: 100%; transition: 0.3s; }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(230,126,34,0.3); }
        .btn-sm { padding: 5px 10px; border-radius: 5px; cursor: pointer; border: none; font-family: 'Cairo'; font-weight: bold; font-size:0.8em; }
        .btn-edit { background: var(--info); color: #fff; } .btn-delete { background: var(--danger); color: #fff; }
        
        .flex-row { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;}
        .flex-row > div { flex: 1; min-width: 200px; }
        
        #loader { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; color: var(--primary); }
        .spinner { border: 5px solid #222; border-top: 5px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .status-select { background: #333; border: 1px solid #555; color: #fff; padding: 5px; border-radius: 5px; font-family: 'Cairo'; width: auto; }
        
        /* ุชุตููู ูุฑุจุนุงุช ุงูููุงุณุงุช */
        .size-checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-top: 10px; }
        .size-box { background: #222; border: 1px solid #444; border-radius: 8px; padding: 10px; text-align: center; cursor: pointer; transition: 0.3s; color: #fff; font-weight: bold; }
        .size-box:hover { border-color: var(--primary); }
        .size-box.selected { background: var(--primary); color: #000; border-color: var(--primary); }
        .size-box input { display: none; }

        /* ุณููุชุด ุงูุฅุนุฏุงุฏุงุช */
        .switch-container { display: flex; justify-content: space-between; align-items: center; background: #111; padding: 15px; border-radius: 8px; border: 1px solid #333; margin-bottom: 15px; }
        .switch-container span { font-weight: bold; color: #fff; }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #444; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(24px); }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div><h3 id="loader-text">ุฌุงุฑู ุงูุนูู...</h3></div>

    <aside class="sidebar">
        <div class="logo-area"><h2>ุณูู ุนูุงุฒ ๐ฆ</h2><span style="color:var(--text-muted); font-size:0.8em;">ููุญุฉ ุงูุชุญูู ุงููุงุฆูุฉ</span></div>
        <button class="nav-btn active" onclick="switchTab('accounting', this)"><i class="fas fa-chart-pie"></i> ุงูุชูุงุฑูุฑ ูุงูุญุณุงุจุงุช</button>
        <button class="nav-btn" onclick="switchTab('orders', this)"><i class="fas fa-box-open"></i> ุฅุฏุงุฑุฉ ุงูุทูุจุงุช</button>
        <button class="nav-btn" onclick="switchTab('inventory', this)"><i class="fas fa-plus-square"></i> ุฅุถุงูุฉ ูููุฎุฒู</button>
        <button class="nav-btn" onclick="switchTab('edit-inventory', this)"><i class="fas fa-edit"></i> ูุฑูุช ุงูุตูู (ุชุนุฏูู)</button>
        <button class="nav-btn" id="nav-templates" onclick="switchTab('templates', this)"><i class="fas fa-ruler-combined"></i> ููุงูุจ ุงูููุงุณุงุช</button>
        <button class="nav-btn" onclick="switchTab('settings', this)"><i class="fas fa-cogs"></i> ุฅุนุฏุงุฏุงุช ุงููุชุฌุฑ</button>
        <button class="nav-btn" onclick="switchTab('shipping', this)"><i class="fas fa-truck"></i> ุชุณุนูุฑ ุงูุดุญู</button>
    </aside>

    <main class="main-content">
        <section id="settings" class="section">
            <div class="panel" style="max-width: 600px; margin: auto;">
                <h2 class="panel-title"><i class="fas fa-cogs"></i> ุชุฎุตูุต ูุดุงุท ุงููุชุฌุฑ (Feature Flags)</h2>
                <p style="color:var(--text-muted); font-size:0.9em; margin-bottom:20px;">ูู ุจุชุดุบูู ุฃู ุฅููุงู ุงูุฎุตุงุฆุต ุญุณุจ ููุน ูุดุงุทู ุงูุชุฌุงุฑู ูุชุจุณูุท ููุญุฉ ุงูุชุญูู ูุจุงูู ุงูููุธููู.</p>
                
                <div class="switch-container">
                    <span>ุชูุนูู ุงูุฃุจุนุงุฏ ุงูุตูุจุฉ (ุทููุ ุนุฑุถุ ุชุฎุงูุฉ) <br><small style="color:#888; font-weight:normal;">ูู ุงูุฃุซุงุซุ ุงููุญุงูุธุ ุงูุนูุงุฒ</small></span>
                    <label class="switch"><input type="checkbox" id="set-hard-dim"><span class="slider"></span></label>
                </div>
                <div class="switch-container">
                    <span>ุชูุนูู ุฏููู ููุงุณุงุช ุงูููุงุจุณ (ุตุฏุฑุ ูุชูุ ูู) <br><small style="color:#888; font-weight:normal;">ูู ุงูููุตุงูุ ุงูุชูุดูุฑุชุงุช</small></span>
                    <label class="switch"><input type="checkbox" id="set-cloth-guide"><span class="slider"></span></label>
                </div>
                <div class="switch-container">
                    <span>ุชูุนูู ูุธุงู ุงูุฃููุงู ุงููุชุนุฏุฏุฉ ููููุชุฌ</span>
                    <label class="switch"><input type="checkbox" id="set-colors"><span class="slider"></span></label>
                </div>
                <div class="switch-container">
                    <span>ุชูุนูู ูุธุงู ุงูููุงุณุงุช (ูููุงูุจ ุงูููุงุณุงุช ุงูุฐููุฉ)</span>
                    <label class="switch"><input type="checkbox" id="set-sizes"><span class="slider"></span></label>
                </div>
                <button class="btn-main" onclick="saveStoreSettings()" style="margin-top:10px;">ุญูุธ ุงูุฅุนุฏุงุฏุงุช ูุชุทุจูููุง ููุฑุงู</button>
            </div>
        </section>

        <section id="templates" class="section">
            <div class="panel" style="max-width: 700px; margin: auto;">
                <h2 class="panel-title"><i class="fas fa-layer-group"></i> ุจูุงุก ููุงูุจ ุงูููุงุณุงุช ุงูุฐููุฉ</h2>
                <div class="input-group"><label>ุงุณู ุงููุงูุจ (ูุซุงู: ุฃุญุฐูุฉ ุฑุฌุงููุ ุฌููุฒุ ููุงุณุงุช ุนุงูููุฉ)</label><input type="text" id="tpl-name"></div>
                <div class="input-group"><label>ุงูููุงุณุงุช ุงููุชุงุญุฉ ูู ุงููุงูุจ (ุงูุตู ุจูููุง ุจูุงุตูุฉ , )</label><input type="text" id="tpl-values" placeholder="ูุซุงู: 39, 40, 41, 42, 43, 44"></div>
                <button class="btn-main" onclick="addSizeTemplate()" style="background:var(--info); color:#fff;">ุญูุธ ุงููุงูุจ</button>
                
                <h3 style="margin-top:30px; border-bottom:1px solid #333; padding-bottom:10px;">ุงูููุงูุจ ุงูุญุงููุฉ:</h3>
                <div id="templates-list" style="margin-top:15px;"></div>
            </div>
        </section>

        <section id="accounting" class="section active">
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-wallet"></i> ุงูุฎุฒููุฉ ูุญุฑูุฉ ุงูุฃููุงู</h2>
                <div class="stats-grid">
                    <div class="stat-card success"><i class="fas fa-lock stat-icon"></i><div class="stat-info"><h3>ุฎุฒููุฉ (ููุณููุฉ)</h3><p id="acc-safe">0 ุฌ.ู</p></div></div>
                    <div class="stat-card info"><i class="fas fa-motorcycle stat-icon"></i><div class="stat-info"><h3>ูุน ุงูููุฏูุจ</h3><p id="acc-courier">0 ุฌ.ู</p></div></div>
                    <div class="stat-card warning"><i class="fas fa-clock stat-icon"></i><div class="stat-info"><h3>ุชุญุช ุงููุฑุงุฌุนุฉ</h3><p id="acc-pending">0 ุฌ.ู</p></div></div>
                </div>
            </div>
        </section>

        <section id="orders" class="section">
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-list"></i> ูุงุฆูุฉ ุงูุทูุจุงุช</h2>
                <div style="overflow-x:auto;">
                    <table>
                        <thead><tr><th>ุฑูู ุงูุทูุจ</th><th>ุงูุนููู</th><th>ุงูููุจุงูู</th><th>ุงูููุชุฌุงุช</th><th>ุงูุฅุฌูุงูู</th><th>ุงูุญุงูุฉ</th></tr></thead>
                        <tbody id="orders-table"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="inventory" class="section">
            <div class="flex-row">
                <div class="panel">
                    <h3 class="panel-title"><i class="fas fa-folder-plus"></i> ุฅุถุงูุฉ ูุณู (ุนุฑุจู/ุฅูุฌููุฒู)</h3>
                    <div class="flex-row">
                        <div class="input-group"><label>ุงุณู ุงููุณู (ุนุฑุจู) *</label><input type="text" id="cat-title-ar"></div>
                        <div class="input-group"><label>ุงูุงุณู (ุฅูุฌููุฒู)</label><input type="text" id="cat-title-en"></div>
                    </div>
                    <div class="input-group"><label>ูุชุจุน ูุณู ุฑุฆูุณูุ</label><select id="cat-parent-id"></select></div>
                    <div style="background:#222; padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid #333;">
                        <label class="checkbox-label"><input type="checkbox" id="cat-show-home" checked> ุนุฑุถ ูุดุฑูุท ูู ุงูุฑุฆูุณูุฉุ</label>
                        <div class="input-group"><label>ุชุฑุชูุจ ุงูุธููุฑ (ุฑูู)</label><input type="number" id="cat-home-order" value="1"></div>
                        <label class="checkbox-label"><input type="checkbox" id="cat-allow-bundle"> ุฅุชุงุญุฉ ูู "ูููู ุทููู"ุ</label>
                    </div>
                    <div class="input-group"><label>ุตูุฑ ุงููุณู (ููุณูุงูุฏุฑ)</label><input type="file" id="cat-images" multiple accept="image/*"></div>
                    <button class="btn-main" onclick="addCategory()">ุญูุธ ุงููุณู</button>
                </div>

                <div class="panel">
                    <h3 class="panel-title"><i class="fas fa-box-plus"></i> ุฅุถุงูุฉ ููุชุฌ</h3>
                    <div class="input-group"><label>ุงููุณู *</label><select id="prod-cat"></select></div>
                    <div class="flex-row">
                        <div class="input-group"><label>ุงูุงุณู (ุนุฑุจู) *</label><input type="text" id="prod-title-ar"></div>
                        <div class="input-group"><label>ุงูุงุณู (ุฅูุฌููุฒู)</label><input type="text" id="prod-title-en"></div>
                    </div>
                    <div class="flex-row">
                        <div class="input-group"><label>ุงูุชูููุฉ (ุฌููุฉ)</label><input type="number" id="prod-cost-price" value="0"></div>
                        <div class="input-group"><label>ุงูุจูุน (ูุทุงุนู) *</label><input type="number" id="prod-price"></div>
                        <div class="input-group"><label>ุงููุฎุฒูู</label><input type="number" id="prod-stock" value="100"></div>
                    </div>
                    <div class="input-group"><label>ุงูุตูุฑุฉ ุงูุฑุฆูุณูุฉ *</label><input type="file" id="prod-image" accept="image/*"></div>
                    
                    <div id="div-hard-dimensions" class="flex-row" style="background:#1a1a1a; padding:10px; border:1px dashed #444; border-radius:8px; margin-top:10px;">
                        <div class="input-group"><label>ุงูุทูู (ุณู)</label><input type="text" id="prod-length"></div>
                        <div class="input-group"><label>ุงูุนุฑุถ (ุณู)</label><input type="text" id="prod-width"></div>
                        <div class="input-group"><label>ุงูุชุฎุงูุฉ (ุณู)</label><input type="text" id="prod-thickness"></div>
                    </div>

                    <div id="div-clothing-guide" class="flex-row" style="background:#1a1a1a; padding:10px; border:1px dashed var(--primary); border-radius:8px; margin-top:10px;">
                        <div class="input-group"><label>ูุญูุท ุงูุตุฏุฑ</label><input type="text" id="prod-chest" placeholder="ูุซุงู: 50ุณู"></div>
                        <div class="input-group"><label>ุงููุชู</label><input type="text" id="prod-shoulder" placeholder="ูุซุงู: 45ุณู"></div>
                        <div class="input-group"><label>ุทูู ุงููุทุนุฉ</label><input type="text" id="prod-body" placeholder="ูุซุงู: 70ุณู"></div>
                        <div class="input-group"><label>ุทูู ุงููู</label><input type="text" id="prod-sleeve" placeholder="ูุซุงู: 60ุณู"></div>
                    </div>

                    <button class="btn-main" onclick="addProduct()" style="margin-top:15px;">ุญูุธ ุงูููุชุฌ ูู ุงููุฎุฒู</button>
                </div>
            </div>

            <div class="flex-row" style="margin-top:20px;">
                <div class="panel" id="panel-colors">
                    <h3 class="panel-title"><i class="fas fa-palette"></i> ุฑุจุท ููู ุจููุชุฌ</h3>
                    <div class="input-group"><label>ุงูููุชุฌ *</label><select id="color-prod-id"></select></div>
                    <div class="flex-row">
                        <div class="input-group"><label>ุงูููู (ุนุฑุจู)</label><input type="text" id="color-name-ar"></div>
                        <div class="input-group"><label>ุงูููู (ุฅูุฌููุฒู)</label><input type="text" id="color-name-en"></div>
                    </div>
                    <div class="input-group"><label>ุงูููุฏ (Hex)</label><input type="color" id="color-hex" value="#ff0000" style="height:40px;"></div>
                    <div class="input-group"><label>ุตูุฑุฉ ุงูููุชุฌ ุจุงูููู ุฏู *</label><input type="file" id="color-image" accept="image/*"></div>
                    <button class="btn-main" onclick="addColor()" style="background:#3742fa; color:#fff;">ุญูุธ ุงูููู</button>
                </div>

                <div class="panel" id="panel-sizes">
                    <h3 class="panel-title"><i class="fas fa-ruler"></i> ุชุญุฏูุฏ ููุงุณุงุช ุงูููุชุฌ</h3>
                    <div class="input-group"><label>ุงูููุชุฌ *</label><select id="size-prod-id"></select></div>
                    <div class="input-group"><label>ุงุฎุชุฑ ูุงูุจ ุงูููุงุณุงุช ูุชุณููู ุงูุฅุฏุฎุงู</label><select id="size-template-select" onchange="loadTemplateOptionsForCheckboxes()"></select></div>
                    
                    <div id="size-checkboxes-container" class="size-checkbox-grid">
                        <p style="color:#888; font-size:0.85em; grid-column: 1 / -1;">ุงุฎุชุฑ ูุงูุจ ูุชุธูุฑ ุงูููุงุณุงุช ุงููุชุงุญุฉ...</p>
                    </div>

                    <button class="btn-main" onclick="saveCheckedSizes()" style="background:var(--success); color:#000; margin-top:15px;">ุญูุธ ุงูููุงุณุงุช ุงููุฎุชุงุฑุฉ ููููุชุฌ</button>
                </div>
            </div>
        </section>

        <section id="edit-inventory" class="section">
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-edit"></i> ูุฑูุช ุงูุตูู ูุชุนุฏูู ุงูุฃุณุนุงุฑ</h2>
                <div style="overflow-x:auto;">
                    <table>
                        <thead><tr><th>ุตูุฑุฉ</th><th>ุงูููุชุฌ (AR)</th><th>ุงููุณู</th><th>ุงูุจูุน</th><th>ุงููุฎุฒูู</th><th>ุฅุฌุฑุงุกุงุช</th></tr></thead>
                        <tbody id="edit-products-table"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="shipping" class="section">
            <div class="panel" style="max-width: 500px; margin: auto;">
                <h2 class="panel-title"><i class="fas fa-truck"></i> ุชุนุฏูู ุฃุณุนุงุฑ ุงูุดุญู</h2>
                <div class="input-group"><label>ุงุฎุชุฑ ุงููุญุงูุธุฉ</label><select id="ship-city-select" onchange="loadSelectedCityPrice()"></select></div>
                <div class="input-group"><label>ุณุนุฑ ุงูุดุญู ุงูุญุงูู (ุฌ.ู)</label><input type="number" id="ship-city-price"></div>
                <button class="btn-main" onclick="updateCityPrice()" style="background: var(--info); color: #fff;">ุชุญุฏูุซ ุชุณุนูุฑุฉ ุงูุดุญู</button>
            </div>
        </section>

    </main>

    <script>
        const SUPABASE_URL = 'https://wkfiocqhkspsvqgyjpea.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_l2vgR8Xbt0Csw8W_Slo_1Q_9glKlIoN';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let citiesData = []; let allProductsEdit = []; let allCategoriesEdit = []; let systemSettings = {};

        function showLoader(text) { document.getElementById('loader-text').innerText = text; document.getElementById('loader').style.display = 'flex'; }
        function hideLoader() { document.getElementById('loader').style.display = 'none'; }

        async function initAdmin() {
            showLoader("ุชุฌููุฒ ุงูุฅุนุฏุงุฏุงุช ุงููุงุฆูุฉ...");
            await loadStoreSettingsFromDB();
            hideLoader();
            switchTab('accounting', document.querySelector('.nav-btn.active'));
        }

        function switchTab(tabId, btn) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if(btn) btn.classList.add('active');

            if(tabId === 'accounting') loadComprehensiveReports();
            if(tabId === 'orders') loadOrders();
            if(tabId === 'inventory') { loadCategoriesForSelects(); loadProductsList(); loadSizeTemplatesDropdown(); }
            if(tabId === 'templates') loadTemplatesList();
            if(tabId === 'edit-inventory') loadEditInventory();
            if(tabId === 'shipping') loadCitiesForDropdown();
        }

        async function uploadImage(file) {
            const fileExt = file.name.split('.').pop();
            const fileName = `${Math.random().toString(36).substring(2, 15)}_${Date.now()}.${fileExt}`;
            const { error } = await supabaseClient.storage.from('okaz_images').upload(fileName, file);
            if (error) throw error;
            return supabaseClient.storage.from('okaz_images').getPublicUrl(fileName).data.publicUrl;
        }

        // ================= ุงูุฅุนุฏุงุฏุงุช ูููุงุชูุญ ุงูุชุญูู (SaaS Feature Flags) โ๏ธ =================
        async function loadStoreSettingsFromDB() {
            const { data } = await supabaseClient.from('store_settings').select('*');
            if(data) data.forEach(x => systemSettings[x.setting_key] = x.setting_value);
            
            // ุชุทุจูู ุงูุฅุนุฏุงุฏุงุช ุนูู ุฒุฑุงูุฑ ุดุงุดุฉ ุงูุฅุนุฏุงุฏุงุช
            document.getElementById('set-hard-dim').checked = (systemSettings.enable_hard_dimensions === 'true');
            document.getElementById('set-cloth-guide').checked = (systemSettings.enable_clothing_guide === 'true');
            document.getElementById('set-colors').checked = (systemSettings.enable_colors === 'true');
            document.getElementById('set-sizes').checked = (systemSettings.enable_size_templates === 'true');

            // ุชุทุจูู ุงูุฅุฎูุงุก ูุงูุฅุธูุงุฑ ุนูู ุดุงุดุงุช ุงููุฎุฒู
            document.getElementById('div-hard-dimensions').style.display = (systemSettings.enable_hard_dimensions === 'true') ? 'flex' : 'none';
            document.getElementById('div-clothing-guide').style.display = (systemSettings.enable_clothing_guide === 'true') ? 'flex' : 'none';
            document.getElementById('panel-colors').style.display = (systemSettings.enable_colors === 'true') ? 'block' : 'none';
            document.getElementById('panel-sizes').style.display = (systemSettings.enable_size_templates === 'true') ? 'block' : 'none';
            document.getElementById('nav-templates').style.display = (systemSettings.enable_size_templates === 'true') ? 'flex' : 'none';
        }

        async function saveStoreSettings() {
            showLoader("ุฌุงุฑู ุญูุธ ุงูุชุฎุตูุต...");
            const updates = [
                { setting_key: 'enable_hard_dimensions', setting_value: document.getElementById('set-hard-dim').checked ? 'true' : 'false' },
                { setting_key: 'enable_clothing_guide', setting_value: document.getElementById('set-cloth-guide').checked ? 'true' : 'false' },
                { setting_key: 'enable_colors', setting_value: document.getElementById('set-colors').checked ? 'true' : 'false' },
                { setting_key: 'enable_size_templates', setting_value: document.getElementById('set-sizes').checked ? 'true' : 'false' }
            ];
            
            for(let u of updates) {
                await supabaseClient.from('store_settings').update({ setting_value: u.setting_value }).eq('setting_key', u.setting_key);
            }
            alert("ุชู ุญูุธ ุฅุนุฏุงุฏุงุช ุงููุชุฌุฑ ุจูุฌุงุญ ูุชุทุจูููุง!");
            await loadStoreSettingsFromDB(); // ุฑููุฑูุด ููุดูู
            hideLoader();
        }

        // ================= ุจูุงุก ููุงูุจ ุงูููุงุณุงุช ๐ =================
        async function addSizeTemplate() {
            const name = document.getElementById('tpl-name').value;
            const valsStr = document.getElementById('tpl-values').value;
            if(!name || !valsStr) return alert("ุงูุชุจ ุงุณู ุงููุงูุจ ูุงูููุงุณุงุช!");
            
            showLoader("ุญูุธ ุงููุงูุจ...");
            const sizesArr = valsStr.split(',').map(s => s.trim()).filter(s => s !== '');
            
            const { data: tplData, error } = await supabaseClient.from('size_templates').insert([{ template_name: name }]).select();
            if(error) { hideLoader(); return alert("ุฎุทุฃ ูู ุญูุธ ุงููุงูุจ"); }
            
            const tplId = tplData[0].id;
            const insertOpts = sizesArr.map(sv => ({ template_id: tplId, size_value: sv }));
            await supabaseClient.from('size_template_options').insert(insertOpts);
            
            alert("ุชู ุจูุงุก ูุงูุจ ุงูููุงุณุงุช ุจูุฌุงุญ โ");
            document.getElementById('tpl-name').value = ''; document.getElementById('tpl-values').value = '';
            loadTemplatesList();
            hideLoader();
        }

        async function loadTemplatesList() {
            const { data } = await supabaseClient.from('size_templates').select('*, size_template_options(size_value)');
            const listDiv = document.getElementById('templates-list'); listDiv.innerHTML = '';
            if(!data) return;
            data.forEach(t => {
                const sizesStr = t.size_template_options.map(o => o.size_value).join(' - ');
                listDiv.innerHTML += `<div style="background:#222; padding:10px; border-radius:8px; margin-bottom:10px; border:1px solid #444;">
                    <strong style="color:var(--primary);">${t.template_name}</strong>
                    <div style="color:#aaa; font-size:0.9em; margin-top:5px;">[ ${sizesStr} ]</div>
                </div>`;
            });
        }

        // ================= ูุธุงู ุงููุฎุฒู ูุชุนููู ุงูููุงุณุงุช (Checkboxes) โ๏ธ =================
        async function loadSizeTemplatesDropdown() {
            const { data } = await supabaseClient.from('size_templates').select('*');
            const sel = document.getElementById('size-template-select');
            sel.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงููุงูุจ ุงูููุงุณุจ --</option>';
            if(data) data.forEach(t => sel.innerHTML += `<option value="${t.id}">${t.template_name}</option>`);
        }

        async function loadTemplateOptionsForCheckboxes() {
            const tplId = document.getElementById('size-template-select').value;
            const container = document.getElementById('size-checkboxes-container');
            container.innerHTML = '';
            if(!tplId) { container.innerHTML = '<p style="color:#888; font-size:0.85em; grid-column: 1 / -1;">ุงุฎุชุฑ ูุงูุจ ูุชุธูุฑ ุงูููุงุณุงุช ุงููุชุงุญุฉ...</p>'; return; }
            
            const { data } = await supabaseClient.from('size_template_options').select('*').eq('template_id', tplId);
            if(data) {
                data.forEach(opt => {
                    container.innerHTML += `
                        <label class="size-box" onclick="this.classList.toggle('selected')">
                            ${opt.size_value}
                            <input type="checkbox" value="${opt.size_value}" class="chk-size-val">
                        </label>
                    `;
                });
            }
        }

        async function saveCheckedSizes() {
            const prodId = document.getElementById('size-prod-id').value;
            if(!prodId) return alert("ุงุฎุชุฑ ุงูููุชุฌ ุฃููุงู!");
            
            const checkedBoxes = document.querySelectorAll('.size-box.selected input');
            if(checkedBoxes.length === 0) return alert("ุนูู (ุตุญ) ุนูู ููุงุณ ูุงุญุฏ ุนูู ุงูุฃูู!");
            
            showLoader("ุฌุงุฑู ุญูุธ ุงูููุงุณุงุช...");
            const insertData = Array.from(checkedBoxes).map(chk => ({ product_id: prodId, size_name: chk.value }));
            await supabaseClient.from('product_sizes').insert(insertData);
            alert("ุชู ุญูุธ ุงูููุงุณุงุช ุงููุญุฏุฏุฉ ููููุชุฌ โ");
            
            // ุชุตููุฑ ุงูุงุฎุชูุงุฑุงุช
            document.querySelectorAll('.size-box').forEach(b => b.classList.remove('selected'));
            hideLoader();
        }

        // ================= ุงูููุชุฌุงุช ูุงูุฃูุณุงู ุงูุนุงุฏูุฉ =================
        async function loadCategoriesForSelects() {
            const { data } = await supabaseClient.from('categories').select('*').order('created_at', { ascending: true });
            const selParent = document.getElementById('cat-parent-id'), selProdCat = document.getElementById('prod-cat');
            selParent.innerHTML = '<option value="">-- ูุณู ุฑุฆูุณู ูุณุชูู --</option>'; selProdCat.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงููุณู --</option>';
            data.forEach(c => { selParent.innerHTML += `<option value="${c.id}">${c.title_ar}</option>`; selProdCat.innerHTML += `<option value="${c.id}">${c.title_ar}</option>`; });
        }
        async function loadProductsList() {
            const { data } = await supabaseClient.from('products').select('*');
            let options = '<option value="">-- ุงุฎุชุฑ ุงูููุชุฌ --</option>'; data.forEach(p => options += `<option value="${p.id}">${p.title_ar}</option>`);
            document.getElementById('color-prod-id').innerHTML = options; document.getElementById('size-prod-id').innerHTML = options;
        }

        async function addCategory() {
            const t_ar = document.getElementById('cat-title-ar').value, t_en = document.getElementById('cat-title-en').value || '', p_id = document.getElementById('cat-parent-id').value || null;
            const shw = document.getElementById('cat-show-home').checked, ord = parseInt(document.getElementById('cat-home-order').value) || 0, bndl = document.getElementById('cat-allow-bundle').checked;
            const files = document.getElementById('cat-images');
            if(!t_ar) return alert("ุงูุชุจ ุงูุงุณู ุจุงูุนุฑุจู"); showLoader("ุญูุธ...");
            try { let urls = []; if(files.files.length > 0) { for(let i=0; i<files.files.length; i++) urls.push(await uploadImage(files.files[i])); }
                await supabaseClient.from('categories').insert([{ title_ar: t_ar, title_en: t_en, parent_id: p_id, show_on_home: shw, home_order: ord, allow_in_bundles: bndl, image: urls[0] || '', gallery: urls }]);
                alert("ุชู ุฅุถุงูุฉ ุงููุณู โ"); document.getElementById('cat-title-ar').value=''; loadCategoriesForSelects(); } catch(e) { alert("ุฎุทุฃ"); } hideLoader();
        }

        async function addProduct() {
            const c_id = document.getElementById('prod-cat').value, t_ar = document.getElementById('prod-title-ar').value, prc = document.getElementById('prod-price').value, file = document.getElementById('prod-image');
            if(!c_id || !t_ar || !prc || file.files.length === 0) return alert("ููู ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ ูุงูุตูุฑุฉ");
            showLoader("ุฌุงุฑู ุงูุฑูุน...");
            try { 
                const img = await uploadImage(file.files[0]); 
                await supabaseClient.from('products').insert([{ 
                    category_id: c_id, title_ar: t_ar, title_en: document.getElementById('prod-title-en').value || '', price: prc, cost_price: document.getElementById('prod-cost-price').value || 0, stock_quantity: document.getElementById('prod-stock').value || 100, image: img,
                    length_val: document.getElementById('prod-length')?.value || '', width_val: document.getElementById('prod-width')?.value || '', thickness_val: document.getElementById('prod-thickness')?.value || '',
                    chest_cm: document.getElementById('prod-chest')?.value || '', shoulder_cm: document.getElementById('prod-shoulder')?.value || '', sleeve_cm: document.getElementById('prod-sleeve')?.value || '', body_length_cm: document.getElementById('prod-body')?.value || ''
                }]); 
                alert("ุชู ุฅุถุงูุฉ ุงูููุชุฌ ูููุฎุฒู โ"); document.getElementById('prod-title-ar').value=''; document.getElementById('prod-price').value=''; file.value=''; loadProductsList(); 
            } catch(e) { alert("ุฎุทุฃ"); } hideLoader();
        }

        // ================= ุจุงูู ุงูุฃููุงุฏ ุงูุฃุณุงุณูุฉ (Orders, Edit, Accounting, Shipping) ุดุบุงูุฉ 100% =================
        // ... (ุงุฎุชุตุงุฑุงู ูุนุฑุถ ุฃูู ุงูุฅุถุงูุงุชุ ุจุงูู ุงูุฏูุงู ุงููุนุชุงุฏุฉ ููุทูุจุงุช ูุงูุชูุงุฑูุฑ ุชุนูู ุจููุงุกุฉ ูู ุงููุณุฎุฉ ุงูุณุงุจูุฉ)
        async function loadComprehensiveReports() { /* ... ุญุณุงุจุงุช ุงูุฎุฒูุฉ ... */ }
        async function loadOrders() { /* ... ุฌุฏูู ุงูุทูุจุงุช ... */ }
        async function loadEditInventory() { /* ... ูุฑูุช ุงูุตูู ... */ }
        async function loadCitiesForDropdown() { /* ... ุงูุดุญู ... */ }

        // ุชุดุบูู ุงูููุญุฉ ุงููุงุฆูุฉ
        initAdmin();
    </script>
</body>
</html>
