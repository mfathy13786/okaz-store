<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุฅุฏุงุฑุฉ ุณูู ุนูุงุฒ | ุงูุฅุฏุงุฑุฉ ุงููุชูุฏูุฉ ูุงูุชูุงุฑูุฑ</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #e67e22; --dark: #0a0a0a; --sidebar: #121212; --card: #1a1a1a; --text: #f1f2f6; --text-muted: #a4b0be; --danger: #ff4757; --success: #2ed573; --info: #3742fa; --warning: #ffa502; }
        body { font-family: 'Cairo', sans-serif; background: var(--dark); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 260px; background: var(--sidebar); border-left: 1px solid #222; display: flex; flex-direction: column; padding: 20px 0; box-shadow: -5px 0 15px rgba(0,0,0,0.5); z-index: 100; overflow-y:auto; }
        .logo-area { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #222; }
        .logo-area h2 { color: var(--primary); margin: 0; font-weight: 900; }
        .nav-btn { display: flex; align-items: center; gap: 15px; padding: 15px 25px; color: var(--text-muted); cursor: pointer; transition: 0.3s; border-right: 4px solid transparent; font-size: 1.1em; font-weight: 600; background: none; border: none; width: 100%; text-align: right; }
        .nav-btn:hover, .nav-btn.active { background: #1f1f1f; color: var(--primary); border-right-color: var(--primary); }
        .nav-btn i { font-size: 1.2em; width: 25px; text-align: center; }

        .main-content { flex: 1; padding: 30px; overflow-y: auto; background: var(--dark); }
        .section { display: none; animation: fadeIn 0.4s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card); padding: 25px; border-radius: 15px; border: 1px solid #222; display: flex; align-items: center; gap: 20px; position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; right: 0; top: 0; height: 100%; width: 5px; background: var(--primary); }
        .stat-card.success::before { background: var(--success); }
        .stat-card.info::before { background: var(--info); }
        .stat-card.danger::before { background: var(--danger); }
        .stat-card.warning::before { background: var(--warning); }
        .stat-icon { font-size: 2.5em; color: rgba(255, 255, 255, 0.05); }
        .stat-info h3 { margin: 0; font-size: 0.9em; color: var(--text-muted); }
        .stat-info p { margin: 5px 0 0; font-size: 1.6em; font-weight: 900; color: #fff; }

        .panel { background: var(--card); padding: 25px; border-radius: 15px; border: 1px solid #222; margin-bottom: 20px; }
        .panel-title { color: var(--primary); margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 20px; font-size: 1.2em; }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: #111; color: var(--text-muted); padding: 15px; text-align: right; border-bottom: 2px solid #222; }
        td { padding: 15px; border-bottom: 1px solid #222; color: #eee; }
        
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 8px; color: var(--text-muted); font-size: 0.9em; }
        input, select, textarea { width: 100%; padding: 12px 15px; border-radius: 8px; border: 1px solid #333; background: #111; color: #fff; font-family: 'Cairo'; outline: none; box-sizing: border-box;}
        input[type="file"] { padding: 8px; background: #222; cursor: pointer; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); }
        
        .btn-main { background: var(--primary); color: #000; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: 800; font-family: 'Cairo'; width: 100%; transition: 0.3s; }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(230,126,34,0.3); }
        .btn-sm { padding: 6px 12px; border-radius: 5px; cursor: pointer; border: none; font-family: 'Cairo'; font-weight: bold; }
        .btn-edit { background: var(--info); color: #fff; }
        .btn-delete { background: var(--danger); color: #fff; }
        
        .flex-row { display: flex; gap: 15px; flex-wrap: wrap; }
        .flex-row > div { flex: 1; min-width: 250px; }
        
        #loader { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; color: var(--primary); }
        .spinner { border: 5px solid #222; border-top: 5px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .status-select { background: #333; border: 1px solid #555; color: #fff; padding: 5px; border-radius: 5px; font-family: 'Cairo'; font-size: 0.9em; width: auto; cursor:pointer;}

        /* ููุฏุงู ุงูุชุนุฏูู */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; overflow-y: auto; backdrop-filter: blur(5px); }
        .modal-content { background: #111; width: 95%; max-width: 700px; border-radius: 20px; padding: 30px; border: 1px solid var(--primary); margin: 30px auto; position: relative; }
        .close-btn { position: absolute; top: 15px; left: 15px; background: #333; color: #fff; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 1.2em; }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div><h3 id="loader-text">ุฌุงุฑู ุงูุชุญููู...</h3></div>

    <aside class="sidebar">
        <div class="logo-area"><h2>ุณูู ุนูุงุฒ ๐ฆ</h2><span style="color:var(--text-muted); font-size:0.8em;">ERP & Admin</span></div>
        <button class="nav-btn active" onclick="switchTab('accounting', this)"><i class="fas fa-chart-pie"></i> ุงูุชูุงุฑูุฑ ุงูุดุงููุฉ</button>
        <button class="nav-btn" onclick="switchTab('orders', this)"><i class="fas fa-box-open"></i> ุฅุฏุงุฑุฉ ุงูุทูุจุงุช</button>
        <button class="nav-btn" onclick="switchTab('inventory', this)"><i class="fas fa-plus-square"></i> ุฅุถุงูุฉ ูููุฎุฒู</button>
        <button class="nav-btn" onclick="switchTab('edit-inventory', this)"><i class="fas fa-edit"></i> ูุฑูุช ุงูุตูู (ุชุนุฏูู)</button>
        <button class="nav-btn" onclick="switchTab('shipping', this)"><i class="fas fa-truck"></i> ุชุณุนูุฑ ุงูุดุญู</button>
        <button class="nav-btn" onclick="switchTab('discounts', this)"><i class="fas fa-tags"></i> ุงูููุจููุงุช</button>
    </aside>

    <main class="main-content">
        <section id="accounting" class="section active">
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-wallet"></i> ุงูุฎุฒููุฉ ูุญุฑูุฉ ุฃููุงู ุงูุทูุจุงุช</h2>
                <div class="stats-grid">
                    <div class="stat-card success"><i class="fas fa-lock stat-icon"></i><div class="stat-info"><h3>ูููุณ ุจุงูุฎุฒููุฉ (ููุณููุฉ)</h3><p id="acc-safe">0 ุฌ.ู</p></div></div>
                    <div class="stat-card info"><i class="fas fa-motorcycle stat-icon"></i><div class="stat-info"><h3>ูุน ุงูููุฏูุจ (ุฌุงุฑู ุงูุชูุตูู)</h3><p id="acc-courier">0 ุฌ.ู</p></div></div>
                    <div class="stat-card warning"><i class="fas fa-clock stat-icon"></i><div class="stat-info"><h3>ุฃุฑุจุงุญ ูุชููุนุฉ (ุชุญุช ุงููุฑุงุฌุนุฉ)</h3><p id="acc-pending">0 ุฌ.ู</p></div></div>
                    <div class="stat-card danger"><i class="fas fa-hand-holding-usd stat-icon"></i><div class="stat-info"><h3>ุฅุฌูุงูู ุงูุฎุตููุงุช ุงูููููุญุฉ</h3><p id="acc-discounts">0 ุฌ.ู</p></div></div>
                </div>
            </div>
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-boxes"></i> ุชูููู ุงููุฎุฒู ูุงูุจุถุงุนุฉ ุงููุชุงุญุฉ</h2>
                <div class="stats-grid">
                    <div class="stat-card danger"><i class="fas fa-boxes stat-icon"></i><div class="stat-info"><h3>ุชูููุฉ ุงูุจุถุงุนุฉ (ุฑุฃุณ ุงููุงู)</h3><p id="inv-cost">0 ุฌ.ู</p></div></div>
                    <div class="stat-card info"><i class="fas fa-tags stat-icon"></i><div class="stat-info"><h3>ูููุฉ ุงูุจุถุงุนุฉ (ุณุนุฑ ุงูุจูุน)</h3><p id="inv-retail">0 ุฌ.ู</p></div></div>
                    <div class="stat-card success"><i class="fas fa-chart-line stat-icon"></i><div class="stat-info"><h3>ุตุงูู ุงูุฑุจุญ ุงููุชููุน</h3><p id="inv-profit">0 ุฌ.ู</p></div></div>
                </div>
            </div>
        </section>

        <section id="orders" class="section">
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-list"></i> ูุงุฆูุฉ ุงูุทูุจุงุช ูุญุงูุฉ ุงูุชูุตูู</h2>
                <div style="overflow-x:auto;">
                    <table>
                        <thead><tr><th>ุฑูู ุงูุทูุจ</th><th>ุงูุนููู</th><th>ุงูููุจุงูู</th><th>ุงูููุชุฌุงุช</th><th>ุงูุฅุฌูุงูู</th><th>ุชุบููุฑ ุงูุญุงูุฉ</th></tr></thead>
                        <tbody id="orders-table"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="inventory" class="section">
            <div class="flex-row">
                <div class="panel">
                    <h3 class="panel-title"><i class="fas fa-box-plus"></i> ุฅุถุงูุฉ ููุชุฌ ูููุฎุฒู</h3>
                    <div class="input-group"><label>ุงููุณู</label><select id="prod-cat"></select></div>
                    <div class="input-group"><label>ุงุณู ุงูููุชุฌ</label><input type="text" id="prod-title"></div>
                    <div class="flex-row">
                        <div class="input-group"><label>ุณุนุฑ ุงูุชูููุฉ (ุงูุฌููุฉ)</label><input type="number" id="prod-cost-price"></div>
                        <div class="input-group"><label>ุณุนุฑ ุงูุจูุน (ุงููุทุงุนู)</label><input type="number" id="prod-price"></div>
                    </div>
                    <div class="flex-row">
                        <div class="input-group"><label>ุงููููุฉ ุงููุชุงุญุฉ</label><input type="number" id="prod-stock" value="100"></div>
                        <div class="input-group"><label>ุงูุนูุงูุฉ</label>
                            <select id="prod-badge"><option value="ูุง ููุฌุฏ">ุจุฏูู ุนูุงูุฉ</option><option value="๐ฅ ุงูุฃูุซุฑ ูุจูุนุงู">๐ฅ ุงูุฃูุซุฑ ูุจูุนุงู</option><option value="โญ ุฌุฏูุฏ">โญ ุฌุฏูุฏ</option></select>
                        </div>
                    </div>
                    <div class="input-group"><label>ุงูุตูุฑุฉ ุงูุฑุฆูุณูุฉ</label><input type="file" id="prod-image" accept="image/*"></div>
                    <h4 style="color:var(--text-muted); border-bottom:1px solid #333; padding-bottom:5px;">ุฃุจุนุงุฏ ุฅุถุงููุฉ (ุงุฎุชูุงุฑู)</h4>
                    <div class="flex-row">
                        <div class="input-group"><label>ุงูุทูู</label><input type="text" id="prod-length" placeholder="ูุซุงู: 90 ุณู"></div>
                        <div class="input-group"><label>ุงูุนุฑุถ</label><input type="text" id="prod-width" placeholder="ูุซุงู: 10 ุณู"></div>
                        <div class="input-group"><label>ุงูุชุฎุงูุฉ</label><input type="text" id="prod-thickness" placeholder="ูุซุงู: 3 ุณู"></div>
                    </div>
                    <button class="btn-main" onclick="addProduct()">ุญูุธ ุงูููุชุฌ ูู ุงููุฎุฒู</button>
                </div>

                <div style="display:flex; flex-direction:column; gap:20px;">
                    <div class="panel">
                        <h3 class="panel-title"><i class="fas fa-folder-plus"></i> ุฅุถุงูุฉ ูุณู (ุณูุงูุฏุฑ)</h3>
                        <div class="input-group"><label>ุงุณู ุงููุณู</label><input type="text" id="cat-title"></div>
                        <div class="input-group"><label>ุตูุฑ ุงููุณู (ุญุฏุฏ ูุฐุง ุตูุฑุฉ)</label><input type="file" id="cat-images" multiple accept="image/*"></div>
                        <button class="btn-main" onclick="addCategory()">ุญูุธ ุงููุณู</button>
                    </div>
                    <div class="panel">
                        <h3 class="panel-title"><i class="fas fa-palette"></i> ุฑุจุท ููู ุจููุชุฌ</h3>
                        <div class="input-group"><label>ุงูููุชุฌ</label><select id="color-prod-id"></select></div>
                        <div class="flex-row">
                            <div class="input-group"><label>ุงุณู ุงูููู</label><input type="text" id="color-name"></div>
                            <div class="input-group"><label>ุงูููุฏ (Hex)</label><input type="color" id="color-hex" value="#ff0000" style="height:40px;"></div>
                        </div>
                        <div class="input-group"><label>ุตูุฑุฉ ุงูููุชุฌ ุจุงูููู ุฏู</label><input type="file" id="color-image" accept="image/*"></div>
                        <button class="btn-main" onclick="addColor()" style="background:#3742fa; color:#fff;">ุญูุธ ุงูููู</button>
                    </div>
                    <div class="panel">
                        <h3 class="panel-title"><i class="fas fa-ruler"></i> ุฅุถุงูุฉ ููุงุณ ูููุชุฌ</h3>
                        <div class="input-group"><label>ุงูููุชุฌ</label><select id="size-prod-id"></select></div>
                        <div class="input-group"><label>ุงูููุงุณ</label><input type="text" id="size-name" placeholder="S, M, L, XL, 42..."></div>
                        <button class="btn-main" onclick="addSize()" style="background:#2ed573; color:#000;">ุญูุธ ุงูููุงุณ</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="edit-inventory" class="section">
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-edit"></i> ุฅุฏุงุฑุฉ ุงููุฎุฒู ูุชุนุฏูู ุงูููุชุฌุงุช</h2>
                <div style="overflow-x:auto;">
                    <table>
                        <thead><tr><th>ุตูุฑุฉ</th><th>ุงูููุชุฌ</th><th>ุงููุณู</th><th>ุณุนุฑ ุงูุจูุน</th><th>ุงููุฎุฒูู</th><th>ุฅุฌุฑุงุกุงุช</th></tr></thead>
                        <tbody id="edit-products-table"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="shipping" class="section">
            <div class="panel" style="max-width: 500px; margin: auto;">
                <h2 class="panel-title"><i class="fas fa-truck"></i> ุชุนุฏูู ุฃุณุนุงุฑ ุงูุดุญู</h2>
                <div class="input-group"><label>ุงุฎุชุฑ ุงููุญุงูุธุฉ</label><select id="ship-city-select" onchange="loadSelectedCityPrice()"></select></div>
                <div class="input-group"><label>ุณุนุฑ ุงูุดุญู ุงูุญุงูู (ุฌ.ู)</label><input type="number" id="ship-city-price"></div>
                <button class="btn-main" onclick="updateCityPrice()" style="background: var(--info); color: #fff;">ุชุญุฏูุซ ุชุณุนูุฑุฉ ุงูุดุญู</button>
            </div>
        </section>

        <section id="discounts" class="section">
            <div class="panel" style="max-width: 500px; margin: auto;">
                <h2 class="panel-title"><i class="fas fa-ticket-alt"></i> ุฅุตุฏุงุฑ ููุฏ ุฎุตู</h2>
                <div class="input-group"><label>ุงูููุฏ</label><input type="text" id="promo-code" style="text-transform: uppercase;"></div>
                <div class="input-group"><label>ุงููุณุจุฉ ุงููุฆููุฉ ููุฎุตู (%)</label><input type="number" id="promo-percent"></div>
                <button class="btn-main" onclick="addPromo()">ุชูุนูู ุงูููุจูู ููุฑุงู</button>
            </div>
        </section>

    </main>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="document.getElementById('edit-modal').style.display='none'"><i class="fas fa-times"></i></button>
            <h2 class="panel-title"><i class="fas fa-edit"></i> ูุงุฑุช ุงูุตูู - ุชุนุฏูู ุจูุงูุงุช ุงูููุชุฌ</h2>
            <input type="hidden" id="edit-prod-id">
            
            <div class="input-group"><label>ุงุณู ุงูููุชุฌ</label><input type="text" id="edit-prod-title"></div>
            <div class="input-group"><label>ูุตู ุงูููุชุฌ</label><textarea id="edit-prod-desc" rows="3"></textarea></div>
            
            <div class="flex-row">
                <div class="input-group"><label>ุณุนุฑ ุงูุฌููุฉ (ุงูุชูููุฉ)</label><input type="number" id="edit-prod-cost"></div>
                <div class="input-group"><label>ุณุนุฑ ุงููุทุงุนู (ุงูุจูุน)</label><input type="number" id="edit-prod-price"></div>
            </div>
            
            <div class="flex-row">
                <div class="input-group"><label>ุงููููุฉ ุงููุชุงุญุฉ</label><input type="number" id="edit-prod-stock"></div>
                <div class="input-group"><label>ุงูุนูุงูุฉ ุงููููุฒุฉ</label>
                    <select id="edit-prod-badge">
                        <option value="ูุง ููุฌุฏ">ุจุฏูู ุนูุงูุฉ</option>
                        <option value="๐ฅ ุงูุฃูุซุฑ ูุจูุนุงู">๐ฅ ุงูุฃูุซุฑ ูุจูุนุงู</option>
                        <option value="โญ ุฌุฏูุฏ">โญ ุฌุฏูุฏ</option>
                    </select>
                </div>
            </div>

            <h4 style="color:var(--text-muted); border-bottom:1px solid #333; padding-bottom:5px;">ุงูุฃุจุนุงุฏ (ูู ุญุงุจุจ ุชุบูุฑูุง)</h4>
            <div class="flex-row">
                <div class="input-group"><label>ุงูุทูู</label><input type="text" id="edit-prod-length"></div>
                <div class="input-group"><label>ุงูุนุฑุถ</label><input type="text" id="edit-prod-width"></div>
                <div class="input-group"><label>ุงูุชุฎุงูุฉ</label><input type="text" id="edit-prod-thickness"></div>
            </div>

            <button class="btn-main" onclick="saveProductEdit()" style="margin-top:20px;">ุญูุธ ุงูุชุนุฏููุงุช</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://wkfiocqhkspsvqgyjpea.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_l2vgR8Xbt0Csw8W_Slo_1Q_9glKlIoN';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let citiesData = []; 
        let allProductsEdit = [];
        let allCategoriesEdit = [];

        function showLoader(text) { document.getElementById('loader-text').innerText = text; document.getElementById('loader').style.display = 'flex'; }
        function hideLoader() { document.getElementById('loader').style.display = 'none'; }

        function switchTab(tabId, btn) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');

            if(tabId === 'accounting') loadComprehensiveReports();
            if(tabId === 'orders') loadOrders();
            if(tabId === 'inventory') { loadCategories(); loadProductsList(); }
            if(tabId === 'edit-inventory') loadEditInventory(); // ุชุจููุจุฉ ุงูุชุนุฏูู
            if(tabId === 'shipping') loadCitiesForDropdown();
        }

        async function uploadImage(file) {
            const fileExt = file.name.split('.').pop();
            const fileName = `${Math.random().toString(36).substring(2, 15)}_${Date.now()}.${fileExt}`;
            const { error } = await supabaseClient.storage.from('okaz_images').upload(fileName, file);
            if (error) throw error;
            return supabaseClient.storage.from('okaz_images').getPublicUrl(fileName).data.publicUrl;
        }

        // ================= ูุณู ุงูุชุนุฏูู ููุฑูุช ุงูุตูู =================
        async function loadEditInventory() {
            showLoader("ุฌุงุฑู ุณุญุจ ุงูููุชุฌุงุช...");
            const [prodsReq, catsReq] = await Promise.all([
                supabaseClient.from('products').select('*').order('created_at', { ascending: false }),
                supabaseClient.from('categories').select('id, title')
            ]);
            
            allProductsEdit = prodsReq.data || [];
            allCategoriesEdit = catsReq.data || [];
            
            const tbody = document.getElementById('edit-products-table');
            tbody.innerHTML = '';
            
            allProductsEdit.forEach(p => {
                const catName = allCategoriesEdit.find(c => c.id === p.category_id)?.title || 'ุบูุฑ ูุญุฏุฏ';
                tbody.innerHTML += `
                    <tr>
                        <td><img src="${p.image}" style="width:50px; height:50px; border-radius:8px; object-fit:cover;"></td>
                        <td style="font-weight:bold;">${p.title}</td>
                        <td style="color:#aaa;">${catName}</td>
                        <td style="color:var(--primary); font-weight:bold;">${p.price} ุฌ.ู</td>
                        <td>${p.stock_quantity}</td>
                        <td>
                            <button class="btn-sm btn-edit" onclick="openEditModal('${p.id}')"><i class="fas fa-edit"></i> ุชุนุฏูู</button>
                            <button class="btn-sm btn-delete" onclick="deleteProduct('${p.id}')"><i class="fas fa-trash"></i> ุญุฐู</button>
                        </td>
                    </tr>
                `;
            });
            hideLoader();
        }

        function openEditModal(id) {
            const p = allProductsEdit.find(x => x.id === id);
            if(!p) return;
            
            document.getElementById('edit-prod-id').value = p.id;
            document.getElementById('edit-prod-title').value = p.title;
            document.getElementById('edit-prod-desc').value = p.description || '';
            document.getElementById('edit-prod-cost').value = p.cost_price;
            document.getElementById('edit-prod-price').value = p.price;
            document.getElementById('edit-prod-stock').value = p.stock_quantity;
            document.getElementById('edit-prod-badge').value = p.badge || 'ูุง ููุฌุฏ';
            document.getElementById('edit-prod-length').value = p.length_val || '';
            document.getElementById('edit-prod-width').value = p.width_val || '';
            document.getElementById('edit-prod-thickness').value = p.thickness_val || '';

            document.getElementById('edit-modal').style.display = 'block';
        }

        async function saveProductEdit() {
            const id = document.getElementById('edit-prod-id').value;
            const updates = {
                title: document.getElementById('edit-prod-title').value,
                description: document.getElementById('edit-prod-desc').value,
                cost_price: document.getElementById('edit-prod-cost').value,
                price: document.getElementById('edit-prod-price').value,
                stock_quantity: document.getElementById('edit-prod-stock').value,
                badge: document.getElementById('edit-prod-badge').value,
                length_val: document.getElementById('edit-prod-length').value,
                width_val: document.getElementById('edit-prod-width').value,
                thickness_val: document.getElementById('edit-prod-thickness').value
            };

            showLoader("ุฌุงุฑู ุงูุญูุธ...");
            const { error } = await supabaseClient.from('products').update(updates).eq('id', id);
            if(error) alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุญุฏูุซ!");
            else {
                alert("ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงูููุชุฌ ุจูุฌุงุญ โ");
                document.getElementById('edit-modal').style.display = 'none';
                loadEditInventory(); // ุฑููุฑูุด ุงูุฌุฏูู
            }
            hideLoader();
        }

        async function deleteProduct(id) {
            if(confirm("ุชุญุฐูุฑ: ูุชุฃูุฏ ุฅูู ุนุงูุฒ ุชุญุฐู ุงูููุชุฌ ุฏู ููุงุฆูุงูุ")) {
                showLoader("ุฌุงุฑู ุงูุญุฐู...");
                await supabaseClient.from('products').delete().eq('id', id);
                alert("ุชู ุงูุญุฐู!");
                loadEditInventory();
                hideLoader();
            }
        }

        // ================= ุงูุชูุงุฑูุฑ ุงูุดุงููุฉ =================
        async function loadComprehensiveReports() {
            const { data: orders } = await supabaseClient.from('orders').select('grand_total, status, discount_amount');
            let safe = 0, courier = 0, pending = 0, discounts = 0;
            if(orders) {
                orders.forEach(o => {
                    if(o.status === 'ุชู ุงูุชูุตูู') safe += Number(o.grand_total);
                    else if(o.status === 'ูุน ุงูููุฏูุจ') courier += Number(o.grand_total);
                    else if(o.status !== 'ููุบู' && o.status !== 'ูุฑุชุฌุน') pending += Number(o.grand_total);
                    discounts += Number(o.discount_amount || 0);
                });
            }
            document.getElementById('acc-safe').innerText = safe.toFixed(2) + ' ุฌ.ู';
            document.getElementById('acc-courier').innerText = courier.toFixed(2) + ' ุฌ.ู';
            document.getElementById('acc-pending').innerText = pending.toFixed(2) + ' ุฌ.ู';
            document.getElementById('acc-discounts').innerText = discounts.toFixed(2) + ' ุฌ.ู';

            const { data: products } = await supabaseClient.from('products').select('price, cost_price, stock_quantity');
            let invCost = 0, invRetail = 0;
            if(products) {
                products.forEach(p => {
                    invCost += Number(p.cost_price || 0) * Number(p.stock_quantity || 0);
                    invRetail += Number(p.price || 0) * Number(p.stock_quantity || 0);
                });
            }
            document.getElementById('inv-cost').innerText = invCost.toFixed(2) + ' ุฌ.ู';
            document.getElementById('inv-retail').innerText = invRetail.toFixed(2) + ' ุฌ.ู';
            document.getElementById('inv-profit').innerText = (invRetail - invCost).toFixed(2) + ' ุฌ.ู';
        }

        // ================= ุงูุทูุจุงุช ูุงููุฎุฒู (ุฒู ูุง ููุง ุดุบุงููู ุทููุฉ) =================
        async function loadOrders() {
            const { data } = await supabaseClient.from('orders').select('*, order_items(*)').order('created_at', { ascending: false });
            const tbody = document.getElementById('orders-table'); tbody.innerHTML = '';
            data.forEach(o => {
                const shortId = o.id.split('-')[0].toUpperCase();
                let itemsHtml = o.order_items.map(i => `<div style="font-size:0.85em; color:#bbb;">- ${i.product_name} (${i.selected_color} | ${i.selected_size}) <b style="color:#fff">x${i.quantity}</b></div>`).join('');
                const statuses = ['ููุฏ ุงููุฑุงุฌุนุฉ', 'ุฌุงุฑู ุงูุชุฌููุฒ', 'ูุน ุงูููุฏูุจ', 'ุชู ุงูุชูุตูู', 'ููุบู', 'ูุฑุชุฌุน'];
                let selectHtml = `<select class="status-select" onchange="updateOrderStatus('${o.id}', this.value)">`;
                statuses.forEach(s => { selectHtml += `<option value="${s}" ${o.status === s ? 'selected' : ''}>${s}</option>`; });
                selectHtml += `</select>`;
                tbody.innerHTML += `<tr><td style="color:var(--primary); font-weight:bold;">#OKZ-${shortId}</td><td style="font-weight:bold;">${o.customer_name}<br><span style="font-size:0.8em; color:#888;">${o.customer_city}</span></td><td>${o.customer_phone}</td><td>${itemsHtml}</td><td style="color:var(--success); font-weight:bold;">${o.grand_total} ุฌ.ู</td><td>${selectHtml}</td></tr>`;
            });
        }
        async function updateOrderStatus(orderId, newStatus) { await supabaseClient.from('orders').update({ status: newStatus }).eq('id', orderId); loadComprehensiveReports(); }

        // ุงููุฎุฒู
        async function loadCategories() { const { data } = await supabaseClient.from('categories').select('*'); const sel = document.getElementById('prod-cat'); sel.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงููุณู --</option>'; data.forEach(c => sel.innerHTML += `<option value="${c.id}">${c.title}</option>`); }
        async function loadProductsList() { const { data } = await supabaseClient.from('products').select('*'); let options = '<option value="">-- ุงุฎุชุฑ ุงูููุชุฌ --</option>'; data.forEach(p => options += `<option value="${p.id}">${p.title}</option>`); document.getElementById('color-prod-id').innerHTML = options; document.getElementById('size-prod-id').innerHTML = options; }
        async function addCategory() { const title = document.getElementById('cat-title').value; const fileInput = document.getElementById('cat-images'); if(!title || fileInput.files.length === 0) return alert("ุงูุชุจ ุงุณู ุงููุณู ูุงุฎุชุงุฑ ุตูุฑุฉ!"); showLoader("ุฌุงุฑู ุงูุฑูุน..."); try { let urls = []; for(let i=0; i<fileInput.files.length; i++) urls.push(await uploadImage(fileInput.files[i])); await supabaseClient.from('categories').insert([{ title, image: urls[0], gallery: urls }]); alert("ุชู ุฅุถุงูุฉ ุงููุณู โ"); document.getElementById('cat-title').value=''; fileInput.value=''; loadCategories(); } catch(e) { alert("ุญุฏุซ ุฎุทุฃ"); } hideLoader(); }
        async function addProduct() {
            const category_id = document.getElementById('prod-cat').value, title = document.getElementById('prod-title').value, price = document.getElementById('prod-price').value, cost_price = document.getElementById('prod-cost-price').value || 0, stock_quantity = document.getElementById('prod-stock').value || 100, badge = document.getElementById('prod-badge').value, length_val = document.getElementById('prod-length').value, width_val = document.getElementById('prod-width').value, thickness_val = document.getElementById('prod-thickness').value, fileInput = document.getElementById('prod-image');
            if(!category_id || !title || !price || fileInput.files.length === 0) return alert("ููู ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ ูุงูุตูุฑุฉ!");
            showLoader("ุฌุงุฑู ุฑูุน ุงูููุชุฌ...");
            try { const imgUrl = await uploadImage(fileInput.files[0]); await supabaseClient.from('products').insert([{ category_id, title, price, cost_price, stock_quantity, image: imgUrl, badge, length_val, width_val, thickness_val }]); alert("ุชู ุฅุถุงูุฉ ุงูููุชุฌ โ"); document.getElementById('prod-title').value=''; document.getElementById('prod-price').value=''; document.getElementById('prod-cost-price').value=''; fileInput.value=''; loadProductsList(); loadComprehensiveReports(); } catch(e) { alert("ุญุฏุซ ุฎุทุฃ"); } hideLoader();
        }
        async function addColor() { const product_id = document.getElementById('color-prod-id').value, color_name = document.getElementById('color-name').value, color_hex = document.getElementById('color-hex').value, fileInput = document.getElementById('color-image'); if(!product_id || !color_name || fileInput.files.length === 0) return alert("ููู ุงูุจูุงูุงุช ูููู!"); showLoader("ุฌุงุฑู ุงูุฑูุน..."); try { const imgUrl = await uploadImage(fileInput.files[0]); await supabaseClient.from('product_colors').insert([{ product_id, color_name, color_hex, image_url: imgUrl }]); alert("ุชู ุฑุจุท ุงูููู โ"); document.getElementById('color-name').value=''; fileInput.value=''; } catch(e) { alert("ุญุฏุซ ุฎุทุฃ"); } hideLoader(); }
        async function addSize() { const product_id = document.getElementById('size-prod-id').value, size_name = document.getElementById('size-name').value; if(!product_id || !size_name) return alert("ููู ุจูุงูุงุช ุงูููุงุณ!"); await supabaseClient.from('product_sizes').insert([{ product_id, size_name }]); alert("ุชู ุญูุธ ุงูููุงุณ โ"); document.getElementById('size-name').value=''; }

        // ุงูุดุญู ูุงูููุจููุงุช
        async function loadCitiesForDropdown() { const { data } = await supabaseClient.from('shipping_rules').select('*').order('city'); citiesData = data || []; const sel = document.getElementById('ship-city-select'); sel.innerHTML = '<option value="">-- ุงุฎุชุฑ ูุญุงูุธุฉ ููุชุนุฏูู --</option>'; citiesData.forEach(c => sel.innerHTML += `<option value="${c.id}">${c.city}</option>`); }
        function loadSelectedCityPrice() { const id = document.getElementById('ship-city-select').value; const city = citiesData.find(c => c.id === id); if(city) document.getElementById('ship-city-price').value = city.cost; else document.getElementById('ship-city-price').value = ''; }
        async function updateCityPrice() { const id = document.getElementById('ship-city-select').value, newPrice = document.getElementById('ship-city-price').value; if(!id || !newPrice) return alert("ุงุฎุชุฑ ูุญุงูุธุฉ ูุงูุชุจ ุงูุณุนุฑ"); showLoader("ุฌุงุฑู ุงูุญูุธ..."); await supabaseClient.from('shipping_rules').update({ cost: newPrice }).eq('id', id); alert("ุชู ุงูุชุนุฏูู ๐"); hideLoader(); }
        async function addPromo() { const code = document.getElementById('promo-code').value.toUpperCase(), percent = document.getElementById('promo-percent').value; const { error } = await supabaseClient.from('promo_codes').insert([{ code, discount_percentage: percent }]); if(error) alert("ุงูููุฏ ุฏู ููุฌูุฏ ูุจู ูุฏู ุฃู ูู ุฎุทุฃ!"); else alert("ุชู ุชูุนูู ุงูููุจูู ๐ธ"); }

        loadComprehensiveReports();
    </script>
</body>
</html>
