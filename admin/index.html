<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø³ÙˆÙ‚ Ø¹ÙƒØ§Ø² | Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #e67e22; --dark: #0a0a0a; --sidebar: #121212; --card: #1a1a1a; --text: #f1f2f6; --text-muted: #a4b0be; --danger: #ff4757; --success: #2ed573; --info: #3742fa; }
        body { font-family: 'Cairo', sans-serif; background: var(--dark); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        .sidebar { width: 260px; background: var(--sidebar); border-left: 1px solid #222; display: flex; flex-direction: column; padding: 20px 0; box-shadow: -5px 0 15px rgba(0,0,0,0.5); z-index: 100; }
        .logo-area { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #222; }
        .logo-area h2 { color: var(--primary); margin: 0; font-weight: 900; }
        .nav-btn { display: flex; align-items: center; gap: 15px; padding: 15px 25px; color: var(--text-muted); text-decoration: none; cursor: pointer; transition: 0.3s; border-right: 4px solid transparent; font-size: 1.1em; font-weight: 600; background: none; border: none; width: 100%; text-align: right; }
        .nav-btn:hover, .nav-btn.active { background: #1f1f1f; color: var(--primary); border-right-color: var(--primary); }
        .nav-btn i { font-size: 1.2em; width: 25px; text-align: center; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; background: var(--dark); }
        .section { display: none; animation: fadeIn 0.4s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ÙƒØ±ÙˆØª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª) */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card); padding: 25px; border-radius: 15px; border: 1px solid #222; display: flex; align-items: center; gap: 20px; position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; left: 0; top: 0; height: 100%; width: 4px; background: var(--primary); }
        .stat-card.success::before { background: var(--success); }
        .stat-card.danger::before { background: var(--danger); }
        .stat-card.info::before { background: var(--info); }
        .stat-icon { font-size: 2.5em; color: rgba(255, 255, 255, 0.1); }
        .stat-info h3 { margin: 0; font-size: 0.9em; color: var(--text-muted); font-weight: 600; }
        .stat-info p { margin: 5px 0 0; font-size: 1.8em; font-weight: 900; color: #fff; }

        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„ÙÙˆØ±Ù… */
        .panel { background: var(--card); padding: 25px; border-radius: 15px; border: 1px solid #222; margin-bottom: 20px; }
        .panel-title { color: var(--primary); margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 20px; font-size: 1.2em; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #111; color: var(--text-muted); padding: 15px; text-align: right; font-weight: 600; border-bottom: 2px solid #222; }
        td { padding: 15px; border-bottom: 1px solid #222; color: #eee; }
        tr:hover td { background: #222; }
        
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 8px; color: var(--text-muted); font-size: 0.9em; }
        input, select { width: 100%; padding: 12px 15px; border-radius: 8px; border: 1px solid #333; background: #111; color: #fff; font-family: 'Cairo'; outline: none; }
        input:focus, select:focus { border-color: var(--primary); }
        
        .btn-main { background: var(--primary); color: #000; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: 800; font-family: 'Cairo'; transition: 0.3s; width: 100%; }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(230,126,34,0.3); }
        
        .flex-row { display: flex; gap: 15px; flex-wrap: wrap; }
        .flex-row > div { flex: 1; min-width: 250px; }
        
        /* Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ù„ÙˆÙ† */
        .color-circle { width: 25px; height: 25px; border-radius: 50%; display: inline-block; vertical-align: middle; border: 2px solid #fff; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="logo-area">
            <h2>Ø³ÙˆÙ‚ Ø¹ÙƒØ§Ø² ğŸ¦…</h2>
            <span style="color:var(--text-muted); font-size:0.8em;">Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (ERP)</span>
        </div>
        <button class="nav-btn active" onclick="switchTab('accounting', this)"><i class="fas fa-file-invoice-dollar"></i> Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„Ù…Ø§Ù„ÙŠØ©</button>
        <button class="nav-btn" onclick="switchTab('orders', this)"><i class="fas fa-box-open"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
        <button class="nav-btn" onclick="switchTab('inventory', this)"><i class="fas fa-warehouse"></i> Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</button>
        <button class="nav-btn" onclick="switchTab('discounts', this)"><i class="fas fa-tags"></i> Ù†Ø¸Ø§Ù… Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª</button>
    </aside>

    <main class="main-content">
        
        <section id="accounting" class="section active">
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-calculator"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ© (ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª)</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <i class="fas fa-money-bill-wave stat-icon"></i>
                        <div class="stat-info"><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®Ø²ÙŠÙ†Ø© (Ø´Ø§Ù…Ù„ Ø§Ù„Ø´Ø­Ù†)</h3><p id="acc-grand-total">0 Ø¬.Ù…</p></div>
                    </div>
                    <div class="stat-card danger">
                        <i class="fas fa-hand-holding-usd stat-icon"></i>
                        <div class="stat-info"><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª (Ø®Ø³Ø§Ø±Ø©)</h3><p id="acc-discounts">0 Ø¬.Ù…</p></div>
                    </div>
                    <div class="stat-card info">
                        <i class="fas fa-truck stat-icon"></i>
                        <div class="stat-info"><h3>ØªÙƒÙ„ÙØ© Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ù…Ø­ØµÙ„Ø©</h3><p id="acc-shipping">0 Ø¬.Ù…</p></div>
                    </div>
                    <div class="stat-card success">
                        <i class="fas fa-coins stat-icon"></i>
                        <div class="stat-info"><h3>ØµØ§ÙÙŠ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3><p id="acc-net-sales">0 Ø¬.Ù…</p></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="orders" class="section">
            <div class="panel">
                <h2 class="panel-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</th><th>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</th><th>Ø§Ù„Ø®ØµÙ…</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr>
                        </thead>
                        <tbody id="orders-table"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="inventory" class="section">
            
            <div class="flex-row">
                <div class="panel">
                    <h3 class="panel-title"><i class="fas fa-folder-plus"></i> 1. Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…</h3>
                    <div class="input-group"><label>Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…</label><input type="text" id="cat-title" placeholder="Ù…Ù„Ø§Ø¨Ø³ØŒ Ø¹ÙƒØ§ÙƒÙŠØ²..."></div>
                    <div class="input-group"><label>ØµÙˆØ±Ø© Ø§Ù„Ù‚Ø³Ù…</label><input type="text" id="cat-img" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©"></div>
                    <button class="btn-main" onclick="addCategory()">Ø­ÙØ¸ Ø§Ù„Ù‚Ø³Ù…</button>
                </div>

                <div class="panel">
                    <h3 class="panel-title"><i class="fas fa-box-plus"></i> 2. Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø£Ø³Ø§Ø³ÙŠ</h3>
                    <div class="input-group"><label>Ø§Ù„Ù‚Ø³Ù…</label><select id="prod-cat"></select></div>
                    <div class="input-group"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label><input type="text" id="prod-title" placeholder="ØªÙŠØ´ÙŠØ±Øª Ø¨ÙˆÙ„Ùˆ..."></div>
                    <div class="flex-row">
                        <div class="input-group"><label>Ø§Ù„Ø³Ø¹Ø±</label><input type="number" id="prod-price" placeholder="0"></div>
                        <div class="input-group"><label>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©</label><input type="number" id="prod-stock" value="100"></div>
                    </div>
                    <div class="input-group"><label>Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</label><input type="text" id="prod-img" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©"></div>
                    <button class="btn-main" onclick="addProduct()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬</button>
                </div>
            </div>

            <div class="flex-row">
                <div class="panel">
                    <h3 class="panel-title"><i class="fas fa-palette"></i> 3. Ø¥Ø¶Ø§ÙØ© Ù„ÙˆÙ† Ù„Ù…Ù†ØªØ¬ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</h3>
                    <div class="input-group"><label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬</label><select id="color-prod-id"></select></div>
                    <div class="input-group"><label>Ø§Ø³Ù… Ø§Ù„Ù„ÙˆÙ†</label><input type="text" id="color-name" placeholder="Ø£Ø­Ù…Ø±ØŒ Ø£Ø³ÙˆØ¯ Ù…Ù„ÙƒÙŠ..."></div>
                    <div class="input-group"><label>ÙƒÙˆØ¯ Ø§Ù„Ù„ÙˆÙ† (Hex)</label><input type="color" id="color-hex" value="#ff0000" style="height:45px; padding:0;"></div>
                    <div class="input-group"><label>ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ù„Ù„ÙˆÙ† Ø¯Ù‡</label><input type="text" id="color-img" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ù„ÙˆÙ† Ø¯Ù‡"></div>
                    <button class="btn-main" onclick="addColor()" style="background:var(--info); color:#fff;">Ø­ÙØ¸ Ø§Ù„Ù„ÙˆÙ†</button>
                </div>

                <div class="panel">
                    <h3 class="panel-title"><i class="fas fa-ruler"></i> 4. Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø§Ø³ Ù„Ù…Ù†ØªØ¬ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</h3>
                    <div class="input-group"><label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬</label><select id="size-prod-id"></select></div>
                    <div class="input-group"><label>Ø§Ù„Ù…Ù‚Ø§Ø³</label><input type="text" id="size-name" placeholder="S, M, L, XL, 42..."></div>
                    <button class="btn-main" onclick="addSize()" style="background:var(--success); color:#fff; margin-top: 15px;">Ø­ÙØ¸ Ø§Ù„Ù…Ù‚Ø§Ø³</button>
                </div>
            </div>
        </section>

        <section id="discounts" class="section">
            <div class="panel" style="max-width: 500px; margin: auto;">
                <h2 class="panel-title"><i class="fas fa-ticket-alt"></i> Ø¥ØµØ¯Ø§Ø± ÙƒÙˆØ¯ Ø®ØµÙ…</h2>
                <div class="input-group"><label>Ø§Ù„ÙƒÙˆØ¯ (Ù…Ø«Ø§Ù„: KHALED20)</label><input type="text" id="promo-code" style="text-transform: uppercase;"></div>
                <div class="input-group"><label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… (%)</label><input type="number" id="promo-percent" placeholder="20"></div>
                <button class="btn-main" onclick="addPromo()">ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†</button>
            </div>
        </section>

    </main>

    <script>
        const SUPABASE_URL = 'https://wkfiocqhkspsvqgyjpea.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_l2vgR8Xbt0Csw8W_Slo_1Q_9glKlIoN';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        function switchTab(tabId, btn) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');

            if(tabId === 'accounting') loadAccounting();
            if(tabId === 'orders') loadOrders();
            if(tabId === 'inventory') { loadCategories(); loadProductsList(); }
        }

        // ================= Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª (Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª) =================
        async function loadAccounting() {
            const { data: orders } = await supabaseClient.from('orders').select('grand_total, shipping_cost, discount_amount, total_items_price');
            
            let totalKhazna = 0;   // Ø§Ù„Ø®Ø²ÙŠÙ†Ø© = Ø¬Ø±Ø§Ù†Ø¯ ØªÙˆØªØ§Ù„
            let totalShipping = 0; // Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ø­Ù†
            let totalDiscount = 0; // Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ù„ÙŠ Ø·Ù„Ø¹Ù†Ø§Ù‡Ø§
            let totalNetSales = 0; // ØµØ§ÙÙŠ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø³ (ØªÙˆØªØ§Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª - Ø§Ù„Ø®ØµÙ…)

            if(orders) {
                orders.forEach(o => {
                    totalKhazna += Number(o.grand_total);
                    totalShipping += Number(o.shipping_cost);
                    totalDiscount += Number(o.discount_amount);
                    totalNetSales += Number(o.total_items_price) - Number(o.discount_amount);
                });
            }

            document.getElementById('acc-grand-total').innerText = totalKhazna.toFixed(2) + ' Ø¬.Ù…';
            document.getElementById('acc-shipping').innerText = totalShipping.toFixed(2) + ' Ø¬.Ù…';
            document.getElementById('acc-discounts').innerText = totalDiscount.toFixed(2) + ' Ø¬.Ù…';
            document.getElementById('acc-net-sales').innerText = totalNetSales.toFixed(2) + ' Ø¬.Ù…';
        }

        // ================= Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª =================
        async function loadOrders() {
            const { data } = await supabaseClient.from('orders').select('*, order_items(*)').order('created_at', { ascending: false });
            const tbody = document.getElementById('orders-table');
            tbody.innerHTML = '';
            
            data.forEach(o => {
                const date = new Date(o.created_at).toLocaleDateString('ar-EG');
                let itemsHtml = o.order_items.map(i => `<div style="font-size:0.85em; color:#bbb;">- ${i.product_name} (Ù„ÙˆÙ†: ${i.selected_color}) (Ù…Ù‚Ø§Ø³: ${i.selected_size}) x${i.quantity}</div>`).join('');
                
                tbody.innerHTML += `
                    <tr>
                        <td style="color:#888; font-size:0.9em;">${date}</td>
                        <td style="font-weight:bold;">${o.customer_name}</td>
                        <td>${o.customer_phone}</td>
                        <td>${itemsHtml}</td>
                        <td style="color:var(--danger)">${o.discount_amount > 0 ? o.discount_amount + ' Ø¬.Ù…' : 'Ø¨Ø¯ÙˆÙ†'}</td>
                        <td style="color:var(--primary); font-weight:bold;">${o.grand_total} Ø¬.Ù…</td>
                        <td><span style="background:#333; padding:5px 10px; border-radius:15px; font-size:0.8em;">${o.status}</span></td>
                    </tr>
                `;
            });
        }

        // ================= Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„Ù…ØªÙ‚Ø¯Ù… =================
        async function loadCategories() {
            const { data } = await supabaseClient.from('categories').select('*');
            const sel = document.getElementById('prod-cat');
            sel.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… --</option>';
            data.forEach(c => sel.innerHTML += `<option value="${c.id}">${c.title}</option>`);
        }

        async function loadProductsList() {
            const { data } = await supabaseClient.from('products').select('*');
            const selColor = document.getElementById('color-prod-id');
            const selSize = document.getElementById('size-prod-id');
            let options = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬ --</option>';
            data.forEach(p => options += `<option value="${p.id}">${p.title}</option>`);
            selColor.innerHTML = options;
            selSize.innerHTML = options;
        }

        async function addCategory() {
            const title = document.getElementById('cat-title').value, image = document.getElementById('cat-img').value;
            await supabaseClient.from('categories').insert([{ title, image }]);
            alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù… âœ…"); loadCategories();
        }

        async function addProduct() {
            const category_id = document.getElementById('prod-cat').value, title = document.getElementById('prod-title').value, price = document.getElementById('prod-price').value, image = document.getElementById('prod-img').value, stock = document.getElementById('prod-stock').value;
            await supabaseClient.from('products').insert([{ category_id, title, price, image, stock_quantity: stock }]);
            alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ âœ…"); loadProductsList();
        }

        async function addColor() {
            const product_id = document.getElementById('color-prod-id').value, color_name = document.getElementById('color-name').value, color_hex = document.getElementById('color-hex').value, image_url = document.getElementById('color-img').value;
            await supabaseClient.from('product_colors').insert([{ product_id, color_name, color_hex, image_url }]);
            alert("ØªÙ… Ø±Ø¨Ø· Ø§Ù„Ù„ÙˆÙ† Ø¨Ø§Ù„Ù…Ù†ØªØ¬ âœ…");
        }

        async function addSize() {
            const product_id = document.getElementById('size-prod-id').value, size_name = document.getElementById('size-name').value;
            await supabaseClient.from('product_sizes').insert([{ product_id, size_name }]);
            alert("ØªÙ… Ø±Ø¨Ø· Ø§Ù„Ù…Ù‚Ø§Ø³ Ø¨Ø§Ù„Ù…Ù†ØªØ¬ âœ…");
        }

        // ================= Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª =================
        async function addPromo() {
            const code = document.getElementById('promo-code').value.toUpperCase(), percent = document.getElementById('promo-percent').value;
            const { error } = await supabaseClient.from('promo_codes').insert([{ code, discount_percentage: percent }]);
            if(error) alert("Ø®Ø·Ø£! Ù…Ù…ÙƒÙ† Ø§Ù„ÙƒÙˆØ¯ Ø¯Ù‡ Ù…ÙˆØ¬ÙˆØ¯ Ù‚Ø¨Ù„ ÙƒØ¯Ù‡."); else alert("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† ğŸ’¸");
        }

        // Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ
        loadAccounting();
    </script>
</body>
</html>
