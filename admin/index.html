<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÙˆÙ‚ Ø¹ÙƒØ§Ø² | Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© ÙˆØ§Ù„Ù…Ø§Ù„ÙŠØ§Øª</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800;900&family=Reem+Kufi:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #e67e22; --dark: #0a0a0a; --sidebar: #121212; --card: #1a1a1a; --text: #f1f2f6; --text-muted: #a4b0be; --danger: #ff4757; --success: #2ed573; --info: #3742fa; --warning: #ffa502; }
        body { font-family: 'Cairo', sans-serif; background: var(--dark); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ÙˆØ§Ù„ØªØ¬Ø§ÙˆØ¨ Ù…Ø¹ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        .sidebar { width: 260px; background: var(--sidebar); border-left: 1px solid #222; display: flex; flex-direction: column; padding: 20px 0; box-shadow: -5px 0 15px rgba(0,0,0,0.5); z-index: 1000; overflow-y:auto; transition: right 0.3s ease; }
        .logo-area { text-align: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #222; }
        .logo-area h2 { color: var(--primary); margin: 0; font-family: 'Reem Kufi', sans-serif; font-size: 1.8em;}
        .nav-btn { display: flex; align-items: center; gap: 15px; padding: 15px 25px; color: var(--text-muted); cursor: pointer; transition: 0.3s; border-right: 4px solid transparent; font-size: 1.1em; font-weight: 600; background: none; border: none; width: 100%; text-align: right; }
        .nav-btn:hover, .nav-btn.active { background: #1f1f1f; color: var(--primary); border-right-color: var(--primary); }
        .nav-btn i { font-size: 1.2em; width: 25px; text-align: center; }

        .main-content { flex: 1; padding: 30px; overflow-y: auto; background: var(--dark); position: relative; }
        .section { display: none; animation: fadeIn 0.4s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Ù‡ÙŠØ¯Ø± Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©) */
        .mobile-header { display: none; background: #111; padding: 15px 20px; border-bottom: 2px solid var(--primary); align-items: center; justify-content: space-between; margin: -30px -30px 20px -30px; position: sticky; top: 0; z-index: 99; }
        .mobile-menu-btn { background: none; border: none; color: var(--primary); font-size: 1.6em; cursor: pointer; }
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 999; display: none; backdrop-filter: blur(3px); }
        .sidebar-overlay.active { display: block; }

        @media (max-width: 900px) {
            .sidebar { position: fixed; right: -260px; height: 100vh; }
            .sidebar.active { right: 0; }
            .mobile-header { display: flex; }
            .main-content { padding: 15px; padding-top: 30px; }
            .flex-row > div { min-width: 100%; } /* Ø§Ù„ÙƒØ±ÙˆØª ØªØ§Ø®Ø¯ Ø§Ù„Ø¹Ø±Ø¶ ÙƒÙ„Ù‡ ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
            .stats-grid { grid-template-columns: 1fr; }
        }

        /* Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø¢Ù„Ø© Ø§Ù„Ø­Ø§Ø³Ø¨Ø© */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { padding: 25px; border-radius: 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: 0.3s; cursor: pointer; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.5); border-width: 2px; }
        .stat-card.success { background: linear-gradient(135deg, rgba(46, 213, 115, 0.15), rgba(0,0,0,0.8)); border: 1px solid var(--success); }
        .stat-card.info { background: linear-gradient(135deg, rgba(55, 66, 250, 0.15), rgba(0,0,0,0.8)); border: 1px solid var(--info); }
        .stat-card.warning { background: linear-gradient(135deg, rgba(255, 165, 2, 0.15), rgba(0,0,0,0.8)); border: 1px solid var(--warning); }
        .stat-card.danger { background: linear-gradient(135deg, rgba(255, 71, 87, 0.15), rgba(0,0,0,0.8)); border: 1px solid var(--danger); }
        .stat-info h3 { margin: 0; font-size: 1em; color: #ccc; pointer-events: none; }
        .stat-info p { margin: 5px 0 0; font-size: 1.8em; font-weight: 900; color: #fff; pointer-events: none; }
        .stat-icon { font-size: 3.5em; opacity: 0.8; pointer-events: none; }
        .stat-card.success .stat-icon { color: var(--success); } .stat-card.info .stat-icon { color: var(--info); } .stat-card.warning .stat-icon { color: var(--warning); } .stat-card.danger .stat-icon { color: var(--danger); }

        .panel { background: var(--card); padding: 25px; border-radius: 15px; border: 1px solid #222; margin-bottom: 20px; }
        .panel-title { color: var(--primary); margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 20px; font-size: 1.2em; display: flex; align-items:center; gap:10px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        th { background: #111; color: var(--text-muted); padding: 15px; text-align: right; border-bottom: 2px solid #222; font-weight: bold;}
        td { padding: 15px; border-bottom: 1px solid #222; color: #eee; }
        tr:hover td { background: #1a1a1a; }
        
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 6px; color: var(--text-muted); font-size: 0.85em; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #333; background: #111; color: #fff; font-family: 'Cairo'; outline: none; box-sizing: border-box;}
        input[type="file"] { padding: 6px; background: #222; cursor: pointer; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); }
        .checkbox-label { display: flex; align-items: center; gap: 10px; cursor: pointer; color: #fff; font-size: 0.9em; margin-bottom: 10px; }
        .checkbox-label input { width: auto; transform: scale(1.2); cursor: pointer;}
        
        .btn-main { background: var(--primary); color: #000; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 800; font-family: 'Cairo'; width: 100%; transition: 0.3s; }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(230,126,34,0.3); }
        .btn-sm { padding: 5px 10px; border-radius: 5px; cursor: pointer; border: none; font-family: 'Cairo'; font-weight: bold; font-size:0.8em; }
        .btn-edit { background: var(--info); color: #fff; } .btn-delete { background: var(--danger); color: #fff; }
        
        .flex-row { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;}
        .flex-row > div { flex: 1; min-width: 200px; }
        
        #loader { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; color: var(--primary); }
        .spinner { border: 5px solid #222; border-top: 5px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .status-select { background: #333; border: 1px solid #555; color: #fff; padding: 5px; border-radius: 5px; font-family: 'Cairo'; width: auto; font-weight:bold; cursor:pointer;}
        
        .size-checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-top: 10px; }
        .size-box { background: #222; border: 1px solid #444; border-radius: 8px; padding: 10px; text-align: center; cursor: pointer; transition: 0.3s; color: #fff; font-weight: bold; user-select: none; }
        .size-box.selected { background: var(--primary); color: #000; border-color: var(--primary); }
        .size-box input { display: none; }

        .switch-container { display: flex; justify-content: space-between; align-items: center; background: #111; padding: 15px; border-radius: 8px; border: 1px solid #333; margin-bottom: 15px; }
        .switch-container span { font-weight: bold; color: #fff; font-size: 0.9em;}
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #444; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(24px); }

        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .calc-btn { background: #222; color: #fff; border: 1px solid #333; padding: 15px; border-radius: 8px; font-size: 1.2em; cursor: pointer; transition: 0.2s; font-family: 'Cairo'; font-weight:bold;}
        .calc-btn:hover { background: var(--primary); color: #000; }
        .calc-btn.op { background: #333; color: var(--primary); }
        .calc-btn.eq { background: var(--success); color: #000; grid-column: span 2; }
        .calc-btn.clear { background: var(--danger); color: #fff; grid-column: span 2; }
        #calc-display { background: #000; border: 1px solid var(--primary); color: var(--primary); font-size: 1.8em; text-align: left; padding: 15px; border-radius: 8px; margin-bottom: 10px; font-family: monospace; letter-spacing: 2px;}

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; overflow-y: auto; backdrop-filter: blur(5px); }
        .modal-content { background: #111; width: 95%; max-width: 900px; border-radius: 20px; padding: 25px; border: 1px solid var(--primary); margin: 30px auto; position: relative; }
        .close-btn { position: absolute; top: 15px; left: 15px; background: #333; color: #fff; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 1.2em; }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div><h3 id="loader-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„...</h3></div>

    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
    <aside class="sidebar" id="sidebar">
        <div class="logo-area"><h2>Ø³ÙˆÙ‚ Ø¹ÙƒØ§Ø²</h2><span style="color:var(--text-muted); font-size:0.8em;">Ù†Ø¸Ø§Ù… Ø§Ù„Ù€ ERP Ø§Ù„Ø´Ø§Ù…Ù„</span></div>
        <button class="nav-btn active" onclick="switchTab('accounting', this)"><i class="fas fa-chart-pie"></i> Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„Ù…Ø§Ù„ÙŠØ§Øª</button>
        <button class="nav-btn" onclick="switchTab('orders', this)"><i class="fas fa-box-open"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
        <button class="nav-btn" onclick="switchTab('inventory', this)"><i class="fas fa-plus-square"></i> Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø®Ø²Ù†</button>
        <button class="nav-btn" onclick="switchTab('edit-inventory', this)"><i class="fas fa-edit"></i> ÙƒØ±ÙˆØª Ø§Ù„ØµÙ†Ù (ØªØ¹Ø¯ÙŠÙ„)</button>
        <button class="nav-btn" id="nav-templates" onclick="switchTab('templates', this)"><i class="fas fa-ruler-combined"></i> Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª</button>
        <button class="nav-btn" onclick="switchTab('settings', this)"><i class="fas fa-cogs"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±</button>
        <button class="nav-btn" onclick="switchTab('shipping', this)"><i class="fas fa-truck"></i> ØªØ³Ø¹ÙŠØ± Ø§Ù„Ø´Ø­Ù†</button>
        <button class="nav-btn" onclick="switchTab('discounts', this)"><i class="fas fa-tags"></i> Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª</button>
    </aside>

    <main class="main-content">
        <div class="mobile-header">
            <h2 style="color:var(--primary); margin:0; font-family:'Reem Kufi', sans-serif;">Ø³ÙˆÙ‚ Ø¹ÙƒØ§Ø² ERP</h2>
            <button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        </div>

        <section id="accounting" class="section active">
            <div class="flex-row">
                <div style="flex: 2;">
                    <div class="panel">
                        <h2 class="panel-title"><i class="fas fa-wallet"></i> Ø§Ù„Ø®Ø²ÙŠÙ†Ø© ÙˆØ­Ø±ÙƒØ© Ø§Ù„Ø£Ù…ÙˆØ§Ù„ (Ø§Ø¶ØºØ· Ù„Ù„ØªÙØ§ØµÙŠÙ„)</h2>
                        <div class="stats-grid">
                            <div class="stat-card success" onclick="openReportModal('delivered')"><div class="stat-info"><h3>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…)</h3><p id="acc-safe">0 Ø¬.Ù…</p></div><i class="fas fa-sack-dollar stat-icon"></i></div>
                            <div class="stat-card info" onclick="openReportModal('courier')"><div class="stat-info"><h3>Ù…Ø¹ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ (Ø¬Ø§Ø±ÙŠ)</h3><p id="acc-courier">0 Ø¬.Ù…</p></div><i class="fas fa-motorcycle stat-icon"></i></div>
                            <div class="stat-card warning" onclick="openReportModal('pending')"><div class="stat-info"><h3>Ø£Ø±Ø¨Ø§Ø­ (Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©)</h3><p id="acc-pending">0 Ø¬.Ù…</p></div><i class="fas fa-hourglass-half stat-icon"></i></div>
                        </div>
                        <h2 class="panel-title" style="margin-top:40px;"><i class="fas fa-exclamation-triangle"></i> ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø®Ø³Ø§Ø¦Ø± ÙˆØ§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª</h2>
                        <div class="stats-grid">
                            <div class="stat-card danger" onclick="openReportModal('returns')"><div class="stat-info"><h3>Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¶Ø©</h3><p id="acc-returns">0 Ø¬.Ù…</p></div><i class="fas fa-undo stat-icon"></i></div>
                            <div class="stat-card danger" onclick="openReportModal('cancelled')"><div class="stat-info"><h3>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù„ØºØ§Ø©</h3><p id="acc-cancelled">0 Ø¬.Ù…</p></div><i class="fas fa-ban stat-icon"></i></div>
                        </div>
                    </div>
                    <div class="panel">
                        <h2 class="panel-title"><i class="fas fa-boxes"></i> ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø§Ø¶ØºØ· Ù„Ù„ØªÙØ§ØµÙŠÙ„)</h2>
                        <div class="stats-grid">
                            <div class="stat-card danger" onclick="openReportModal('inventory')"><div class="stat-info"><h3>Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ (Ø§Ù„ØªÙƒÙ„ÙØ©)</h3><p id="inv-cost">0 Ø¬.Ù…</p></div><i class="fas fa-file-invoice-dollar stat-icon"></i></div>
                            <div class="stat-card info" onclick="openReportModal('inventory')"><div class="stat-info"><h3>Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²Ù† (Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹)</h3><p id="inv-retail">0 Ø¬.Ù…</p></div><i class="fas fa-tags stat-icon"></i></div>
                        </div>
                    </div>
                </div>

                <div style="flex: 1; min-width: 250px; max-width: 350px;">
                    <div class="panel">
                        <h2 class="panel-title"><i class="fas fa-calculator"></i> Ø§Ù„Ø¢Ù„Ø© Ø§Ù„Ø­Ø§Ø³Ø¨Ø©</h2>
                        <input type="text" id="calc-display" readonly value="0">
                        <div class="calc-grid">
                            <button class="calc-btn clear" onclick="calcAction('C')">C</button><button class="calc-btn op" onclick="calcAction('/')">Ã·</button><button class="calc-btn op" onclick="calcAction('*')">Ã—</button>
                            <button class="calc-btn" onclick="calcAction('7')">7</button><button class="calc-btn" onclick="calcAction('8')">8</button><button class="calc-btn" onclick="calcAction('9')">9</button><button class="calc-btn op" onclick="calcAction('-')">-</button>
                            <button class="calc-btn" onclick="calcAction('4')">4</button><button class="calc-btn" onclick="calcAction('5')">5</button><button class="calc-btn" onclick="calcAction('6')">6</button><button class="calc-btn op" onclick="calcAction('+')">+</button>
                            <button class="calc-btn" onclick="calcAction('1')">1</button><button class="calc-btn" onclick="calcAction('2')">2</button><button class="calc-btn" onclick="calcAction('3')">3</button><button class="calc-btn eq" onclick="calcAction('=')">=</button>
                            <button class="calc-btn" onclick="calcAction('0')" style="grid-column: span 2;">0</button><button class="calc-btn" onclick="calcAction('.')">.</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="orders" class="section">
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-list"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</h2>
                <div style="overflow-x:auto;">
                    <table>
                        <thead><tr><th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ù„Ù…ÙƒØ§Ù†</th><th>Ø§Ù„ØªÙˆØ§ØµÙ„</th><th>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ø£Ù„ÙˆØ§Ù† ÙˆÙ…Ù‚Ø§Ø³Ø§Øª)</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
                        <tbody id="orders-table"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="settings" class="section">
            <div class="panel" style="max-width: 600px; margin: auto;">
                <h2 class="panel-title"><i class="fas fa-cogs"></i> ØªØ®ØµÙŠØµ Ù†Ø´Ø§Ø· Ø§Ù„Ù…ØªØ¬Ø±</h2>
                <div class="switch-container"><span>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ØµÙ„Ø¨Ø© (Ø·ÙˆÙ„ØŒ Ø¹Ø±Ø¶ØŒ ØªØ®Ø§Ù†Ø©)</span><label class="switch"><input type="checkbox" id="set-hard-dim"><span class="slider"></span></label></div>
                <div class="switch-container"><span>ØªÙØ¹ÙŠÙ„ Ø¯Ù„ÙŠÙ„ Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ù…Ù„Ø§Ø¨Ø³ (ØµØ¯Ø±ØŒ ÙƒØªÙØŒ ÙƒÙ…)</span><label class="switch"><input type="checkbox" id="set-cloth-guide"><span class="slider"></span></label></div>
                <div class="switch-container"><span>ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª</span><label class="switch"><input type="checkbox" id="set-colors"><span class="slider"></span></label></div>
                <div class="switch-container"><span>ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª ÙˆÙ‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù…Ø®Ø²Ù†</span><label class="switch"><input type="checkbox" id="set-sizes"><span class="slider"></span></label></div>
                <button class="btn-main" onclick="saveStoreSettings()" style="margin-top:10px;">Ø­ÙØ¸ ÙˆØªØ·Ø¨ÙŠÙ‚</button>
            </div>
        </section>

        <section id="templates" class="section">
            <div class="panel" style="max-width: 700px; margin: auto;">
                <h2 class="panel-title"><i class="fas fa-layer-group"></i> Ø¨Ù†Ø§Ø¡ Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©</h2>
                <div class="input-group"><label>Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ù„Ø¨ (Ù…Ø«Ø§Ù„: Ø¬ÙŠÙ†Ø² Ø±Ø¬Ø§Ù„ÙŠ)</label><input type="text" id="tpl-name"></div>
                <div class="input-group"><label>Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª (Ø§ÙØµÙ„ Ø¨ÙŠÙ†Ù‡Ø§ Ø¨ÙØ§ØµÙ„Ø© , )</label><input type="text" id="tpl-values" placeholder="Ù…Ø«Ø§Ù„: 32, 34, 36, 38"></div>
                <button class="btn-main" onclick="addSizeTemplate()" style="background:var(--info); color:#fff;">Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ù„Ø¨</button>
                <div id="templates-list" style="margin-top:15px;"></div>
            </div>
        </section>

        <section id="inventory" class="section">
            <div class="flex-row">
                <div class="panel">
                    <h3 class="panel-title"><i class="fas fa-folder-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… (Ø¹Ø±Ø¨ÙŠ/Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</h3>
                    <div class="flex-row"><div class="input-group"><label>Ø§Ù„Ø§Ø³Ù… (Ø¹Ø±Ø¨ÙŠ)</label><input type="text" id="cat-title-ar"></div><div class="input-group"><label>Ø§Ù„Ø§Ø³Ù… (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label><input type="text" id="cat-title-en"></div></div>
                    <div class="input-group"><label>ÙŠØªØ¨Ø¹ Ù‚Ø³Ù… Ø±Ø¦ÙŠØ³ÙŠØŸ</label><select id="cat-parent-id"></select></div>
                    <div style="background:#222; padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid #333;">
                        <label class="checkbox-label"><input type="checkbox" id="cat-show-home" checked> Ø¹Ø±Ø¶ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ÙÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©ØŸ</label>
                        <div class="input-group"><label>ØªØ±ØªÙŠØ¨ Ø¸Ù‡ÙˆØ±Ù‡ (Ø±Ù‚Ù…)</label><input type="number" id="cat-home-order" value="1"></div>
                        <label class="checkbox-label"><input type="checkbox" id="cat-allow-bundle"> Ø¥ØªØ§Ø­Ø© Ù…Ù†ØªØ¬Ø§ØªÙ‡ ÙÙŠ Ù…ÙŠØ²Ø© "ÙƒÙˆÙ‘Ù† Ø·Ù‚Ù…Ùƒ"ØŸ</label>
                    </div>
                    <div class="input-group"><label>ØµÙˆØ± Ø§Ù„Ù‚Ø³Ù…</label><input type="file" id="cat-images" multiple accept="image/*"></div>
                    <button class="btn-main" onclick="addCategory()">Ø­ÙØ¸ Ø§Ù„Ù‚Ø³Ù…</button>
                </div>

                <div class="panel">
                    <h3 class="panel-title"><i class="fas fa-box-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</h3>
                    <div class="input-group"><label>Ø§Ù„Ù‚Ø³Ù…</label><select id="prod-cat"></select></div>
                    
                    <div class="input-group"><label style="color:var(--info);">ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬ (SKU) Ù„Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø¬Ø±Ø¯</label><input type="text" id="prod-code" placeholder="Ù…Ø«Ø§Ù„: SHIRT-001"></div>
                    
                    <div class="flex-row"><div class="input-group"><label>Ø§Ù„Ø§Ø³Ù… (Ø¹Ø±Ø¨ÙŠ)</label><input type="text" id="prod-title-ar"></div><div class="input-group"><label>Ø§Ù„Ø§Ø³Ù… (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label><input type="text" id="prod-title-en"></div></div>
                    <div class="flex-row"><div class="input-group"><label>Ø§Ù„ØªÙƒÙ„ÙØ© (Ø¬Ù…Ù„Ø©)</label><input type="number" id="prod-cost-price" value="0"></div><div class="input-group"><label>Ø§Ù„Ø¨ÙŠØ¹ (Ù‚Ø·Ø§Ø¹ÙŠ)</label><input type="number" id="prod-price"></div><div class="input-group"><label>Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ</label><input type="number" id="prod-stock" value="100"></div></div>
                    <div class="input-group"><label>Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</label><input type="file" id="prod-image" accept="image/*"></div>
                    
                    <div id="div-hard-dimensions" class="flex-row" style="background:#1a1a1a; padding:10px; border:1px dashed #444; border-radius:8px; margin-top:10px;">
                        <div class="input-group"><label>Ø§Ù„Ø·ÙˆÙ„</label><input type="text" id="prod-length"></div><div class="input-group"><label>Ø§Ù„Ø¹Ø±Ø¶</label><input type="text" id="prod-width"></div><div class="input-group"><label>Ø§Ù„ØªØ®Ø§Ù†Ø©</label><input type="text" id="prod-thickness"></div>
                    </div>
                    <div id="div-clothing-guide" class="flex-row" style="background:#1a1a1a; padding:10px; border:1px dashed var(--primary); border-radius:8px; margin-top:10px;">
                        <div class="input-group"><label>Ù…Ø­ÙŠØ· Ø§Ù„ØµØ¯Ø±</label><input type="text" id="prod-chest"></div><div class="input-group"><label>Ø¹Ø±Ø¶ Ø§Ù„ÙƒØªÙ</label><input type="text" id="prod-shoulder"></div><div class="input-group"><label>Ø·ÙˆÙ„ Ø§Ù„Ù‚Ø·Ø¹Ø©</label><input type="text" id="prod-body"></div><div class="input-group"><label>Ø·ÙˆÙ„ Ø§Ù„ÙƒÙ…</label><input type="text" id="prod-sleeve"></div>
                    </div>
                    <button class="btn-main" onclick="addProduct()" style="margin-top:15px;">Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
                </div>
            </div>

            <div class="flex-row" style="margin-top:20px;">
                <div class="panel" id="panel-colors">
                    <h3 class="panel-title"><i class="fas fa-palette"></i> Ø±Ø¨Ø· Ù„ÙˆÙ† Ø¨Ù…Ù†ØªØ¬</h3>
                    <div class="input-group"><label>Ø§Ù„Ù…Ù†ØªØ¬</label><select id="color-prod-id"></select></div>
                    <div class="flex-row"><div class="input-group"><label>Ø§Ù„Ù„ÙˆÙ† (Ø¹Ø±Ø¨ÙŠ)</label><input type="text" id="color-name-ar"></div><div class="input-group"><label>Ø§Ù„Ù„ÙˆÙ† (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label><input type="text" id="color-name-en"></div></div>
                    <div class="input-group"><label>Ø§Ù„ÙƒÙˆØ¯ (Hex)</label><input type="color" id="color-hex" value="#ff0000" style="height:40px;"></div>
                    <div class="input-group"><label>ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ù„Ù„ÙˆÙ† Ø¯Ù‡</label><input type="file" id="color-image" accept="image/*"></div>
                    <button class="btn-main" onclick="addColor()" style="background:#3742fa; color:#fff;">Ø­ÙØ¸ Ø§Ù„Ù„ÙˆÙ†</button>
                </div>

                <div class="panel" id="panel-sizes">
                    <h3 class="panel-title"><i class="fas fa-ruler"></i> ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ù…Ù†ØªØ¬</h3>
                    <div class="input-group"><label>Ø§Ù„Ù…Ù†ØªØ¬</label><select id="size-prod-id"></select></div>
                    <div class="input-group"><label>Ø§Ø®ØªØ± Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª</label><select id="size-template-select" onchange="loadTemplateOptionsForCheckboxes()"></select></div>
                    <div id="size-checkboxes-container" class="size-checkbox-grid"><p style="color:#888; font-size:0.85em; grid-column: 1 / -1;">Ø§Ø®ØªØ± Ù‚Ø§Ù„Ø¨ Ù„ØªØ¸Ù‡Ø± Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª...</p></div>
                    <button class="btn-main" onclick="saveCheckedSizes()" style="background:var(--success); color:#000; margin-top:15px;">Ø­ÙØ¸ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù„Ù„Ù…Ù†ØªØ¬</button>
                </div>
            </div>
        </section>

        <section id="edit-inventory" class="section">
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-edit"></i> ÙƒØ±ÙˆØª Ø§Ù„ØµÙ†Ù ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
                <div style="overflow-x:auto;">
                    <table>
                        <thead><tr><th>ØµÙˆØ±Ø©</th><th>ÙƒÙˆØ¯ (SKU)</th><th>Ø§Ù„Ù…Ù†ØªØ¬ (Ø¹Ø±Ø¨ÙŠ)</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„Ø¨ÙŠØ¹</th><th>Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                        <tbody id="edit-products-table"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="shipping" class="section"><div class="panel" style="max-width: 500px; margin: auto;"><h2 class="panel-title"><i class="fas fa-truck"></i> ØªØ³Ø¹ÙŠØ±Ø© Ø§Ù„Ø´Ø­Ù†</h2><div class="input-group"><label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label><select id="ship-city-select" onchange="loadSelectedCityPrice()"></select></div><div class="input-group"><label>Ø§Ù„Ø³Ø¹Ø± (Ø¬.Ù…)</label><input type="number" id="ship-city-price"></div><button class="btn-main" onclick="updateCityPrice()">ØªØ­Ø¯ÙŠØ«</button></div></section>
        <section id="discounts" class="section"><div class="panel" style="max-width: 500px; margin: auto;"><h2 class="panel-title"><i class="fas fa-ticket-alt"></i> Ø¥ØµØ¯Ø§Ø± ÙƒÙˆØ¯ Ø®ØµÙ…</h2><div class="input-group"><label>Ø§Ù„ÙƒÙˆØ¯</label><input type="text" id="promo-code" style="text-transform: uppercase;"></div><div class="input-group"><label>Ø§Ù„Ø®ØµÙ… (%)</label><input type="number" id="promo-percent"></div><button class="btn-main" onclick="addPromo()">ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†</button></div></section>
    </main>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="document.getElementById('edit-modal').style.display='none'"><i class="fas fa-times"></i></button>
            <h2 class="panel-title"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬</h2>
            <input type="hidden" id="edit-prod-id">
            <div class="input-group"><label style="color:var(--info);">ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬ (SKU)</label><input type="text" id="edit-prod-code"></div>
            <div class="flex-row"><div class="input-group"><label>Ø§Ù„Ø§Ø³Ù… (Ø¹Ø±Ø¨ÙŠ)</label><input type="text" id="edit-prod-title-ar"></div><div class="input-group"><label>Ø§Ù„Ø§Ø³Ù… (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label><input type="text" id="edit-prod-title-en"></div></div>
            <div class="flex-row"><div class="input-group"><label>Ø³Ø¹Ø± Ø§Ù„Ø¬Ù…Ù„Ø©</label><input type="number" id="edit-prod-cost"></div><div class="input-group"><label>Ø³Ø¹Ø± Ø§Ù„Ù‚Ø·Ø§Ø¹ÙŠ</label><input type="number" id="edit-prod-price"></div><div class="input-group"><label>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</label><input type="number" id="edit-prod-stock"></div></div>
            <button class="btn-main" onclick="saveProductEdit()" style="margin-top:20px;">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        </div>
    </div>

    <div id="report-modal" class="modal">
        <div class="modal-content" style="max-width: 850px;">
            <button class="close-btn" onclick="document.getElementById('report-modal').style.display='none'"><i class="fas fa-times"></i></button>
            <h2 class="panel-title" id="report-modal-title">ØªÙ‚Ø±ÙŠØ± Ù…ÙØµÙ„</h2>
            <div style="overflow-x:auto; max-height: 400px; overflow-y: auto; border: 1px solid #333; border-radius: 8px;">
                <table>
                    <thead id="report-thead"></thead>
                    <tbody id="report-tbody"></tbody>
                </table>
            </div>
            <div style="margin-top: 20px; font-weight: 900; color: var(--primary); font-size: 1.4em; padding: 15px; background: #000; border-radius: 8px; border-right: 4px solid var(--primary);" id="report-total-amount"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://wkfiocqhkspsvqgyjpea.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_l2vgR8Xbt0Csw8W_Slo_1Q_9glKlIoN';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let systemSettings = {};
        let calcValue = '';
        let globalOrdersData = [];
        let globalProductsData = [];

        function showLoader(text) { document.getElementById('loader-text').innerText = text; document.getElementById('loader').style.display = 'flex'; }
        function hideLoader() { document.getElementById('loader').style.display = 'none'; }

        // Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù…Ù†ÙŠÙˆ
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('sidebar-overlay').classList.toggle('active');
        }

        async function initAdmin() {
            showLoader("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…...");
            await loadStoreSettingsFromDB();
            hideLoader();
            switchTab('accounting', document.querySelector('.nav-btn.active'));
        }

        function switchTab(tabId, btn) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if(btn) btn.classList.add('active');
            
            // Ù‚ÙÙ„ Ø§Ù„Ù…Ù†ÙŠÙˆ ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù„Ù…Ø§ ÙŠØ®ØªØ§Ø± ØªØ¨ÙˆÙŠØ¨Ø©
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('sidebar-overlay').classList.remove('active');

            if(tabId === 'accounting') loadComprehensiveReports();
            if(tabId === 'orders') loadOrders();
            if(tabId === 'inventory') { loadCategoriesForSelects(); loadProductsList(); loadSizeTemplatesDropdown(); }
            if(tabId === 'templates') loadTemplatesList();
            if(tabId === 'edit-inventory') loadEditInventory();
            if(tabId === 'shipping') loadCitiesForDropdown();
        }

        async function uploadImage(file) {
            const fileExt = file.name.split('.').pop();
            const fileName = `${Math.random().toString(36).substring(2, 15)}_${Date.now()}.${fileExt}`;
            const { error } = await supabaseClient.storage.from('okaz_images').upload(fileName, file);
            if (error) throw error;
            return supabaseClient.storage.from('okaz_images').getPublicUrl(fileName).data.publicUrl;
        }

        // ================= Ø§Ù„Ø¢Ù„Ø© Ø§Ù„Ø­Ø§Ø³Ø¨Ø© ğŸ§® =================
        function calcAction(val) {
            const display = document.getElementById('calc-display');
            if(val === 'C') { calcValue = ''; display.value = '0'; return; }
            if(val === '=') { try { calcValue = eval(calcValue).toString(); display.value = calcValue; } catch(e) { display.value = "Error"; calcValue = ''; } return; }
            calcValue += val; display.value = calcValue;
        }

        // ================= Ù‚Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„Ù…Ø§Ù„ÙŠØ§Øª ğŸ’° =================
        async function loadComprehensiveReports() {
            const { data: orders } = await supabaseClient.from('orders').select('id, customer_name, grand_total, status, discount_amount, created_at');
            globalOrdersData = orders || [];
            let safe = 0, courier = 0, pending = 0, returns = 0, cancelled = 0;
            if(orders) {
                orders.forEach(o => {
                    const total = Number(o.grand_total) || 0;
                    if(o.status === 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„') safe += total;
                    else if(o.status === 'Ù…Ø¹ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨') courier += total;
                    else if(o.status === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' || o.status === 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²') pending += total;
                    else if(o.status === 'Ù…Ø±ØªØ¬Ø¹') returns += total;
                    else if(o.status === 'Ù…Ù„ØºÙŠ') cancelled += total;
                });
            }
            document.getElementById('acc-safe').innerText = safe.toFixed(2) + ' Ø¬.Ù…'; document.getElementById('acc-courier').innerText = courier.toFixed(2) + ' Ø¬.Ù…'; document.getElementById('acc-pending').innerText = pending.toFixed(2) + ' Ø¬.Ù…'; document.getElementById('acc-returns').innerText = returns.toFixed(2) + ' Ø¬.Ù…'; document.getElementById('acc-cancelled').innerText = cancelled.toFixed(2) + ' Ø¬.Ù…';

            const { data: products } = await supabaseClient.from('products').select('id, title_ar, product_code, price, cost_price, stock_quantity');
            globalProductsData = products || [];
            let invCost = 0, invRetail = 0;
            if(products) {
                products.forEach(p => { invCost += Number(p.cost_price || 0) * Number(p.stock_quantity || 0); invRetail += Number(p.price || 0) * Number(p.stock_quantity || 0); });
            }
            document.getElementById('inv-cost').innerText = invCost.toFixed(2) + ' Ø¬.Ù…'; document.getElementById('inv-retail').innerText = invRetail.toFixed(2) + ' Ø¬.Ù…'; document.getElementById('inv-profit').innerText = (invRetail - invCost).toFixed(2) + ' Ø¬.Ù…';
        }

        // ================= Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Drill-down) ğŸ“‘ =================
        function openReportModal(type) {
            const thead = document.getElementById('report-thead'); const tbody = document.getElementById('report-tbody'); const title = document.getElementById('report-modal-title'); const totalDiv = document.getElementById('report-total-amount');
            thead.innerHTML = ''; tbody.innerHTML = ''; let totalSum = 0;

            if (['delivered', 'courier', 'pending', 'returns', 'cancelled'].includes(type)) {
                let statusFilter = [];
                if(type === 'delivered') { statusFilter = ['ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„']; title.innerHTML = '<i class="fas fa-check-circle" style="color:var(--success)"></i> ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø­Ù‚Ù‚Ø©'; }
                if(type === 'courier') { statusFilter = ['Ù…Ø¹ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨']; title.innerHTML = '<i class="fas fa-motorcycle" style="color:var(--info)"></i> ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ø¹ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨'; }
                if(type === 'pending') { statusFilter = ['Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²']; title.innerHTML = '<i class="fas fa-hourglass-half" style="color:var(--warning)"></i> ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©'; }
                if(type === 'returns') { statusFilter = ['Ù…Ø±ØªØ¬Ø¹']; title.innerHTML = '<i class="fas fa-undo" style="color:var(--danger)"></i> ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª'; }
                if(type === 'cancelled') { statusFilter = ['Ù…Ù„ØºÙŠ']; title.innerHTML = '<i class="fas fa-ban" style="color:var(--danger)"></i> ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù„ØºØ§Ø©'; }

                const filteredOrders = globalOrdersData.filter(o => statusFilter.includes(o.status));
                thead.innerHTML = `<tr><th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th><th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨</th></tr>`;
                filteredOrders.forEach(o => {
                    totalSum += Number(o.grand_total);
                    const date = new Date(o.created_at).toLocaleDateString('ar-EG');
                    const shortId = o.id.split('-')[0].toUpperCase();
                    tbody.innerHTML += `<tr><td style="color:var(--primary); font-weight:bold;">#OKZ-${shortId}</td><td>${o.customer_name}</td><td>${date}</td><td style="color:var(--success); font-weight:bold;">${o.grand_total} Ø¬.Ù…</td></tr>`;
                });
                totalDiv.innerHTML = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©: <span>${totalSum.toFixed(2)} Ø¬.Ù…</span>`;

            } else if (type === 'inventory') {
                title.innerHTML = '<i class="fas fa-boxes" style="color:var(--info)"></i> ØªÙ‚Ø±ÙŠØ± Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ';
                thead.innerHTML = `<tr><th>ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬ (SKU)</th><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©</th><th>ØªÙƒÙ„ÙØ© Ø§Ù„Ù‚Ø·Ø¹Ø©</th><th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th></tr>`;
                let totalCostSum = 0, totalRetailSum = 0;

                globalProductsData.forEach(p => {
                    const qty = Number(p.stock_quantity) || 0; const cost = Number(p.cost_price) || 0; const price = Number(p.price) || 0;
                    totalCostSum += (qty * cost); totalRetailSum += (qty * price);
                    tbody.innerHTML += `<tr><td style="color:#aaa;">${p.product_code || '---'}</td><td style="font-weight:bold;">${p.title_ar}</td><td style="font-weight:900;">${qty}</td><td style="color:var(--danger);">${cost} Ø¬.Ù…</td><td style="color:var(--info);">${price} Ø¬.Ù…</td></tr>`;
                });
                totalDiv.innerHTML = `<span style="color:var(--danger);">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„: ${totalCostSum.toFixed(2)} Ø¬.Ù…</span> <br> <span style="color:var(--info);">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©: ${totalRetailSum.toFixed(2)} Ø¬.Ù…</span>`;
            }
            document.getElementById('report-modal').style.display = 'block';
        }

        // ================= Ø§Ù„Ø·Ù„Ø¨Ø§Øª ğŸ“¦ =================
        async function loadOrders() {
            const { data } = await supabaseClient.from('orders').select('*, order_items(*)').order('created_at', { ascending: false });
            const tbody = document.getElementById('orders-table'); tbody.innerHTML = '';
            data.forEach(o => {
                const shortId = o.id.split('-')[0].toUpperCase();
                let itemsHtml = o.order_items.map(i => `<div style="font-size:0.85em; color:#bbb;">- ${i.product_name} (${i.selected_color}|${i.selected_size}) <b style="color:#fff">x${i.quantity}</b></div>`).join('');
                const statuses = ['Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²', 'Ù…Ø¹ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨', 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„', 'Ù…Ù„ØºÙŠ', 'Ù…Ø±ØªØ¬Ø¹'];
                let selectColor = o.status === 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„' ? 'var(--success)' : (o.status === 'Ù…Ù„ØºÙŠ' || o.status === 'Ù…Ø±ØªØ¬Ø¹' ? 'var(--danger)' : '#fff');
                let selectHtml = `<select class="status-select" style="color:${selectColor}; border-color:${selectColor};" onchange="updateOrderStatus('${o.id}', this.value)">`;
                statuses.forEach(s => { selectHtml += `<option value="${s}" ${o.status === s ? 'selected' : ''} style="color:#fff;">${s}</option>`; }); selectHtml += `</select>`;
                let locationHtml = `${o.customer_city} - ${o.customer_area}<br><small style="color:#aaa;">Ø´: ${o.customer_street}, Ø¹Ù…: ${o.customer_building}, Ø´Ù‚Ø©: ${o.customer_apartment}</small>`;
                tbody.innerHTML += `<tr><td style="color:var(--primary); font-weight:bold;">#OKZ-${shortId}</td><td style="font-weight:bold;">${o.customer_name}<br>${locationHtml}</td><td>${o.customer_phone}</td><td>${itemsHtml}</td><td style="color:var(--success); font-weight:bold;">${o.grand_total} Ø¬.Ù…</td><td>${selectHtml}</td></tr>`;
            });
        }
        async function updateOrderStatus(orderId, newStatus) {
            if(newStatus === 'Ù…Ù„ØºÙŠ' || newStatus === 'Ù…Ø±ØªØ¬Ø¹') {
                if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø±Ø¬Ø§Ø¹ ÙƒÙ…ÙŠØ§Øª Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø®Ø²Ù†ØŸ")) {
                    showLoader("Ø¥Ø±Ø¬Ø§Ø¹ Ù„Ù„Ù…Ø®Ø²Ù†..."); const {data: items} = await supabaseClient.from('order_items').select('product_name, quantity').eq('order_id', orderId);
                    if(items) { for(let item of items) { const {data: prod} = await supabaseClient.from('products').select('id, stock_quantity').eq('title_ar', item.product_name).single(); if(prod) { await supabaseClient.from('products').update({stock_quantity: prod.stock_quantity + item.quantity}).eq('id', prod.id); } } } alert("ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ âœ…");
                }
            }
            showLoader("ØªØ­Ø¯ÙŠØ«..."); await supabaseClient.from('orders').update({ status: newStatus }).eq('id', orderId); hideLoader(); loadComprehensiveReports(); loadOrders(); 
        }

        // ================= Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (SaaS Feature Flags) âš™ï¸ =================
        async function loadStoreSettingsFromDB() {
            const { data } = await supabaseClient.from('store_settings').select('*'); if(data) data.forEach(x => systemSettings[x.setting_key] = x.setting_value);
            document.getElementById('set-hard-dim').checked = (systemSettings.enable_hard_dimensions === 'true'); document.getElementById('set-cloth-guide').checked = (systemSettings.enable_clothing_guide === 'true'); document.getElementById('set-colors').checked = (systemSettings.enable_colors === 'true'); document.getElementById('set-sizes').checked = (systemSettings.enable_size_templates === 'true');
            document.getElementById('div-hard-dimensions').style.display = (systemSettings.enable_hard_dimensions === 'true') ? 'flex' : 'none'; document.getElementById('div-clothing-guide').style.display = (systemSettings.enable_clothing_guide === 'true') ? 'flex' : 'none'; document.getElementById('panel-colors').style.display = (systemSettings.enable_colors === 'true') ? 'block' : 'none'; document.getElementById('panel-sizes').style.display = (systemSettings.enable_size_templates === 'true') ? 'block' : 'none'; document.getElementById('nav-templates').style.display = (systemSettings.enable_size_templates === 'true') ? 'flex' : 'none';
        }
        async function saveStoreSettings() { showLoader("Ø­ÙØ¸..."); const updates = [ { setting_key: 'enable_hard_dimensions', setting_value: document.getElementById('set-hard-dim').checked ? 'true' : 'false' }, { setting_key: 'enable_clothing_guide', setting_value: document.getElementById('set-cloth-guide').checked ? 'true' : 'false' }, { setting_key: 'enable_colors', setting_value: document.getElementById('set-colors').checked ? 'true' : 'false' }, { setting_key: 'enable_size_templates', setting_value: document.getElementById('set-sizes').checked ? 'true' : 'false' } ]; for(let u of updates) { await supabaseClient.from('store_settings').update({ setting_value: u.setting_value }).eq('setting_key', u.setting_key); } alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«!"); await loadStoreSettingsFromDB(); hideLoader(); }

        // ================= Ø§Ù„Ù…Ø®Ø²Ù† ÙˆØ§Ù„Ù‚ÙˆØ§Ù„Ø¨ ÙˆØ§Ù„Ø´Ø­Ù† =================
        async function loadCategoriesForSelects() { const { data } = await supabaseClient.from('categories').select('*').order('created_at', { ascending: true }); const p = document.getElementById('cat-parent-id'), c = document.getElementById('prod-cat'); p.innerHTML='<option value="">-- Ø±Ø¦ÙŠØ³ÙŠ --</option>'; c.innerHTML='<option value="">-- Ø§Ø®ØªØ± --</option>'; data.forEach(x => { p.innerHTML+=`<option value="${x.id}">${x.title_ar}</option>`; c.innerHTML+=`<option value="${x.id}">${x.title_ar}</option>`; }); }
        async function loadProductsList() { const { data } = await supabaseClient.from('products').select('*'); let o = '<option value="">-- Ø§Ø®ØªØ± --</option>'; data.forEach(x => o+=`<option value="${x.id}">${x.title_ar}</option>`); document.getElementById('color-prod-id').innerHTML=o; document.getElementById('size-prod-id').innerHTML=o; }
        
        async function addCategory() { const t_ar = document.getElementById('cat-title-ar').value, t_en = document.getElementById('cat-title-en').value, p_id = document.getElementById('cat-parent-id').value || null, shw = document.getElementById('cat-show-home').checked, ord = document.getElementById('cat-home-order').value || 0, bndl = document.getElementById('cat-allow-bundle').checked, files = document.getElementById('cat-images'); if(!t_ar) return alert("Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù…Ø·Ù„ÙˆØ¨"); showLoader("Ø­ÙØ¸ Ø§Ù„Ù‚Ø³Ù…..."); try { let urls=[]; if(files.files.length>0){ for(let i=0;i<files.files.length;i++) urls.push(await uploadImage(files.files[i])); } await supabaseClient.from('categories').insert([{ title_ar: t_ar, title_en: t_en, parent_id: p_id, show_on_home: shw, home_order: ord, allow_in_bundles: bndl, image: urls[0]||'', gallery: urls }]); alert("ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ…"); document.getElementById('cat-title-ar').value=''; loadCategoriesForSelects(); } catch(e){alert("Ø®Ø·Ø£");} hideLoader(); }
        async function addProduct() { const c_id = document.getElementById('prod-cat').value, p_code = document.getElementById('prod-code').value || '', t_ar = document.getElementById('prod-title-ar').value, prc = document.getElementById('prod-price').value, file = document.getElementById('prod-image'); if(!c_id || !t_ar || !prc || file.files.length===0) return alert("ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©"); showLoader("Ø±ÙØ¹ Ø§Ù„Ù…Ù†ØªØ¬..."); try { const img = await uploadImage(file.files[0]); await supabaseClient.from('products').insert([{ category_id: c_id, product_code: p_code, title_ar: t_ar, title_en: document.getElementById('prod-title-en').value, price: prc, cost_price: document.getElementById('prod-cost-price').value||0, stock_quantity: document.getElementById('prod-stock').value||100, image: img, length_val: document.getElementById('prod-length')?.value||'', width_val: document.getElementById('prod-width')?.value||'', thickness_val: document.getElementById('prod-thickness')?.value||'', chest_cm: document.getElementById('prod-chest')?.value||'', shoulder_cm: document.getElementById('prod-shoulder')?.value||'', sleeve_cm: document.getElementById('prod-sleeve')?.value||'', body_length_cm: document.getElementById('prod-body')?.value||'' }]); alert("ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø®Ø²Ù† âœ…"); document.getElementById('prod-title-ar').value=''; document.getElementById('prod-code').value=''; loadProductsList(); loadComprehensiveReports();} catch(e){alert("Ø®Ø·Ø£");} hideLoader(); }
        async function addColor() { const pid = document.getElementById('color-prod-id').value, nar = document.getElementById('color-name-ar').value, hex = document.getElementById('color-hex').value, file = document.getElementById('color-image'); if(!pid||!nar||file.files.length===0)return alert("ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); showLoader("Ø­ÙØ¸..."); try { const img = await uploadImage(file.files[0]); await supabaseClient.from('product_colors').insert([{ product_id: pid, color_name_ar: nar, color_hex: hex, image_url: img }]); alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…"); } catch(e){} hideLoader(); }
        async function addSizeTemplate() { const n=document.getElementById('tpl-name').value, v=document.getElementById('tpl-values').value; if(!n||!v)return; showLoader("Ø­ÙØ¸..."); const arr=v.split(',').map(s=>s.trim()).filter(s=>s!==''); const {data:tpl,error}=await supabaseClient.from('size_templates').insert([{template_name:n}]).select(); if(!error){ const opts=arr.map(x=>({template_id:tpl[0].id, size_value:x})); await supabaseClient.from('size_template_options').insert(opts); alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…"); loadTemplatesList(); } hideLoader(); }
        async function loadTemplatesList() { const {data} = await supabaseClient.from('size_templates').select('*, size_template_options(size_value)'); const list=document.getElementById('templates-list'); list.innerHTML=''; if(data) data.forEach(t=>{ list.innerHTML+=`<div style="background:#222; padding:10px; border-radius:8px; margin-bottom:10px;"><strong style="color:var(--primary);">${t.template_name}</strong><div style="color:#aaa; font-size:0.9em;">[ ${t.size_template_options.map(o=>o.size_value).join(' - ')} ]</div></div>`; }); }
        async function loadSizeTemplatesDropdown() { const {data} = await supabaseClient.from('size_templates').select('*'); const sel=document.getElementById('size-template-select'); sel.innerHTML='<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ù„Ø¨ --</option>'; if(data) data.forEach(t=>sel.innerHTML+=`<option value="${t.id}">${t.template_name}</option>`); }
        async function loadTemplateOptionsForCheckboxes() { const id=document.getElementById('size-template-select').value, cont=document.getElementById('size-checkboxes-container'); cont.innerHTML=''; if(!id)return; const {data} = await supabaseClient.from('size_template_options').select('*').eq('template_id',id); if(data) data.forEach(o=>{ cont.innerHTML+=`<label class="size-box" onclick="this.classList.toggle('selected')">${o.size_value}<input type="checkbox" value="${o.size_value}"></label>`; }); }
        async function saveCheckedSizes() { const pId=document.getElementById('size-prod-id').value, chks=document.querySelectorAll('.size-box.selected input'); if(!pId||chks.length===0)return alert("Ø§Ø®ØªØ± Ù…Ù†ØªØ¬ ÙˆØ¹Ù„Ù… Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª"); showLoader("Ø­ÙØ¸..."); const d=Array.from(chks).map(c=>({product_id:pId, size_name:c.value})); await supabaseClient.from('product_sizes').insert(d); alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…"); document.querySelectorAll('.size-box').forEach(b=>b.classList.remove('selected')); hideLoader(); }
        
        let allProductsEdit = []; let allCategoriesEdit = [];
        async function loadEditInventory() { showLoader("Ø³Ø­Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†..."); const [pReq, cReq] = await Promise.all([supabaseClient.from('products').select('*').order('created_at',{ascending:false}), supabaseClient.from('categories').select('id, title_ar')]); allProductsEdit=pReq.data||[]; allCategoriesEdit=cReq.data||[]; const tbody=document.getElementById('edit-products-table'); tbody.innerHTML=''; allProductsEdit.forEach(p=>{ const cName=allCategoriesEdit.find(c=>c.id===p.category_id)?.title_ar||''; tbody.innerHTML+=`<tr><td><img src="${p.image}" style="width:40px;height:40px;border-radius:5px;object-fit:cover;"></td><td style="color:#aaa;">${p.product_code || '-'}</td><td style="font-weight:bold;">${p.title_ar}</td><td>${cName}</td><td style="color:var(--primary);">${p.price} Ø¬.Ù…</td><td>${p.stock_quantity}</td><td><button class="btn-sm btn-edit" onclick="openEditModal('${p.id}')">ØªØ¹Ø¯ÙŠÙ„</button></td></tr>`; }); hideLoader(); }
        function openEditModal(id) { const p=allProductsEdit.find(x=>x.id===id); if(p){ document.getElementById('edit-prod-id').value=p.id; document.getElementById('edit-prod-code').value=p.product_code || ''; document.getElementById('edit-prod-title-ar').value=p.title_ar; document.getElementById('edit-prod-title-en').value=p.title_en; document.getElementById('edit-prod-cost').value=p.cost_price; document.getElementById('edit-prod-price').value=p.price; document.getElementById('edit-prod-stock').value=p.stock_quantity; document.getElementById('edit-modal').style.display='block'; } }
        async function saveProductEdit() { showLoader("Ø­ÙØ¸..."); await supabaseClient.from('products').update({product_code: document.getElementById('edit-prod-code').value, title_ar:document.getElementById('edit-prod-title-ar').value, title_en:document.getElementById('edit-prod-title-en').value, cost_price:document.getElementById('edit-prod-cost').value, price:document.getElementById('edit-prod-price').value, stock_quantity:document.getElementById('edit-prod-stock').value}).eq('id', document.getElementById('edit-prod-id').value); alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« âœ…"); document.getElementById('edit-modal').style.display='none'; loadEditInventory(); loadComprehensiveReports(); hideLoader(); }
        
        async function loadCitiesForDropdown() { const {data}=await supabaseClient.from('shipping_rules').select('*').order('city_ar'); const sel=document.getElementById('ship-city-select'); sel.innerHTML='<option value="">-- Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© --</option>'; data.forEach(c=>sel.innerHTML+=`<option value="${c.id}">${c.city_ar}</option>`); }
        function loadSelectedCityPrice() { const id=document.getElementById('ship-city-select').value; supabaseClient.from('shipping_rules').select('cost').eq('id',id).single().then(r=>document.getElementById('ship-city-price').value=r.data.cost); }
        async function updateCityPrice() { await supabaseClient.from('shipping_rules').update({cost:document.getElementById('ship-city-price').value}).eq('id',document.getElementById('ship-city-select').value); alert("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ğŸšš"); }
        async function addPromo() { const code=document.getElementById('promo-code').value.toUpperCase(), percent=document.getElementById('promo-percent').value; await supabaseClient.from('promo_codes').insert([{ code, discount_percentage: percent }]); alert("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† ğŸ’¸"); }

        initAdmin();
    </script>
</body>
</html>
