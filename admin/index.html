<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุณูู ุนูุงุฒ | ูุธุงู ุงููุงุดูุฑ ูุงููุฎุงุฒู ุงูุฐูู</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800;900&family=Reem+Kufi:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

    <style>
        :root { --primary: #e67e22; --dark: #0a0a0a; --sidebar: #121212; --card: #1a1a1a; --text: #f1f2f6; --text-muted: #a4b0be; --danger: #ff4757; --success: #2ed573; --info: #3742fa; --warning: #ffa502; }
        body { font-family: 'Cairo', sans-serif; background: var(--dark); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 260px; background: var(--sidebar); border-left: 1px solid #222; display: flex; flex-direction: column; padding: 20px 0; box-shadow: -5px 0 15px rgba(0,0,0,0.5); z-index: 1000; overflow-y:auto; transition: right 0.3s ease; }
        .logo-area { text-align: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #222; }
        .logo-area h2 { color: var(--primary); margin: 0; font-family: 'Reem Kufi', sans-serif; font-size: 1.8em;}
        .nav-btn { display: flex; align-items: center; gap: 15px; padding: 15px 25px; color: var(--text-muted); cursor: pointer; transition: 0.3s; border-right: 4px solid transparent; font-size: 1.1em; font-weight: 600; background: none; border: none; width: 100%; text-align: right; }
        .nav-btn:hover, .nav-btn.active { background: #1f1f1f; color: var(--primary); border-right-color: var(--primary); }
        .nav-btn i { font-size: 1.2em; width: 25px; text-align: center; }

        .main-content { flex: 1; padding: 30px; overflow-y: auto; background: var(--dark); position: relative; }
        .section { display: none; animation: fadeIn 0.4s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .mobile-header { display: none; background: #111; padding: 15px 20px; border-bottom: 2px solid var(--primary); align-items: center; justify-content: space-between; margin: -30px -30px 20px -30px; position: sticky; top: 0; z-index: 99; }
        .mobile-menu-btn { background: none; border: none; color: var(--primary); font-size: 1.6em; cursor: pointer; }
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 999; display: none; backdrop-filter: blur(3px); }
        .sidebar-overlay.active { display: block; }

        @media (max-width: 900px) { .sidebar { position: fixed; right: -260px; height: 100vh; } .sidebar.active { right: 0; } .mobile-header { display: flex; } .main-content { padding: 15px; padding-top: 30px; } .flex-row > div { min-width: 100%; } .stats-grid { grid-template-columns: 1fr; } }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { padding: 25px; border-radius: 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: 0.3s; cursor: pointer; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.5); border-width: 2px; }
        .stat-card.success { background: linear-gradient(135deg, rgba(46, 213, 115, 0.15), rgba(0,0,0,0.8)); border: 1px solid var(--success); }
        .stat-card.info { background: linear-gradient(135deg, rgba(55, 66, 250, 0.15), rgba(0,0,0,0.8)); border: 1px solid var(--info); }
        .stat-card.warning { background: linear-gradient(135deg, rgba(255, 165, 2, 0.15), rgba(0,0,0,0.8)); border: 1px solid var(--warning); }
        .stat-card.danger { background: linear-gradient(135deg, rgba(255, 71, 87, 0.15), rgba(0,0,0,0.8)); border: 1px solid var(--danger); }
        .stat-info h3 { margin: 0; font-size: 1em; color: #ccc; pointer-events: none; }
        .stat-info p { margin: 5px 0 0; font-size: 1.8em; font-weight: 900; color: #fff; pointer-events: none; }
        .stat-icon { font-size: 3.5em; opacity: 0.8; pointer-events: none; }
        .stat-card.success .stat-icon { color: var(--success); } .stat-card.info .stat-icon { color: var(--info); } .stat-card.warning .stat-icon { color: var(--warning); } .stat-card.danger .stat-icon { color: var(--danger); }

        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .calc-btn { background: #222; color: #fff; border: 1px solid #333; padding: 15px; border-radius: 8px; font-size: 1.2em; cursor: pointer; transition: 0.2s; font-family: 'Cairo'; font-weight:bold;}
        .calc-btn:hover { background: var(--primary); color: #000; } .calc-btn.op { background: #333; color: var(--primary); } .calc-btn.eq { background: var(--success); color: #000; grid-column: span 2; } .calc-btn.clear { background: var(--danger); color: #fff; grid-column: span 2; }
        #calc-display { background: #000; border: 1px solid var(--primary); color: var(--primary); font-size: 1.8em; text-align: left; padding: 15px; border-radius: 8px; margin-bottom: 10px; font-family: monospace; letter-spacing: 2px;}

        .panel { background: var(--card); padding: 25px; border-radius: 15px; border: 1px solid #222; margin-bottom: 20px; }
        .panel-title { color: var(--primary); margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 20px; font-size: 1.2em; display: flex; align-items:center; gap:10px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; } th { background: #111; color: var(--text-muted); padding: 15px; text-align: right; border-bottom: 2px solid #222; font-weight: bold;} td { padding: 15px; border-bottom: 1px solid #222; color: #eee; } tr:hover td { background: #1a1a1a; }
        .input-group { margin-bottom: 15px; } .input-group label { display: block; margin-bottom: 6px; color: var(--text-muted); font-size: 0.85em; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #333; background: #111; color: #fff; font-family: 'Cairo'; outline: none; box-sizing: border-box;}
        input[type="file"] { padding: 6px; background: #222; cursor: pointer; } input:focus, select:focus, textarea:focus { border-color: var(--primary); }
        .checkbox-label { display: flex; align-items: center; gap: 10px; cursor: pointer; color: #fff; font-size: 0.9em; margin-bottom: 10px; } .checkbox-label input { width: auto; transform: scale(1.2); cursor: pointer;}
        .btn-main { background: var(--primary); color: #000; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 800; font-family: 'Cairo'; width: 100%; transition: 0.3s; } .btn-main:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(230,126,34,0.3); }
        .btn-sm { padding: 8px 12px; border-radius: 5px; cursor: pointer; border: none; font-family: 'Cairo'; font-weight: bold; font-size:0.8em; margin: 2px;} .btn-edit { background: var(--info); color: #fff; } .btn-print { background: var(--warning); color: #000; }
        .flex-row { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;} .flex-row > div { flex: 1; min-width: 200px; }
        
        #loader { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; color: var(--primary); }
        .spinner { border: 5px solid #222; border-top: 5px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 15px; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .status-select { background: #333; border: 1px solid #555; color: #fff; padding: 5px; border-radius: 5px; font-family: 'Cairo'; width: auto; font-weight:bold; cursor:pointer;}
        .size-checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-top: 10px; } .size-box { background: #222; border: 1px solid #444; border-radius: 8px; padding: 10px; text-align: center; cursor: pointer; transition: 0.3s; color: #fff; font-weight: bold; user-select: none; } .size-box.selected { background: var(--primary); color: #000; border-color: var(--primary); } .size-box input { display: none; }

        .switch-container { display: flex; justify-content: space-between; align-items: center; background: #111; padding: 15px; border-radius: 8px; border: 1px solid #333; margin-bottom: 15px; }
        .switch-container span { font-weight: bold; color: #fff; font-size: 0.9em;}
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; } .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #444; transition: .4s; border-radius: 34px; } .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; } input:checked + .slider { background-color: var(--success); } input:checked + .slider:before { transform: translateX(24px); }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; overflow-y: auto; backdrop-filter: blur(5px); }
        .modal-content { background: #111; width: 95%; max-width: 900px; border-radius: 20px; padding: 25px; border: 1px solid var(--primary); margin: 30px auto; position: relative; }
        .close-btn { position: absolute; top: 15px; left: 15px; background: #333; color: #fff; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 1.2em; }
        .auto-translate-badge { position: absolute; left: 10px; top: 38px; color: var(--success); font-size: 0.8em; display: none; font-weight:bold; }
    </style>
</head>
<body>

    <canvas id="hidden-barcode" style="display:none;"></canvas>

    <div id="loader"><div class="spinner"></div><h3 id="loader-text">ุฌุงุฑู ุงูุนูู...</h3></div>
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
    
    <aside class="sidebar" id="sidebar">
        <div class="logo-area"><h2>ุณูู ุนูุงุฒ</h2><span style="color:var(--text-muted); font-size:0.8em;">ูุธุงู ุงูุฅุฏุงุฑุฉ ุงูุดุงูู</span></div>
        <button class="nav-btn active" onclick="switchTab('accounting', this)"><i class="fas fa-chart-pie"></i> ุงูุญุณุงุจุงุช ูุงููุงููุงุช</button>
        <button class="nav-btn" onclick="switchTab('orders', this)"><i class="fas fa-box-open"></i> ุฅุฏุงุฑุฉ ุงูุทูุจุงุช</button>
        <button class="nav-btn" onclick="switchTab('inventory', this)"><i class="fas fa-plus-square"></i> ุฅุถุงูุฉ ูููุฎุฒู</button>
        <button class="nav-btn" onclick="switchTab('edit-inventory', this)"><i class="fas fa-edit"></i> ูุฑูุช ุงูุตูู (ุชุนุฏูู)</button>
        <button class="nav-btn" onclick="switchTab('banners', this)"><i class="fas fa-images"></i> ุงูุจุงูุฑุงุช ุงูุฑุฆูุณูุฉ</button>
        <button class="nav-btn" id="nav-templates" onclick="switchTab('templates', this)"><i class="fas fa-ruler-combined"></i> ููุงูุจ ุงูููุงุณุงุช</button>
        <button class="nav-btn" onclick="switchTab('settings', this)"><i class="fas fa-cogs"></i> ุฅุนุฏุงุฏุงุช ุงููุชุฌุฑ</button>
        <button class="nav-btn" onclick="switchTab('shipping', this)"><i class="fas fa-truck"></i> ุชุณุนูุฑ ุงูุดุญู</button>
        <button class="nav-btn" onclick="switchTab('discounts', this)"><i class="fas fa-tags"></i> ุงูููุจููุงุช</button>
    </aside>

    <main class="main-content">
        <div class="mobile-header">
            <h2 style="color:var(--primary); margin:0; font-family:'Reem Kufi';">ุณูู ุนูุงุฒ</h2>
            <button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        </div>

        <section id="accounting" class="section active">
            <div class="flex-row">
                <div style="flex: 2;">
                    <div class="panel">
                        <h2 class="panel-title"><i class="fas fa-wallet"></i> ุงูุฎุฒููุฉ ูุญุฑูุฉ ุงูุฃููุงู (ุงุถุบุท ููุชูุงุตูู)</h2>
                        <div class="stats-grid">
                            <div class="stat-card success" onclick="openReportModal('delivered')"><div class="stat-info"><h3>ุงููุจูุนุงุช (ุชู ุงูุชุณููู)</h3><p id="acc-safe">0 ุฌ.ู</p></div><i class="fas fa-sack-dollar stat-icon"></i></div>
                            <div class="stat-card info" onclick="openReportModal('courier')"><div class="stat-info"><h3>ูุน ุงูููุงุฏูุจ (ุฌุงุฑู)</h3><p id="acc-courier">0 ุฌ.ู</p></div><i class="fas fa-motorcycle stat-icon"></i></div>
                            <div class="stat-card warning" onclick="openReportModal('pending')"><div class="stat-info"><h3>ุฃุฑุจุงุญ (ููุฏ ุงููุฑุงุฌุนุฉ)</h3><p id="acc-pending">0 ุฌ.ู</p></div><i class="fas fa-hourglass-half stat-icon"></i></div>
                        </div>
                        <h2 class="panel-title" style="margin-top:40px;"><i class="fas fa-exclamation-triangle"></i> ุชูุงุฑูุฑ ุงูุฎุณุงุฆุฑ ูุงููุฑุชุฌุนุงุช</h2>
                        <div class="stats-grid">
                            <div class="stat-card danger" onclick="openReportModal('returns')"><div class="stat-info"><h3>ูููุฉ ุงููุฑุชุฌุนุงุช ุงููุฑููุถุฉ</h3><p id="acc-returns">0 ุฌ.ู</p></div><i class="fas fa-undo stat-icon"></i></div>
                            <div class="stat-card danger" onclick="openReportModal('cancelled')"><div class="stat-info"><h3>ูููุฉ ุงูุทูุจุงุช ุงูููุบุงุฉ</h3><p id="acc-cancelled">0 ุฌ.ู</p></div><i class="fas fa-ban stat-icon"></i></div>
                        </div>
                    </div>
                    <div class="panel">
                        <h2 class="panel-title"><i class="fas fa-boxes"></i> ุชูููู ุงููุฎุฒู ุงูุญุงูู</h2>
                        <div class="stats-grid">
                            <div class="stat-card danger" onclick="openReportModal('inventory')"><div class="stat-info"><h3>ุฑุฃุณ ุงููุงู (ุงูุชูููุฉ)</h3><p id="inv-cost">0 ุฌ.ู</p></div><i class="fas fa-file-invoice-dollar stat-icon"></i></div>
                            <div class="stat-card info" onclick="openReportModal('inventory')"><div class="stat-info"><h3>ูููุฉ ุงููุฎุฒู (ุงูุจูุน)</h3><p id="inv-retail">0 ุฌ.ู</p></div><i class="fas fa-tags stat-icon"></i></div>
                        </div>
                    </div>
                </div>

                <div style="flex: 1; min-width: 250px; max-width: 350px;">
                    <div class="panel">
                        <h2 class="panel-title"><i class="fas fa-calculator"></i> ุงูุขูุฉ ุงูุญุงุณุจุฉ</h2>
                        <input type="text" id="calc-display" readonly value="0">
                        <div class="calc-grid">
                            <button class="calc-btn clear" onclick="calcAction('C')">C</button>
                            <button class="calc-btn op" onclick="calcAction('/')">รท</button>
                            <button class="calc-btn op" onclick="calcAction('*')">ร</button>
                            <button class="calc-btn" onclick="calcAction('7')">7</button><button class="calc-btn" onclick="calcAction('8')">8</button><button class="calc-btn" onclick="calcAction('9')">9</button><button class="calc-btn op" onclick="calcAction('-')">-</button>
                            <button class="calc-btn" onclick="calcAction('4')">4</button><button class="calc-btn" onclick="calcAction('5')">5</button><button class="calc-btn" onclick="calcAction('6')">6</button><button class="calc-btn op" onclick="calcAction('+')">+</button>
                            <button class="calc-btn" onclick="calcAction('1')">1</button><button class="calc-btn" onclick="calcAction('2')">2</button><button class="calc-btn" onclick="calcAction('3')">3</button><button class="calc-btn eq" onclick="calcAction('=')">=</button>
                            <button class="calc-btn" onclick="calcAction('0')" style="grid-column: span 2;">0</button><button class="calc-btn" onclick="calcAction('.')">.</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="orders" class="section">
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-list"></i> ูุงุฆูุฉ ุงูุทูุจุงุช ูุงูููุงุชูุฑ</h2>
                <div style="overflow-x:auto;">
                    <table>
                        <thead><tr><th>ุงูุทูุจ</th><th>ุงูุนููู ูุงูููุงู</th><th>ุงูุชูุงุตู</th><th>ุงูููุชุฌุงุช</th><th>ุงูุฅุฌูุงูู</th><th>ุงูุฅุฌุฑุงุกุงุช (ุทุจุงุนุฉ ูุญุงูุฉ)</th></tr></thead>
                        <tbody id="orders-table"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="inventory" class="section">
            <div class="flex-row">
                <div class="panel">
                    <h3 class="panel-title"><i class="fas fa-folder-plus"></i> ุฅุถุงูุฉ ูุณู</h3>
                    <div class="flex-row">
                        <div class="input-group" style="position:relative;">
                            <label>ุงูุงุณู (ุนุฑุจู) *</label>
                            <input type="text" id="cat-title-ar" placeholder="ูุซุงู: ุฃุญุฐูุฉ" onkeyup="smartTranslate(this.value, 'cat-title-en', 'cat-magic')">
                            <i class="fas fa-magic auto-translate-badge" id="cat-magic"></i>
                        </div>
                        <div class="input-group"><label>ุงูุงุณู (ุฅูุฌููุฒู - ุชููุงุฆู)</label><input type="text" id="cat-title-en" placeholder="ูุซุงู: Shoes"></div>
                    </div>
                    <div class="input-group"><label>ูุชุจุน ูุณู ุฑุฆูุณูุ</label><select id="cat-parent-id"></select></div>
                    <div style="background:#222; padding:15px; border-radius:8px; margin-bottom:15px;"><label class="checkbox-label"><input type="checkbox" id="cat-show-home" checked> ุนุฑุถ ูู ุงูุฑุฆูุณูุฉุ</label></div>
                    <button class="btn-main" onclick="addCategory()">ุญูุธ ุงููุณู</button>
                </div>

                <div class="panel">
                    <h3 class="panel-title"><i class="fas fa-box-plus"></i> ุฅุถุงูุฉ ููุชุฌ</h3>
                    <div class="input-group"><label>ุงููุณู ุงููุถุงู ุฅููู *</label><select id="prod-cat"></select></div>
                    <div class="input-group"><label style="color:var(--info);">ููุฏ ุงูููุชุฌ ููุจุญุซ ูุงูุฌุฑุฏ (SKU)</label><input type="text" id="prod-code" placeholder="ูุซุงู: P-001"></div>
                    <div class="flex-row">
                        <div class="input-group" style="position:relative;">
                            <label>ุงุณู ุงูููุชุฌ (ุนุฑุจู) *</label>
                            <input type="text" id="prod-title-ar" placeholder="ูุซุงู: ููุชุดู ุฃููุฑ ุณุงูุฒ ุฃุจูุถ" onblur="smartTranslate(this.value, 'prod-title-en', 'prod-magic')">
                            <i class="fas fa-magic auto-translate-badge" id="prod-magic"></i>
                        </div>
                        <div class="input-group"><label>ุงูุงุณู (ุฅูุฌููุฒู - ุชููุงุฆู)</label><input type="text" id="prod-title-en"></div>
                    </div>
                    <div class="flex-row">
                        <div class="input-group"><label>ุชูููุฉ ุงูุฌููุฉ</label><input type="number" id="prod-cost-price" placeholder="ูุซุงู: 400"></div>
                        <div class="input-group"><label>ุณุนุฑ ุงูุจูุน ุงูููุงุฆู *</label><input type="number" id="prod-price" placeholder="ูุซุงู: 650"></div>
                    </div>
                    <div class="flex-row">
                        <div class="input-group"><label>ุงูุณุนุฑ ุงููุฏูู ุงููุดุทูุจ</label><input type="number" id="prod-old-price" placeholder="ูุซุงู: 800"></div>
                        <div class="input-group"><label>ุงููุฎุฒูู ุงููุชุงุญ</label><input type="number" id="prod-stock" value="100"></div>
                    </div>
                    <div class="input-group"><label style="color:var(--warning);">ุฑุณุงูุฉ ุงูุนุฑุถ (ุงููุฑุจุน ุงูุฃุฒุฑู)</label><input type="text" id="prod-promo-msg" placeholder="ูุซุงู: ุทูู ุดุชูู ุฃู ุจูุทููู + ุณููุช ุดูุฑุช = 1099"></div>
                    <div class="input-group"><label>ุงูุตูุฑุฉ ุงูุฑุฆูุณูุฉ ููููุชุฌ *</label><input type="file" id="prod-image" accept="image/*"></div>
                    
                    <div id="div-clothing-guide" class="flex-row" style="background:#1a1a1a; padding:15px; border:1px dashed var(--primary); border-radius:8px; margin-top:15px;">
                        <h4 style="width:100%; margin-top:0; color:var(--primary); font-size:0.9em; margin-bottom:10px;">ุฌุฏูู ููุงุณุงุช ุงููุทุนุฉ (Size Chart)</h4>
                        <div class="input-group"><label>ูุญูุท ุงูุตุฏุฑ</label><input type="text" id="prod-chest" placeholder="ูุซุงู: 55 ุณู"></div>
                        <div class="input-group"><label>ุนุฑุถ ุงููุชู</label><input type="text" id="prod-shoulder" placeholder="ูุซุงู: 45 ุณู"></div>
                        <div class="input-group"><label>ุทูู ุงููุทุนุฉ</label><input type="text" id="prod-body" placeholder="ูุซุงู: 70 ุณู"></div>
                    </div>
                    <button class="btn-main" onclick="addProduct()" style="margin-top:20px;">ุญูุธ ุงูููุชุฌ</button>
                </div>
            </div>

            <div class="flex-row" style="margin-top:20px;">
                <div class="panel" id="panel-colors">
                    <h3 class="panel-title"><i class="fas fa-palette"></i> ุฑุจุท ููู ุจุตูุฑุฉ ููููุชุฌ</h3>
                    <div class="input-group"><label>ุงูููุชุฌ ุงููุณุชูุฏู</label><select id="color-prod-id"></select></div>
                    <div class="flex-row">
                        <div class="input-group" style="position:relative;">
                            <label>ุงุณู ุงูููู (ุนุฑุจู)</label>
                            <input type="text" id="color-name-ar" placeholder="ูุซุงู: ูุญูู" onblur="smartTranslate(this.value, 'color-name-en', 'color-magic')">
                            <i class="fas fa-magic auto-translate-badge" id="color-magic"></i>
                        </div>
                        <div class="input-group"><label>ุงูููู (ุฅูุฌููุฒู)</label><input type="text" id="color-name-en" placeholder="ูุซุงู: Navy"></div>
                    </div>
                    <div class="input-group"><label>ุงูุฏุฑุฌุฉ ุงูุฏูููุฉ (Hex Code)</label><input type="color" id="color-hex" value="#ff0000" style="height:40px;"></div>
                    <div class="input-group"><label>ุตูุฑุฉ ุงูููุชุฌ ุจูุฐุง ุงูููู *</label><input type="file" id="color-image" accept="image/*"></div>
                    <button class="btn-main" onclick="addColor()" style="background:#3742fa; color:#fff;">ุญูุธ ุงูููู</button>
                </div>

                <div class="panel" id="panel-sizes">
                    <h3 class="panel-title"><i class="fas fa-ruler"></i> ุชุญุฏูุฏ ุงูููุงุณุงุช ุงููุชุงุญุฉ ููููุชุฌ</h3>
                    <div class="input-group"><label>ุงูููุชุฌ ุงููุณุชูุฏู</label><select id="size-prod-id"></select></div>
                    <div class="input-group"><label>ุงุฎุชุฑ ูุงูุจ ููุงุณุงุช ุฌุงูุฒ</label><select id="size-template-select" onchange="loadTemplateOptionsForCheckboxes()"></select></div>
                    <div id="size-checkboxes-container" class="size-checkbox-grid"><p style="color:#888; font-size:0.85em; grid-column: 1 / -1;">ุงุฎุชุฑ ูุงูุจ ูุชุธูุฑ ุงูููุงุณุงุช ุงููุชุงุญุฉ...</p></div>
                    <button class="btn-main" onclick="saveCheckedSizes()" style="background:var(--success); color:#000; margin-top:15px;">ุญูุธ ุงูููุงุณุงุช</button>
                </div>
            </div>
        </section>

        <section id="banners" class="section">
            <div class="panel" style="max-width: 800px; margin: auto;">
                <h2 class="panel-title"><i class="fas fa-images"></i> ุฅุฏุงุฑุฉ ุจุงูุฑุงุช ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ</h2>
                
                <div style="background:#222; padding:20px; border-radius:10px; margin-bottom:20px; border:1px solid #444;">
                    <div class="switch-container" style="background:none; border:none; padding:0; margin-bottom:15px;"><h3 style="color:var(--primary); margin:0;">1. ุงูุจุงูุฑ ุงูุนููู (ูู ุจุฏุงูุฉ ุงููููุน)</h3><label class="switch"><input type="checkbox" id="banner-top-active"><span class="slider"></span></label></div>
                    <div class="input-group"><input type="file" id="banner-top-files" multiple accept="image/*"></div>
                    <button class="btn-main" onclick="saveBanners('top')" style="background:var(--info); color:#fff;">ุฑูุน ูุญูุธ ุงูุจุงูุฑ ุงูุนููู</button>
                </div>
                
                <div style="background:#222; padding:20px; border-radius:10px; margin-bottom:20px; border:1px solid #444;">
                    <div class="switch-container" style="background:none; border:none; padding:0; margin-bottom:15px;"><h3 style="color:var(--primary); margin:0;">2. ุงูุจุงูุฑ ุงูุฃูุณุท (ุจูู ุงูุฃูุณุงู)</h3><label class="switch"><input type="checkbox" id="banner-middle-active"><span class="slider"></span></label></div>
                    <div class="input-group"><input type="file" id="banner-middle-files" multiple accept="image/*"></div>
                    <button class="btn-main" onclick="saveBanners('middle')" style="background:var(--info); color:#fff;">ุฑูุน ูุญูุธ ุงูุจุงูุฑ ุงูุฃูุณุท</button>
                </div>

                <div style="background:#222; padding:20px; border-radius:10px; border:1px solid #444;">
                    <div class="switch-container" style="background:none; border:none; padding:0; margin-bottom:15px;"><h3 style="color:var(--primary); margin:0;">3. ุงูุจุงูุฑ ุงูุณููู (ููู ุงูููุชุฑ)</h3><label class="switch"><input type="checkbox" id="banner-bottom-active"><span class="slider"></span></label></div>
                    <div class="input-group"><input type="file" id="banner-bottom-files" multiple accept="image/*"></div>
                    <button class="btn-main" onclick="saveBanners('bottom')" style="background:var(--info); color:#fff;">ุฑูุน ูุญูุธ ุงูุจุงูุฑ ุงูุณููู</button>
                </div>
            </div>
        </section>

        <section id="edit-inventory" class="section">
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-edit"></i> ูุฑูุช ุงูุตูู ูุชุนุฏูู ุงูููุชุฌุงุช</h2>
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr><th>ุตูุฑุฉ</th><th>ููุฏ (SKU)</th><th>ุงูููุชุฌ (ุนุฑุจู)</th><th>ุงููุณู</th><th>ุงูุจูุน</th><th>ุงููุฎุฒูู ุงููุชุงุญ</th><th>ุฅุฌุฑุงุกุงุช</th></tr>
                        </thead>
                        <tbody id="edit-products-table"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="templates" class="section">
            <div class="panel" style="max-width: 700px; margin: auto;">
                <h2 class="panel-title"><i class="fas fa-layer-group"></i> ุจูุงุก ููุงูุจ ุงูููุงุณุงุช ุงูุฐููุฉ</h2>
                <div class="input-group"><label>ุงุณู ุงููุงูุจ</label><input type="text" id="tpl-name" placeholder="ูุซุงู: ุฃุญุฐูุฉ ุฑุฌุงูู"></div>
                <div class="input-group"><label>ุงูููุงุณุงุช ุงููุชุงุญุฉ (ุงูุตู ุจูุงุตูุฉ , )</label><input type="text" id="tpl-values" placeholder="ูุซุงู: 39, 40, 41, 42"></div>
                <button class="btn-main" onclick="addSizeTemplate()" style="background:var(--info); color:#fff;">ุญูุธ ุงููุงูุจ</button>
                <div id="templates-list" style="margin-top:15px;"></div>
            </div>
        </section>

        <section id="settings" class="section">
            <div class="panel" style="max-width: 700px; margin: auto;">
                <h2 class="panel-title"><i class="fas fa-cogs"></i> ุฅุนุฏุงุฏุงุช ุงููุชุฌุฑ ุงูุฃุณุงุณูุฉ</h2>
                
                <div class="input-group">
                    <label style="color:var(--info);">ุงุณู ุงููููุน (ุงูุจุฑุงูุฏ)</label>
                    <input type="text" id="set-store-name" placeholder="ูุซุงู: IZO Store">
                </div>
                <div class="input-group" style="margin-bottom:25px;">
                    <label style="color:var(--warning);">ุดุฑูุท ุงูุฅุนูุงูุงุช ุงูุนุฑุถู ุฃุนูู ุงููููุน</label>
                    <input type="text" id="set-announcement" placeholder="ูุซุงู: ๐ฅ ุดุญู ูุฌุงูู ูุฃู ุฃูุฑุฏุฑ ููู 1000 ุฌููู ๐ฅ">
                </div>

                <div class="switch-container"><span>ุชูุนูู ุงูุฃุจุนุงุฏ ุงูุตูุจุฉ (ุทููุ ุนุฑุถ)</span><label class="switch"><input type="checkbox" id="set-hard-dim"><span class="slider"></span></label></div>
                <div class="switch-container"><span>ุชูุนูู ุฏููู ููุงุณุงุช ุงูููุงุจุณ</span><label class="switch"><input type="checkbox" id="set-cloth-guide"><span class="slider"></span></label></div>
                <div class="switch-container"><span>ุชูุนูู ูุธุงู ุงูุฃููุงู ููููุชุฌุงุช</span><label class="switch"><input type="checkbox" id="set-colors"><span class="slider"></span></label></div>
                <div class="switch-container"><span>ุชูุนูู ูุธุงู ุงูููุงุณุงุช</span><label class="switch"><input type="checkbox" id="set-sizes"><span class="slider"></span></label></div>
                
                <div style="background:#1a1a1a; border:1px solid var(--info); padding:20px; border-radius:8px; margin-top:20px;">
                    <h3 style="color:var(--info); margin-top:0;">ููุฒุฉ "ูููู ุทููู ุจููุฒุงููุชู"</h3>
                    <div class="switch-container" style="background:none; border:none; padding:0; margin-bottom:10px;">
                        <span>ุชูุนูู ุงูููุฒุฉ ูุนููุงุก ุงููููุน</span>
                        <label class="switch"><input type="checkbox" id="set-bundle-active"><span class="slider"></span></label>
                    </div>
                    <div class="input-group">
                        <label>ุดุฑุงุฆุญ ุงูููุฒุงููุฉ (ุงูุตู ุจูููุง ุจูุงุตูุฉ , )</label>
                        <input type="text" id="set-bundle-tiers" placeholder="ูุซุงู: 1000, 1500, 2000, 3000">
                    </div>
                </div>

                <h3 style="color:var(--primary); margin-top:30px; border-top:1px solid #333; padding-top:20px;">ุดุนุงุฑ ุงููููุน ูุงูู Favicon</h3>
                <div class="flex-row">
                    <div class="input-group" style="background:#222; padding:15px; border-radius:8px; border:1px dashed #555;">
                        <label>ุฃููููุฉ ุงููุชุตูุญ (Favicon) - ุจุฌูุงุฑ ุงููููู</label>
                        <input type="file" id="logo-favicon-file" accept="image/*">
                        <img id="preview-logo-favicon" style="max-height:30px; margin-top:10px; display:none; border-radius:5px;">
                    </div>
                    <div class="input-group" style="background:#222; padding:15px; border-radius:8px; border:1px dashed #555;">
                        <label>ููุฌู ุงููููุน (ุงูููุฏุฑ ูุงูููุชุฑ)</label>
                        <input type="file" id="logo-header-file" accept="image/*">
                        <img id="preview-logo-header" style="max-height:50px; margin-top:10px; display:none; border-radius:5px;">
                    </div>
                </div>

                <button class="btn-main" onclick="saveStoreSettings()" style="margin-top:20px; padding:15px; font-size:1.1em;">ุญูุธ ุงูุฅุนุฏุงุฏุงุช ุจุงููุงูู</button>
            </div>
        </section>

        <section id="shipping" class="section"><div class="panel" style="max-width: 500px; margin: auto;"><h2 class="panel-title">ุชุณุนูุฑุฉ ุงูุดุญู</h2><div class="input-group"><label>ุงููุญุงูุธุฉ</label><select id="ship-city-select" onchange="loadSelectedCityPrice()"></select></div><div class="input-group"><label>ุงูุณุนุฑ (ุฌ.ู)</label><input type="number" id="ship-city-price"></div><button class="btn-main" onclick="updateCityPrice()">ุชุญุฏูุซ</button></div></section>
        <section id="discounts" class="section"><div class="panel" style="max-width: 500px; margin: auto;"><h2 class="panel-title">ุฅุตุฏุงุฑ ููุฏ ุฎุตู</h2><div class="input-group"><label>ููุฏ ุงูุฎุตู</label><input type="text" id="promo-code" style="text-transform: uppercase;"></div><div class="input-group"><label>ุงูุฎุตู (%)</label><input type="number" id="promo-percent"></div><button class="btn-main" onclick="addPromo()">ุชูุนูู</button></div></section>
    </main>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="document.getElementById('edit-modal').style.display='none'"><i class="fas fa-times"></i></button>
            <h2 class="panel-title"><i class="fas fa-edit"></i> ุชุนุฏูู ุจูุงูุงุช ุงูููุชุฌ</h2>
            <input type="hidden" id="edit-prod-id">
            <div class="input-group"><label style="color:var(--info);">ููุฏ ุงูููุชุฌ (SKU)</label><input type="text" id="edit-prod-code"></div>
            <div class="flex-row"><div class="input-group"><label>ุงูุงุณู (ุนุฑุจู)</label><input type="text" id="edit-prod-title-ar"></div><div class="input-group"><label>ุงูุงุณู (ุฅูุฌููุฒู)</label><input type="text" id="edit-prod-title-en"></div></div>
            <div class="flex-row"><div class="input-group"><label>ุณุนุฑ ุงูุฌููุฉ</label><input type="number" id="edit-prod-cost"></div><div class="input-group"><label>ุณุนุฑ ุงููุทุงุนู</label><input type="number" id="edit-prod-price"></div><div class="input-group"><label>ุงููุฎุฒูู</label><input type="number" id="edit-prod-stock"></div></div>
            <button class="btn-main" onclick="saveProductEdit()" style="margin-top:20px;">ุญูุธ ุงูุชุนุฏููุงุช</button>
        </div>
    </div>

    <div id="report-modal" class="modal">
        <div class="modal-content" style="max-width: 850px;">
            <button class="close-btn" onclick="document.getElementById('report-modal').style.display='none'"><i class="fas fa-times"></i></button>
            <h2 class="panel-title" id="report-modal-title">ุชูุฑูุฑ ููุตู</h2>
            <div style="overflow-x:auto; max-height: 400px; border: 1px solid #333; border-radius: 8px;">
                <table><thead id="report-thead"></thead><tbody id="report-tbody"></tbody></table>
            </div>
            <div style="margin-top: 20px; font-weight: 900; color: var(--primary); font-size: 1.4em; padding: 15px; background: #000; border-radius: 8px;" id="report-total-amount"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://wkfiocqhkspsvqgyjpea.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_l2vgR8Xbt0Csw8W_Slo_1Q_9glKlIoN';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let systemSettings = {};
        let globalOrdersData = [];
        let allOrdersDetailed = []; // ูุทุจุงุนุฉ ุงููุงุชูุฑุฉ
        let globalProductsData = [];
        let allProductsEdit = [];
        let allCategoriesEdit = [];
        let calcValue = '';

        function showLoader(t) { document.getElementById('loader-text').innerText = t; document.getElementById('loader').style.display = 'flex'; }
        function hideLoader() { document.getElementById('loader').style.display = 'none'; }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('sidebar-overlay').classList.toggle('active'); }

        async function initAdmin() {
            try {
                showLoader("ุชุญููู ุงููุธุงู...");
                await loadStoreSettingsFromDB();
                await loadBannersStatus();
                switchTab('accounting', document.querySelector('.nav-btn.active'));
            } catch (e) {
                alert("ุชู ุงูุงุชุตุงู. ุฌุงูุฒ ููุนูู.");
            } finally { hideLoader(); }
        }

        function switchTab(tabId, btnElement) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(x => x.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if(btnElement) btnElement.classList.add('active');
            
            document.getElementById('sidebar').classList.remove('active'); 
            document.getElementById('sidebar-overlay').classList.remove('active');
            
            if(tabId === 'inventory') { loadCategoriesForSelects(); loadProductsList(); loadSizeTemplatesDropdown(); }
            if(tabId === 'accounting') loadComprehensiveReports();
            if(tabId === 'orders') loadOrders();
            if(tabId === 'templates') loadTemplatesList();
            if(tabId === 'shipping') loadCitiesForDropdown();
            if(tabId === 'edit-inventory') loadEditInventory();
        }

        async function uploadImage(file) {
            const fName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '')}`;
            await supabaseClient.storage.from('okaz_images').upload(fName, file);
            return supabaseClient.storage.from('okaz_images').getPublicUrl(fName).data.publicUrl;
        }

        // ================= ุงูุขูุฉ ุงูุญุงุณุจุฉ =================
        function calcAction(val) {
            const display = document.getElementById('calc-display');
            if(val === 'C') { calcValue = ''; display.value = '0'; return; }
            if(val === '=') { try { calcValue = eval(calcValue).toString(); display.value = calcValue; } catch(e) { display.value = "Error"; calcValue = ''; } return; }
            calcValue += val; display.value = calcValue;
        }

        // ================= ุงููุชุฑุฌู ุงูุฐูู =================
        async function smartTranslate(text, targetId, badgeId) {
            if(!text || text.length < 2) return;
            const badge = document.getElementById(badgeId); 
            if(badge) { badge.style.display = 'inline-block'; badge.innerText = ' ุงูุชุฑุฌูุฉ...'; }
            
            let dict = { 
                "ุจูุทููู":"Pants", "ุฌููุฒ":"Jeans", "ุชูุดูุฑุช":"T-Shirt", "ุชู ุดูุฑุช":"T-Shirt", "ูููุต":"Shirt", "ุดูุฒ":"Shoes", "ุญุฐุงุก":"Shoes", "ููุชุดู":"Sneakers",
                "ุณููุช ุดูุฑุช":"Sweatshirt", "ููุฏู":"Hoodie", "ุดุฑูุงู":"Joggers", "ูุงูุฏ ููุฌ":"Wide Leg", "ุงููุฑ ุณุงูุฒ":"Oversize", "ูุงุฑุฌู":"Cargo", 
                "ุดูุฑุช":"Shorts", "ุฌุงููุช":"Jacket", "ุณููุจุฑ":"Slippers", "ุญุฒุงู":"Belt", "ูุญูุธุฉ":"Wallet", "ุณุงุฏุฉ":"Basic", "ูุทุจูุน":"Printed", 
                "ูููู":"Striped", "ูุงุฑููุงุช":"Plaid", "ุฃุญูุฑ":"Red", "ุฃุณูุฏ":"Black", "ุงุจูุถ":"White", "ุฃุจูุถ":"White", "ุฃุฒุฑู":"Blue", 
                "ูุญูู":"Navy", "ุจูุฌ":"Beige", "ุฑุตุงุตู":"Grey", "ุฑูุงุฏู":"Grey", "ุฃุฎุถุฑ":"Green", "ุฃุตูุฑ":"Yellow", "ุจูู":"Brown", 
                "ูุงูุงู":"Havana", "ูุจูุชู":"Maroon", "ุฒูุชู":"Olive", "ุจูุจู":"Pink", "ูุฑุฏู":"Pink", "ุจููุณุฌู":"Purple", "ุจุฑุชูุงูู":"Orange"
            };
            let translated = text; 
            for (const [ar, en] of Object.entries(dict)) { translated = translated.replace(new RegExp(ar, 'g'), en); }
            if (/[\u0600-\u06FF]/.test(translated)) {
                try {
                    const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=ar|en`);
                    const data = await res.json(); translated = data.responseData.translatedText;
                } catch(e) {}
            }
            document.getElementById(targetId).value = translated;
            if(badge) { badge.innerText = ' ุชู โ'; setTimeout(()=>badge.style.display='none', 2000); }
        }

        // ================= ุงูุฅุนุฏุงุฏุงุช =================
        async function loadStoreSettingsFromDB() {
            const { data } = await supabaseClient.from('store_settings').select('*');
            if(data) data.forEach(x => systemSettings[x.setting_key] = x.setting_value);
            
            document.getElementById('set-hard-dim').checked = (systemSettings.enable_hard_dimensions === 'true');
            document.getElementById('set-cloth-guide').checked = (systemSettings.enable_clothing_guide === 'true');
            document.getElementById('set-colors').checked = (systemSettings.enable_colors === 'true');
            document.getElementById('set-sizes').checked = (systemSettings.enable_size_templates === 'true');
            
            document.getElementById('div-clothing-guide').style.display = (systemSettings.enable_clothing_guide === 'true') ? 'flex' : 'none';
            document.getElementById('panel-colors').style.display = (systemSettings.enable_colors === 'true') ? 'block' : 'none';
            document.getElementById('panel-sizes').style.display = (systemSettings.enable_size_templates === 'true') ? 'block' : 'none';

            if(document.getElementById('set-store-name')) document.getElementById('set-store-name').value = systemSettings.store_name || '';
            if(document.getElementById('set-announcement')) document.getElementById('set-announcement').value = systemSettings.announcement_text || '';
            if(document.getElementById('set-bundle-active')) document.getElementById('set-bundle-active').checked = (systemSettings.bundle_active === 'true');
            if(document.getElementById('set-bundle-tiers')) document.getElementById('set-bundle-tiers').value = systemSettings.bundle_tiers || '1000, 1500, 2000';

            if(systemSettings.site_favicon) { document.getElementById('preview-logo-favicon').src = systemSettings.site_favicon; document.getElementById('preview-logo-favicon').style.display = 'block'; }
            if(systemSettings.site_logo_header) { document.getElementById('preview-logo-header').src = systemSettings.site_logo_header; document.getElementById('preview-logo-header').style.display = 'block'; }
        }

        async function saveStoreSettings() {
            showLoader("ุญูุธ...");
            try {
                let updates = [
                    { setting_key: 'enable_hard_dimensions', setting_value: document.getElementById('set-hard-dim').checked ? 'true' : 'false' },
                    { setting_key: 'enable_clothing_guide', setting_value: document.getElementById('set-cloth-guide').checked ? 'true' : 'false' },
                    { setting_key: 'enable_colors', setting_value: document.getElementById('set-colors').checked ? 'true' : 'false' },
                    { setting_key: 'enable_size_templates', setting_value: document.getElementById('set-sizes').checked ? 'true' : 'false' },
                    { setting_key: 'store_name', setting_value: document.getElementById('set-store-name').value },
                    { setting_key: 'announcement_text', setting_value: document.getElementById('set-announcement').value },
                    { setting_key: 'bundle_active', setting_value: document.getElementById('set-bundle-active').checked ? 'true' : 'false' },
                    { setting_key: 'bundle_tiers', setting_value: document.getElementById('set-bundle-tiers').value }
                ];
                const favFile = document.getElementById('logo-favicon-file').files[0];
                if(favFile) { const url = await uploadImage(favFile); updates.push({ setting_key: 'site_favicon', setting_value: url }); }
                const headerFile = document.getElementById('logo-header-file').files[0];
                if(headerFile) { const url = await uploadImage(headerFile); updates.push({ setting_key: 'site_logo_header', setting_value: url }); }

                for(let u of updates) { await supabaseClient.from('store_settings').upsert({ setting_key: u.setting_key, setting_value: u.setting_value }); }
                alert("ุชู ุงูุญูุธ โ"); await loadStoreSettingsFromDB();
            } finally { hideLoader(); }
        }

        // ================= ุงูุญุณุงุจุงุช ูุงูุชูุงุฑูุฑ =================
        async function loadComprehensiveReports() {
            const { data: orders } = await supabaseClient.from('orders').select('id, customer_name, grand_total, status, created_at');
            globalOrdersData = orders || [];
            let safe = 0, courier = 0, pending = 0, returns = 0, cancelled = 0;
            if(orders) {
                orders.forEach(o => {
                    const total = Number(o.grand_total) || 0;
                    if(o.status === 'ุชู ุงูุชูุตูู') safe += total;
                    else if(o.status === 'ูุน ุงูููุฏูุจ') courier += total;
                    else if(['ููุฏ ุงููุฑุงุฌุนุฉ', 'ุฌุงุฑู ุงูุชุฌููุฒ'].includes(o.status)) pending += total;
                    else if(o.status === 'ูุฑุชุฌุน') returns += total;
                    else if(o.status === 'ููุบู') cancelled += total;
                });
            }
            document.getElementById('acc-safe').innerText = safe.toFixed(2) + ' ุฌ.ู'; document.getElementById('acc-courier').innerText = courier.toFixed(2) + ' ุฌ.ู'; 
            document.getElementById('acc-pending').innerText = pending.toFixed(2) + ' ุฌ.ู'; document.getElementById('acc-returns').innerText = returns.toFixed(2) + ' ุฌ.ู'; 
            document.getElementById('acc-cancelled').innerText = cancelled.toFixed(2) + ' ุฌ.ู';

            const { data: products } = await supabaseClient.from('products').select('id, title_ar, product_code, price, cost_price, stock_quantity');
            globalProductsData = products || [];
            let invCost = 0, invRetail = 0;
            if(products) { products.forEach(p => { invCost += (p.cost_price||0) * (p.stock_quantity||0); invRetail += (p.price||0) * (p.stock_quantity||0); }); }
            document.getElementById('inv-cost').innerText = invCost.toFixed(2) + ' ุฌ.ู'; document.getElementById('inv-retail').innerText = invRetail.toFixed(2) + ' ุฌ.ู'; 
        }

        function openReportModal(type) {
            const thead = document.getElementById('report-thead'); const tbody = document.getElementById('report-tbody'); 
            const title = document.getElementById('report-modal-title'); const totalDiv = document.getElementById('report-total-amount');
            thead.innerHTML = ''; tbody.innerHTML = ''; let totalSum = 0;

            if (['delivered', 'courier', 'pending', 'returns', 'cancelled'].includes(type)) {
                let statusFilter = [];
                if(type === 'delivered') { statusFilter = ['ุชู ุงูุชูุตูู']; title.innerHTML = 'ุงููุจูุนุงุช'; }
                if(type === 'courier') { statusFilter = ['ูุน ุงูููุฏูุจ']; title.innerHTML = 'ุงูููุงุฏูุจ'; }
                if(type === 'pending') { statusFilter = ['ููุฏ ุงููุฑุงุฌุนุฉ', 'ุฌุงุฑู ุงูุชุฌููุฒ']; title.innerHTML = 'ุชุญุช ุงููุฑุงุฌุนุฉ'; }
                if(type === 'returns') { statusFilter = ['ูุฑุชุฌุน']; title.innerHTML = 'ุงููุฑุชุฌุนุงุช'; }
                if(type === 'cancelled') { statusFilter = ['ููุบู']; title.innerHTML = 'ุงูุทูุจุงุช ุงูููุบุงุฉ'; }

                const filteredOrders = globalOrdersData.filter(o => statusFilter.includes(o.status));
                thead.innerHTML = `<tr><th>ุงูุทูุจ</th><th>ุงูุนููู</th><th>ุงูุชุงุฑูุฎ</th><th>ุงููููุฉ</th></tr>`;
                filteredOrders.forEach(o => {
                    totalSum += Number(o.grand_total); const date = new Date(o.created_at).toLocaleDateString('ar-EG');
                    tbody.innerHTML += `<tr><td style="color:var(--primary);">#OKZ-${o.id.split('-')[0].toUpperCase()}</td><td>${o.customer_name}</td><td>${date}</td><td style="color:var(--success);">${o.grand_total} ุฌ.ู</td></tr>`;
                });
                totalDiv.innerHTML = `ุงูุฅุฌูุงูู: <span>${totalSum.toFixed(2)} ุฌ.ู</span>`;
            } else if (type === 'inventory') {
                title.innerHTML = 'ุฌุฑุฏ ุงููุฎุฒู';
                thead.innerHTML = `<tr><th>SKU</th><th>ุงูููุชุฌ</th><th>ุงููููุฉ</th><th>ุงูุชูููุฉ</th><th>ุงูุจูุน</th></tr>`;
                globalProductsData.forEach(p => {
                    tbody.innerHTML += `<tr><td style="color:#aaa;">${p.product_code||'-'}</td><td>${p.title_ar}</td><td><b>${p.stock_quantity}</b></td><td style="color:var(--danger);">${p.cost_price} ุฌ</td><td style="color:var(--info);">${p.price} ุฌ</td></tr>`;
                });
            }
            document.getElementById('report-modal').style.display = 'block';
        }

        // ================= ุงูุฅุถุงูุฉ ูููุฎุฒู =================
        async function loadCategoriesForSelects() { const {data} = await supabaseClient.from('categories').select('*'); const html='<option value="">-- ุงุฎุชุฑ ุงููุณู --</option>'+data.map(x=>`<option value="${x.id}">${x.title_ar}</option>`).join(''); document.getElementById('prod-cat').innerHTML=html; document.getElementById('cat-parent-id').innerHTML='<option value="">-- ูุณู ุฑุฆูุณู ูุณุชูู --</option>'+html; }
        async function loadProductsList() { const {data} = await supabaseClient.from('products').select('id, title_ar'); const html='<option value="">-- ุงุฎุชุฑ ุงูููุชุฌ --</option>'+data.map(x=>`<option value="${x.id}">${x.title_ar}</option>`).join(''); document.getElementById('color-prod-id').innerHTML=html; document.getElementById('size-prod-id').innerHTML=html; }
        async function addCategory() { const tar=document.getElementById('cat-title-ar').value, ten=document.getElementById('cat-title-en').value, pid=document.getElementById('cat-parent-id').value||null, shw=document.getElementById('cat-show-home').checked; if(!tar)return alert("ุงูุงุณู ุจุงูุนุฑุจู!"); showLoader("ุญูุธ..."); await supabaseClient.from('categories').insert([{title_ar:tar, title_en:ten, parent_id:pid, show_on_home:shw}]); hideLoader(); loadCategoriesForSelects(); alert("ุชู ุฅุถุงูุฉ ุงููุณู"); document.getElementById('cat-title-ar').value=''; }
        
        async function addProduct() {
            const cid=document.getElementById('prod-cat').value, tar=document.getElementById('prod-title-ar').value, prc=document.getElementById('prod-price').value, file=document.getElementById('prod-image');
            if(!cid||!tar||!prc||file.files.length===0) return alert("ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ!"); showLoader("ุฑูุน...");
            try {
                const img = await uploadImage(file.files[0]);
                await supabaseClient.from('products').insert([{ category_id: cid, product_code: document.getElementById('prod-code').value, title_ar: tar, title_en: document.getElementById('prod-title-en').value, price: prc, old_price: document.getElementById('prod-old-price').value||0, promo_message: document.getElementById('prod-promo-msg').value||'', cost_price: document.getElementById('prod-cost-price').value||0, stock_quantity: document.getElementById('prod-stock').value||100, image: img, chest_cm: document.getElementById('prod-chest')?.value||'', shoulder_cm: document.getElementById('prod-shoulder')?.value||'', body_length_cm: document.getElementById('prod-body')?.value||'' }]);
                alert("ุชู ุงูุฅุถุงูุฉ! ๐ฆ"); document.getElementById('prod-title-ar').value=''; loadProductsList();
            } finally { hideLoader(); }
        }

        async function addColor() { const pid=document.getElementById('color-prod-id').value, file=document.getElementById('color-image'); if(!pid||file.files.length===0) return alert("ุงุฎุชุฑ!"); showLoader("ุญูุธ..."); const img=await uploadImage(file.files[0]); await supabaseClient.from('product_colors').insert([{product_id:pid, color_name_ar:document.getElementById('color-name-ar').value, color_name_en:document.getElementById('color-name-en').value, color_hex:document.getElementById('color-hex').value, image_url:img}]); hideLoader(); alert("ุชู ุฑุจุท ุงูููู!"); }
        
        // ================= ุงูููุงูุจ =================
        async function loadSizeTemplatesDropdown() { const {data}=await supabaseClient.from('size_templates').select('*'); document.getElementById('size-template-select').innerHTML='<option value="">-- ุงุฎุชุฑ ุงููุงูุจ --</option>'+data.map(x=>`<option value="${x.id}">${x.template_name}</option>`).join(''); }
        async function loadTemplateOptionsForCheckboxes() { const id=document.getElementById('size-template-select').value; const cont=document.getElementById('size-checkboxes-container'); cont.innerHTML=''; if(!id) return; const {data}=await supabaseClient.from('size_template_options').select('*').eq('template_id',id); if(data) data.forEach(o=>{ cont.innerHTML+=`<label class="size-box" onclick="this.classList.toggle('selected')">${o.size_value}<input type="checkbox" value="${o.size_value}"></label>`; }); }
        async function saveCheckedSizes() { const pId=document.getElementById('size-prod-id').value, chks=document.querySelectorAll('.size-box.selected input'); if(!pId||chks.length===0)return alert("ุงุฎุชุฑ!"); showLoader("ุญูุธ..."); const d=Array.from(chks).map(c=>({product_id:pId, size_name:c.value})); await supabaseClient.from('product_sizes').insert(d); hideLoader(); alert("ุชู ุญูุธ ุงูููุงุณุงุช!"); document.querySelectorAll('.size-box').forEach(b=>b.classList.remove('selected')); }
        async function addSizeTemplate() { const n = document.getElementById('tpl-name').value, v = document.getElementById('tpl-values').value; if(!n || !v) return; showLoader("ุญูุธ..."); try { const arr = v.split(',').map(s=>s.trim()).filter(s=>s!==''); const {data:tpl} = await supabaseClient.from('size_templates').insert([{template_name: n}]).select(); if(tpl) { const opts = arr.map(x=>({template_id: tpl[0].id, size_value: x})); await supabaseClient.from('size_template_options').insert(opts); alert("ุชู ุงููุงูุจ โ"); loadTemplatesList(); } } finally { hideLoader(); } }
        async function loadTemplatesList() { const {data} = await supabaseClient.from('size_templates').select('*, size_template_options(size_value)'); const list = document.getElementById('templates-list'); list.innerHTML=''; if(data) { data.forEach(t => { list.innerHTML += `<div style="background:#222; padding:10px; border-radius:8px; margin-bottom:10px;"><strong style="color:var(--primary);">${t.template_name}</strong><div style="color:#aaa; font-size:0.9em;">[ ${t.size_template_options.map(o=>o.size_value).join(' - ')} ]</div></div>`; }); } }

        // ================= ูุฑูุช ุงูุตูู ูุทุจุงุนุฉ ุงูุจุงุฑููุฏ ๐ท๏ธ =================
        async function loadEditInventory() { 
            showLoader("ุณุญุจ ุจูุงูุงุช ุงููุฎุฒู..."); 
            try {
                const [pReq, cReq] = await Promise.all([supabaseClient.from('products').select('*').order('created_at',{ascending:false}), supabaseClient.from('categories').select('id, title_ar')]); 
                allProductsEdit = pReq.data||[]; allCategoriesEdit = cReq.data||[]; 
                const tbody = document.getElementById('edit-products-table'); tbody.innerHTML=''; 
                allProductsEdit.forEach(p=>{ 
                    const cName = allCategoriesEdit.find(c=>c.id===p.category_id)?.title_ar||'ุบูุฑ ูุญุฏุฏ'; 
                    tbody.innerHTML+=`<tr>
                        <td><img src="${p.image}" style="width:40px;height:40px;border-radius:5px;object-fit:cover;"></td>
                        <td style="color:#aaa; font-weight:bold;">${p.product_code || '-'}</td>
                        <td style="font-weight:bold;">${p.title_ar}</td><td>${cName}</td>
                        <td style="color:var(--primary); font-weight:bold;">${p.price} ุฌ.ู</td>
                        <td><b>${p.stock_quantity}</b></td>
                        <td>
                            <button class="btn-sm btn-edit" onclick="openEditModal('${p.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn-sm btn-print" onclick="printBarcode('${p.id}')"><i class="fas fa-barcode"></i> ุจุงุฑููุฏ</button>
                        </td>
                    </tr>`; 
                }); 
            } finally { hideLoader(); }
        }
        function openEditModal(id) { const p=allProductsEdit.find(x=>x.id===id); if(p){ document.getElementById('edit-prod-id').value=p.id; document.getElementById('edit-prod-code').value=p.product_code || ''; document.getElementById('edit-prod-title-ar').value=p.title_ar; document.getElementById('edit-prod-title-en').value=p.title_en; document.getElementById('edit-prod-cost').value=p.cost_price; document.getElementById('edit-prod-price').value=p.price; document.getElementById('edit-prod-stock').value=p.stock_quantity; document.getElementById('edit-modal').style.display='block'; } }
        async function saveProductEdit() { showLoader("ุฌุงุฑู ุงูุญูุธ..."); await supabaseClient.from('products').update({product_code: document.getElementById('edit-prod-code').value, title_ar:document.getElementById('edit-prod-title-ar').value, title_en:document.getElementById('edit-prod-title-en').value, cost_price:document.getElementById('edit-prod-cost').value, price:document.getElementById('edit-prod-price').value, stock_quantity:document.getElementById('edit-prod-stock').value}).eq('id', document.getElementById('edit-prod-id').value); alert("ุชู ุงูุชุญุฏูุซ โ"); document.getElementById('edit-modal').style.display='none'; loadEditInventory(); hideLoader(); }

        // ุทุจุงุนุฉ ุงูุจุงุฑููุฏ (Xprinter / Label Printer)
        function printBarcode(id) {
            const p = allProductsEdit.find(x => x.id === id);
            if(!p) return;
            const codeToPrint = p.product_code || p.id.split('-')[0].toUpperCase();
            const storeName = systemSettings.store_name || 'ุณูู ุนูุงุฒ';
            
            // ุชูููุฏ ุงูุจุงุฑููุฏ ูู ุงูู Canvas ุงููุฎูู
            JsBarcode("#hidden-barcode", codeToPrint, { format: "CODE128", displayValue: true, fontSize: 16, margin: 5 });
            const canvas = document.getElementById('hidden-barcode');
            const barcodeImg = canvas.toDataURL("image/png");

            const html = `
                <div style="width: 5cm; text-align: center; font-family: 'Cairo', sans-serif; color: #000; padding: 5px; box-sizing: border-box;">
                    <div style="font-weight: 900; font-size: 14px; margin-bottom: 2px;">${storeName}</div>
                    <div style="font-size: 12px; margin-bottom: 5px; max-height: 18px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${p.title_ar}</div>
                    <div style="font-weight: 900; font-size: 18px; margin-bottom: 5px;">${p.price} EGP</div>
                    <img src="${barcodeImg}" style="max-width: 100%; height: auto;">
                </div>
            `;
            printHTMLWindow(html);
        }

        // ================= ุงูุทูุจุงุช ูุงูุจุงูุฑุงุช ูุงูููุงุชูุฑ ๐งพ =================
        async function loadOrders() { 
            const {data} = await supabaseClient.from('orders').select('*, order_items(*)').order('created_at',{ascending:false}); 
            allOrdersDetailed = data || []; // ุญูุธูุง ูุทุจุงุนุฉ ุงููุงุชูุฑุฉ
            const tbody = document.getElementById('orders-table'); tbody.innerHTML=''; 
            if(data){ 
                data.forEach(o=>{ 
                    const st=o.status; const sColor=st==='ุชู ุงูุชูุตูู'?'var(--success)':['ููุบู','ูุฑุชุฌุน'].includes(st)?'var(--danger)':'#fff'; 
                    const sel=`<select class="status-select" style="color:${sColor}; border-color:${sColor}; width:100%; margin-bottom:5px;" onchange="updateOrderStatus('${o.id}', this.value)">`+['ููุฏ ุงููุฑุงุฌุนุฉ','ุฌุงุฑู ุงูุชุฌููุฒ','ูุน ุงูููุฏูุจ','ุชู ุงูุชูุตูู','ููุบู','ูุฑุชุฌุน'].map(s=>`<option ${st===s?'selected':''}>${s}</option>`).join('')+'</select>'; 
                    
                    const printBtn = `<button class="btn-sm" style="background:#555; color:#fff; width:100%;" onclick="printInvoice('${o.id}')"><i class="fas fa-print"></i> ูุงุชูุฑุฉ</button>`;

                    let loc = `${o.customer_city} - ${o.customer_area} <br><small style="color:#aaa;">ุด: ${o.customer_street} / ุนู: ${o.customer_building} / ุด: ${o.customer_apartment}</small>`;

                    tbody.innerHTML+=`<tr>
                        <td style="color:var(--primary); font-weight:bold;">#OKZ-${o.id.split('-')[0].toUpperCase()}</td>
                        <td style="font-weight:bold;">${o.customer_name}<br>${loc}</td>
                        <td>${o.customer_phone}</td>
                        <td>${o.order_items.map(i=>`- ${i.product_name} (${i.selected_color || ''} | ${i.selected_size || ''}) <b style="color:#fff">x${i.quantity}</b>`).join('<br>')}</td>
                        <td style="color:var(--success); font-weight:bold; font-size:1.1em;">${o.grand_total} ุฌ.ู</td>
                        <td>${sel} ${printBtn}</td>
                    </tr>`; 
                }); 
            } 
        }
        
        async function updateOrderStatus(id, status) { showLoader("ุชุญุฏูุซ ุงูุญุงูุฉ..."); await supabaseClient.from('orders').update({status}).eq('id',id); hideLoader(); loadOrders(); loadComprehensiveReports();}

        // ุทุจุงุนุฉ ุจูููุตุฉ ุงูุดุญู / ุงููุงุชูุฑุฉ (ูู A4 ู Xprinter)
        function printInvoice(id) {
            const o = allOrdersDetailed.find(x => x.id === id);
            if(!o) return;
            const storeName = systemSettings.store_name || 'ุณูู ุนูุงุฒ';
            const date = new Date(o.created_at).toLocaleString('ar-EG');
            const shortId = o.id.split('-')[0].toUpperCase();
            
            let itemsHtml = '';
            o.order_items.forEach(i => {
                itemsHtml += `<tr>
                    <td style="text-align:right; padding:5px; border-bottom:1px dashed #ccc;">${i.product_name} (${i.selected_size || ''} ${i.selected_color || ''})</td>
                    <td style="text-align:center; padding:5px; border-bottom:1px dashed #ccc;">${i.quantity}</td>
                    <td style="text-align:left; padding:5px; border-bottom:1px dashed #ccc;">${i.price}</td>
                </tr>`;
            });

            const html = `
                <div style="max-width: 80mm; margin: 0 auto; font-family: 'Cairo', sans-serif; direction: rtl; text-align: center; color: #000; padding: 10px;">
                    <h2 style="margin: 5px 0; font-size: 24px;">${storeName}</h2>
                    <p style="margin: 0; font-size: 14px; font-weight:bold;">ูุงุชูุฑุฉ ุทูุจ #OKZ-${shortId}</p>
                    <p style="margin: 0; font-size: 12px; margin-bottom: 15px; color: #555;">ุงูุชุงุฑูุฎ: ${date}</p>
                    
                    <div style="border-top: 2px dashed #000; border-bottom: 2px dashed #000; padding: 10px 0; text-align: right; font-size: 14px; line-height: 1.6;">
                        <div><b>ุงูุนููู:</b> ${o.customer_name}</div>
                        <div><b>ุงูููุจุงูู:</b> ${o.customer_phone}</div>
                        <div><b>ุงูุนููุงู:</b> ${o.customer_city} - ${o.customer_area}</div>
                        <div style="font-size:12px;">ุดุงุฑุน: ${o.customer_street}, ุนูุงุฑุฉ: ${o.customer_building}, ุดูุฉ: ${o.customer_apartment}</div>
                        ${o.customer_landmark ? `<div style="font-size:12px;">ุนูุงูุฉ ูููุฒุฉ: ${o.customer_landmark}</div>` : ''}
                    </div>

                    <table style="width: 100%; margin-top: 15px; font-size: 14px; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid #000;">
                                <th style="text-align:right; padding-bottom:5px;">ุงูุตูู</th>
                                <th style="text-align:center; padding-bottom:5px;">ุงููููุฉ</th>
                                <th style="text-align:left; padding-bottom:5px;">ุงูุณุนุฑ</th>
                            </tr>
                        </thead>
                        <tbody>${itemsHtml}</tbody>
                    </table>
                    
                    <div style="border-top: 2px solid #000; margin-top: 15px; padding-top: 10px; text-align: left; font-size: 14px; line-height: 1.6;">
                        <div>ุงููุฌููุน: ${o.total_items_price} ุฌ.ู</div>
                        <div>ูุตุงุฑูู ุงูุดุญู: ${o.shipping_cost} ุฌ.ู</div>
                        ${Number(o.discount_amount) > 0 ? `<div style="color:red;">ุงูุฎุตู ุงููุทุจู: -${o.discount_amount} ุฌ.ู</div>` : ''}
                        <h3 style="margin: 10px 0; font-size: 20px; font-weight: 900; background: #eee; padding: 5px; text-align: center; border: 2px dashed #000;">ุงููุทููุจ ุฏูุนู: ${o.grand_total} ุฌ.ู</h3>
                    </div>
                    
                    <p style="margin-top: 20px; font-size: 14px; text-align: center; font-weight: bold;">ุดูุฑุงู ูุชุณูููู ูุนูุง!</p>
                </div>
            `;
            printHTMLWindow(html);
        }

        // ูุญุฑู ุงูุทุจุงุนุฉ (ููุชุญ ูุงูุฐุฉ ูุฎููุฉ ููุทุจุน ุจุฏูู ุงูุชุฃุซูุฑ ุนูู ุงูููุญุฉ)
        function printHTMLWindow(htmlContent) {
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            iframe.contentWindow.document.open();
            iframe.contentWindow.document.write(`
                <html dir="rtl">
                <head>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Cairo', sans-serif; padding: 0; margin: 0; color: #000; }
                        @media print { 
                            @page { margin: 0; }
                            body { margin: 0.5cm; }
                        }
                    </style>
                </head>
                <body>${htmlContent}</body>
                </html>
            `);
            iframe.contentWindow.document.close();
            
            // ููุชุธุฑ ุซุงููุฉ ุนุดุงู ุงููููุช ูุญูู ูุงูุจุงุฑููุฏ ูุชุฑุณู
            setTimeout(() => {
                iframe.contentWindow.focus();
                iframe.contentWindow.print();
                setTimeout(() => document.body.removeChild(iframe), 1000);
            }, 1000);
        }
        
        async function loadBannersStatus() { const {data}=await supabaseClient.from('store_banners').select('*'); if(data) data.forEach(b=>{ const c=document.getElementById(`banner-${b.position_name}-active`); if(c) c.checked=b.is_active; }); }
        async function saveBanners(pos) { const isActive=document.getElementById(`banner-${pos}-active`).checked, files=document.getElementById(`banner-${pos}-files`).files; showLoader(`ุฌุงุฑู ุชุญุฏูุซ ุงูุจุงูุฑ ุงูู ${pos}...`); try { let updates={is_active:isActive}; if(files.length>0){ let urls=[]; for(let i=0;i<files.length;i++)urls.push(await uploadImage(files[i])); updates.images=urls; } await supabaseClient.from('store_banners').update(updates).eq('position_name',pos); alert("ุชู ุงูุชุญุฏูุซ! โ"); } finally { hideLoader(); } }
        async function loadCitiesForDropdown() { const {data}=await supabaseClient.from('shipping_rules').select('*').order('city_ar'); const sel=document.getElementById('ship-city-select'); sel.innerHTML='<option value="">-- ุงููุญุงูุธุฉ --</option>'; data.forEach(c=>sel.innerHTML+=`<option value="${c.id}">${c.city_ar}</option>`); }
        function loadSelectedCityPrice() { const id=document.getElementById('ship-city-select').value; supabaseClient.from('shipping_rules').select('cost').eq('id',id).single().then(r=>document.getElementById('ship-city-price').value=r.data.cost); }
        async function updateCityPrice() { await supabaseClient.from('shipping_rules').update({cost:document.getElementById('ship-city-price').value}).eq('id',document.getElementById('ship-city-select').value); alert("ุชู ุงูุชุนุฏูู ๐"); }
        async function addPromo() { await supabaseClient.from('promo_codes').insert([{ code:document.getElementById('promo-code').value.toUpperCase(), discount_percentage:document.getElementById('promo-percent').value }]); alert("ุชู ุชูุนูู ุงูููุจูู ๐ธ"); }

        initAdmin();
    </script>
</body>
</html>
