<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÙˆÙ‚ Ø¹ÙƒØ§Ø² | Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #e67e22; --dark: #0a0a0a; --sidebar: #121212; --card: #1a1a1a; --text: #f1f2f6; --text-muted: #a4b0be; --danger: #ff4757; --success: #2ed573; --info: #3742fa; --warning: #ffa502; }
        body { font-family: 'Cairo', sans-serif; background: var(--dark); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 260px; background: var(--sidebar); border-left: 1px solid #222; display: flex; flex-direction: column; padding: 20px 0; box-shadow: -5px 0 15px rgba(0,0,0,0.5); z-index: 100; overflow-y:auto; }
        .logo-area { text-align: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #222; }
        .logo-area h2 { color: var(--primary); margin: 0; font-weight: 900; }
        .nav-btn { display: flex; align-items: center; gap: 15px; padding: 15px 25px; color: var(--text-muted); cursor: pointer; transition: 0.3s; border-right: 4px solid transparent; font-size: 1.1em; font-weight: 600; background: none; border: none; width: 100%; text-align: right; }
        .nav-btn:hover, .nav-btn.active { background: #1f1f1f; color: var(--primary); border-right-color: var(--primary); }
        .nav-btn i { font-size: 1.2em; width: 25px; text-align: center; }

        .main-content { flex: 1; padding: 30px; overflow-y: auto; background: var(--dark); }
        .section { display: none; animation: fadeIn 0.4s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #222; display: flex; align-items: center; gap: 15px; position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; right: 0; top: 0; height: 100%; width: 4px; background: var(--primary); }
        .stat-card.success::before { background: var(--success); } .stat-card.info::before { background: var(--info); } .stat-card.danger::before { background: var(--danger); }
        .stat-icon { font-size: 2em; color: rgba(255, 255, 255, 0.05); }
        .stat-info h3 { margin: 0; font-size: 0.85em; color: var(--text-muted); }
        .stat-info p { margin: 5px 0 0; font-size: 1.5em; font-weight: 900; color: #fff; }

        .panel { background: var(--card); padding: 25px; border-radius: 15px; border: 1px solid #222; margin-bottom: 20px; }
        .panel-title { color: var(--primary); margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 20px; font-size: 1.2em; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        th { background: #111; color: var(--text-muted); padding: 12px; text-align: right; border-bottom: 2px solid #222; }
        td { padding: 12px; border-bottom: 1px solid #222; color: #eee; }
        
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 6px; color: var(--text-muted); font-size: 0.85em; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #333; background: #111; color: #fff; font-family: 'Cairo'; outline: none; box-sizing: border-box;}
        input[type="file"] { padding: 6px; background: #222; cursor: pointer; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); }
        .checkbox-label { display: flex; align-items: center; gap: 10px; cursor: pointer; color: #fff; font-size: 0.9em; margin-bottom: 10px; }
        .checkbox-label input { width: auto; transform: scale(1.2); }
        
        .btn-main { background: var(--primary); color: #000; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 800; font-family: 'Cairo'; width: 100%; transition: 0.3s; }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(230,126,34,0.3); }
        .btn-sm { padding: 5px 10px; border-radius: 5px; cursor: pointer; border: none; font-family: 'Cairo'; font-weight: bold; font-size:0.8em; }
        .btn-edit { background: var(--info); color: #fff; } .btn-delete { background: var(--danger); color: #fff; }
        
        .flex-row { display: flex; gap: 15px; flex-wrap: wrap; }
        .flex-row > div { flex: 1; min-width: 200px; }
        
        #loader { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; color: var(--primary); }
        .spinner { border: 5px solid #222; border-top: 5px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .status-select { background: #333; border: 1px solid #555; color: #fff; padding: 5px; border-radius: 5px; font-family: 'Cairo'; width: auto; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; overflow-y: auto; backdrop-filter: blur(5px); }
        .modal-content { background: #111; width: 95%; max-width: 700px; border-radius: 20px; padding: 25px; border: 1px solid var(--primary); margin: 30px auto; position: relative; }
        .close-btn { position: absolute; top: 15px; left: 15px; background: #333; color: #fff; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 1.2em; }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div><h3 id="loader-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„...</h3></div>

    <aside class="sidebar">
        <div class="logo-area"><h2>Ø³ÙˆÙ‚ Ø¹ÙƒØ§Ø² ğŸ¦…</h2><span style="color:var(--text-muted); font-size:0.8em;">Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</span></div>
        <button class="nav-btn active" onclick="switchTab('accounting', this)"><i class="fas fa-chart-pie"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</button>
        <button class="nav-btn" onclick="switchTab('orders', this)"><i class="fas fa-box-open"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
        <button class="nav-btn" onclick="switchTab('inventory', this)"><i class="fas fa-plus-square"></i> Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø®Ø²Ù†</button>
        <button class="nav-btn" onclick="switchTab('edit-inventory', this)"><i class="fas fa-edit"></i> ÙƒØ±ÙˆØª Ø§Ù„ØµÙ†Ù (ØªØ¹Ø¯ÙŠÙ„)</button>
        <button class="nav-btn" onclick="switchTab('shipping', this)"><i class="fas fa-truck"></i> ØªØ³Ø¹ÙŠØ± Ø§Ù„Ø´Ø­Ù†</button>
        <button class="nav-btn" onclick="switchTab('discounts', this)"><i class="fas fa-tags"></i> Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª</button>
    </aside>

    <main class="main-content">
        <section id="accounting" class="section active">
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-wallet"></i> Ø§Ù„Ø®Ø²ÙŠÙ†Ø© ÙˆØ­Ø±ÙƒØ© Ø§Ù„Ø£Ù…ÙˆØ§Ù„</h2>
                <div class="stats-grid">
                    <div class="stat-card success"><i class="fas fa-lock stat-icon"></i><div class="stat-info"><h3>Ø®Ø²ÙŠÙ†Ø© (Ù…ÙØ³Ù„Ù…Ø©)</h3><p id="acc-safe">0 Ø¬.Ù…</p></div></div>
                    <div class="stat-card info"><i class="fas fa-motorcycle stat-icon"></i><div class="stat-info"><h3>Ù…Ø¹ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</h3><p id="acc-courier">0 Ø¬.Ù…</p></div></div>
                    <div class="stat-card"><i class="fas fa-clock stat-icon"></i><div class="stat-info"><h3>ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h3><p id="acc-pending">0 Ø¬.Ù…</p></div></div>
                    <div class="stat-card danger"><i class="fas fa-hand-holding-usd stat-icon"></i><div class="stat-info"><h3>Ø®ØµÙˆÙ…Ø§Øª Ù…Ù…Ù†ÙˆØ­Ø©</h3><p id="acc-discounts">0 Ø¬.Ù…</p></div></div>
                </div>
            </div>
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-boxes"></i> ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø²Ù†</h2>
                <div class="stats-grid">
                    <div class="stat-card danger"><i class="fas fa-boxes stat-icon"></i><div class="stat-info"><h3>Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ (ØªÙƒÙ„ÙØ©)</h3><p id="inv-cost">0 Ø¬.Ù…</p></div></div>
                    <div class="stat-card info"><i class="fas fa-tags stat-icon"></i><div class="stat-info"><h3>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© (Ø¨ÙŠØ¹)</h3><p id="inv-retail">0 Ø¬.Ù…</p></div></div>
                    <div class="stat-card success"><i class="fas fa-chart-line stat-icon"></i><div class="stat-info"><h3>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</h3><p id="inv-profit">0 Ø¬.Ù…</p></div></div>
                </div>
            </div>
        </section>

        <section id="orders" class="section">
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-list"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
                <div style="overflow-x:auto;">
                    <table>
                        <thead><tr><th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</th><th>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
                        <tbody id="orders-table"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="inventory" class="section">
            <div class="flex-row">
                <div class="panel">
                    <h3 class="panel-title"><i class="fas fa-folder-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… (Ø¹Ø±Ø¨ÙŠ/Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</h3>
                    <div class="flex-row">
                        <div class="input-group"><label>Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… (Ø¹Ø±Ø¨ÙŠ) *</label><input type="text" id="cat-title-ar" placeholder="Ù…Ø«Ø§Ù„: Ù‚Ù…ØµØ§Ù†"></div>
                        <div class="input-group"><label>Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label><input type="text" id="cat-title-en" placeholder="Ù…Ø«Ø§Ù„: Shirts"></div>
                    </div>
                    <div class="input-group">
                        <label>ÙŠØªØ¨Ø¹ Ù‚Ø³Ù… Ø±Ø¦ÙŠØ³ÙŠØŸ (Ø§Ø®ØªØ± Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ø°Ø§ Ù‚Ø³Ù… ÙØ±Ø¹ÙŠ)</label>
                        <select id="cat-parent-id"><option value="">-- Ù‡Ø°Ø§ Ù‚Ø³Ù… Ø±Ø¦ÙŠØ³ÙŠ Ù…Ø³ØªÙ‚Ù„ --</option></select>
                    </div>
                    
                    <div style="background:#222; padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid #333;">
                        <h4 style="margin-top:0; color:var(--primary); font-size:0.9em;">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¸Ù‡ÙˆØ±</h4>
                        <label class="checkbox-label"><input type="checkbox" id="cat-show-home" checked> Ø¹Ø±Ø¶ Ù…Ù†ØªØ¬Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙƒØ´Ø±ÙŠØ·ØŸ</label>
                        <div class="input-group"><label>ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¸Ù‡ÙˆØ± ÙÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø±Ù‚Ù…)</label><input type="number" id="cat-home-order" value="1"></div>
                        <label class="checkbox-label"><input type="checkbox" id="cat-allow-bundle"> Ø¥ØªØ§Ø­Ø© Ù…Ù†ØªØ¬Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ÙÙŠ Ù…ÙŠØ²Ø© "ÙƒÙˆÙ‘Ù† Ø·Ù‚Ù…Ùƒ Ø¨Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ"ØŸ</label>
                    </div>

                    <div class="input-group"><label>ØµÙˆØ± Ø§Ù„Ù‚Ø³Ù… (Ù„Ù„Ø³Ù„Ø§ÙŠØ¯Ø±)</label><input type="file" id="cat-images" multiple accept="image/*"></div>
                    <button class="btn-main" onclick="addCategory()">Ø­ÙØ¸ Ø§Ù„Ù‚Ø³Ù…</button>
                </div>

                <div class="panel">
                    <h3 class="panel-title"><i class="fas fa-box-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</h3>
                    <div class="input-group"><label>Ø§Ù„Ù‚Ø³Ù… *</label><select id="prod-cat"></select></div>
                    <div class="flex-row">
                        <div class="input-group"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ø¹Ø±Ø¨ÙŠ) *</label><input type="text" id="prod-title-ar"></div>
                        <div class="input-group"><label>Ø§Ù„Ø§Ø³Ù… (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label><input type="text" id="prod-title-en"></div>
                    </div>
                    <div class="flex-row">
                        <div class="input-group"><label>ÙˆØµÙ (Ø¹Ø±Ø¨ÙŠ)</label><textarea id="prod-desc-ar" rows="2"></textarea></div>
                        <div class="input-group"><label>ÙˆØµÙ (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label><textarea id="prod-desc-en" rows="2"></textarea></div>
                    </div>
                    <div class="flex-row">
                        <div class="input-group"><label>Ø§Ù„ØªÙƒÙ„ÙØ© (Ø¬Ù…Ù„Ø©)</label><input type="number" id="prod-cost-price" value="0"></div>
                        <div class="input-group"><label>Ø§Ù„Ø¨ÙŠØ¹ (Ù‚Ø·Ø§Ø¹ÙŠ) *</label><input type="number" id="prod-price"></div>
                        <div class="input-group"><label>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</label><input type="number" id="prod-stock" value="100"></div>
                    </div>
                    <div class="flex-row">
                        <div class="input-group"><label>Ø¹Ù„Ø§Ù…Ø© Ø¹Ø±Ø¨ÙŠ</label><input type="text" id="prod-badge-ar" placeholder="ğŸ”¥ Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ø§Ù‹"></div>
                        <div class="input-group"><label>Ø¹Ù„Ø§Ù…Ø© Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</label><input type="text" id="prod-badge-en" placeholder="Hot"></div>
                    </div>
                    <div class="input-group"><label>Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© *</label><input type="file" id="prod-image" accept="image/*"></div>
                    <h4 style="color:var(--text-muted); border-bottom:1px solid #333; padding-bottom:5px; font-size:0.9em;">Ø£Ø¨Ø¹Ø§Ø¯ Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</h4>
                    <div class="flex-row">
                        <div class="input-group"><label>Ø§Ù„Ø·ÙˆÙ„</label><input type="text" id="prod-length"></div>
                        <div class="input-group"><label>Ø§Ù„Ø¹Ø±Ø¶</label><input type="text" id="prod-width"></div>
                        <div class="input-group"><label>Ø§Ù„ØªØ®Ø§Ù†Ø©</label><input type="text" id="prod-thickness"></div>
                    </div>
                    <button class="btn-main" onclick="addProduct()">Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
                </div>
            </div>

            <div class="flex-row" style="margin-top:20px;">
                <div class="panel">
                    <h3 class="panel-title"><i class="fas fa-palette"></i> Ø±Ø¨Ø· Ù„ÙˆÙ† Ø¨Ù…Ù†ØªØ¬</h3>
                    <div class="input-group"><label>Ø§Ù„Ù…Ù†ØªØ¬ *</label><select id="color-prod-id"></select></div>
                    <div class="flex-row">
                        <div class="input-group"><label>Ø§Ø³Ù… Ø§Ù„Ù„ÙˆÙ† (Ø¹Ø±Ø¨ÙŠ)</label><input type="text" id="color-name-ar" placeholder="Ø£Ø­Ù…Ø±"></div>
                        <div class="input-group"><label>Ø§Ù„Ø§Ø³Ù… (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label><input type="text" id="color-name-en" placeholder="Red"></div>
                    </div>
                    <div class="input-group"><label>Ø§Ù„ÙƒÙˆØ¯ (Hex)</label><input type="color" id="color-hex" value="#ff0000" style="height:40px;"></div>
                    <div class="input-group"><label>ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ù„Ù„ÙˆÙ† Ø¯Ù‡ *</label><input type="file" id="color-image" accept="image/*"></div>
                    <button class="btn-main" onclick="addColor()" style="background:#3742fa; color:#fff;">Ø­ÙØ¸ Ø§Ù„Ù„ÙˆÙ†</button>
                </div>
                <div class="panel">
                    <h3 class="panel-title"><i class="fas fa-ruler"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø§Ø³ Ù„Ù…Ù†ØªØ¬</h3>
                    <div class="input-group"><label>Ø§Ù„Ù…Ù†ØªØ¬ *</label><select id="size-prod-id"></select></div>
                    <div class="input-group"><label>Ø§Ù„Ù…Ù‚Ø§Ø³ (Ø¹Ø§Ù„Ù…ÙŠ)</label><input type="text" id="size-name" placeholder="S, M, L, XL, 42..."></div>
                    <button class="btn-main" onclick="addSize()" style="background:#2ed573; color:#000;">Ø­ÙØ¸ Ø§Ù„Ù…Ù‚Ø§Ø³</button>
                </div>
            </div>
        </section>

        <section id="edit-inventory" class="section">
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-edit"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²Ù† ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
                <div style="overflow-x:auto;">
                    <table>
                        <thead><tr><th>ØµÙˆØ±Ø©</th><th>Ø§Ù„Ù…Ù†ØªØ¬ (AR)</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th><th>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                        <tbody id="edit-products-table"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="shipping" class="section">
            <div class="panel" style="max-width: 500px; margin: auto;">
                <h2 class="panel-title"><i class="fas fa-truck"></i> ØªØ¹Ø¯ÙŠÙ„ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø´Ø­Ù†</h2>
                <div class="input-group"><label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label><select id="ship-city-select" onchange="loadSelectedCityPrice()"></select></div>
                <div class="input-group"><label>Ø³Ø¹Ø± Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¬.Ù…)</label><input type="number" id="ship-city-price"></div>
                <button class="btn-main" onclick="updateCityPrice()" style="background: var(--info); color: #fff;">ØªØ­Ø¯ÙŠØ« ØªØ³Ø¹ÙŠØ±Ø© Ø§Ù„Ø´Ø­Ù†</button>
            </div>
        </section>

        <section id="discounts" class="section">
            <div class="panel" style="max-width: 500px; margin: auto;">
                <h2 class="panel-title"><i class="fas fa-ticket-alt"></i> Ø¥ØµØ¯Ø§Ø± ÙƒÙˆØ¯ Ø®ØµÙ…</h2>
                <div class="input-group"><label>Ø§Ù„ÙƒÙˆØ¯</label><input type="text" id="promo-code" style="text-transform: uppercase;"></div>
                <div class="input-group"><label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… (%)</label><input type="number" id="promo-percent"></div>
                <button class="btn-main" onclick="addPromo()">ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†</button>
            </div>
        </section>

    </main>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="document.getElementById('edit-modal').style.display='none'"><i class="fas fa-times"></i></button>
            <h2 class="panel-title"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h2>
            <input type="hidden" id="edit-prod-id">
            
            <div class="flex-row">
                <div class="input-group"><label>Ø§Ù„Ø§Ø³Ù… (Ø¹Ø±Ø¨ÙŠ)</label><input type="text" id="edit-prod-title-ar"></div>
                <div class="input-group"><label>Ø§Ù„Ø§Ø³Ù… (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label><input type="text" id="edit-prod-title-en"></div>
            </div>
            <div class="flex-row">
                <div class="input-group"><label>Ø³Ø¹Ø± Ø§Ù„Ø¬Ù…Ù„Ø©</label><input type="number" id="edit-prod-cost"></div>
                <div class="input-group"><label>Ø³Ø¹Ø± Ø§Ù„Ù‚Ø·Ø§Ø¹ÙŠ</label><input type="number" id="edit-prod-price"></div>
                <div class="input-group"><label>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</label><input type="number" id="edit-prod-stock"></div>
            </div>
            <div class="flex-row">
                <div class="input-group"><label>Ø§Ù„Ø¹Ù„Ø§Ù…Ø© (AR)</label><input type="text" id="edit-prod-badge-ar"></div>
                <div class="input-group"><label>Ø§Ù„Ø¹Ù„Ø§Ù…Ø© (EN)</label><input type="text" id="edit-prod-badge-en"></div>
            </div>

            <button class="btn-main" onclick="saveProductEdit()" style="margin-top:20px;">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://wkfiocqhkspsvqgyjpea.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_l2vgR8Xbt0Csw8W_Slo_1Q_9glKlIoN';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let citiesData = []; let allProductsEdit = []; let allCategoriesEdit = [];

        function showLoader(text) { document.getElementById('loader-text').innerText = text; document.getElementById('loader').style.display = 'flex'; }
        function hideLoader() { document.getElementById('loader').style.display = 'none'; }

        function switchTab(tabId, btn) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');

            if(tabId === 'accounting') loadComprehensiveReports();
            if(tabId === 'orders') loadOrders();
            if(tabId === 'inventory') { loadCategoriesForSelects(); loadProductsList(); }
            if(tabId === 'edit-inventory') loadEditInventory();
            if(tabId === 'shipping') loadCitiesForDropdown();
        }

        async function uploadImage(file) {
            const fileExt = file.name.split('.').pop();
            const fileName = `${Math.random().toString(36).substring(2, 15)}_${Date.now()}.${fileExt}`;
            const { error } = await supabaseClient.storage.from('okaz_images').upload(fileName, file);
            if (error) throw error;
            return supabaseClient.storage.from('okaz_images').getPublicUrl(fileName).data.publicUrl;
        }

        // ================= Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª =================
        async function loadCategoriesForSelects() {
            const { data } = await supabaseClient.from('categories').select('*').order('created_at', { ascending: true });
            const selParent = document.getElementById('cat-parent-id');
            const selProdCat = document.getElementById('prod-cat');
            selParent.innerHTML = '<option value="">-- Ù‡Ø°Ø§ Ù‚Ø³Ù… Ø±Ø¦ÙŠØ³ÙŠ Ù…Ø³ØªÙ‚Ù„ --</option>';
            selProdCat.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… --</option>';
            
            data.forEach(c => {
                selParent.innerHTML += `<option value="${c.id}">${c.title_ar}</option>`;
                selProdCat.innerHTML += `<option value="${c.id}">${c.title_ar}</option>`;
            });
        }

        async function loadProductsList() {
            const { data } = await supabaseClient.from('products').select('*');
            let options = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬ --</option>'; 
            data.forEach(p => options += `<option value="${p.id}">${p.title_ar}</option>`);
            document.getElementById('color-prod-id').innerHTML = options; 
            document.getElementById('size-prod-id').innerHTML = options;
        }

        async function addCategory() {
            const title_ar = document.getElementById('cat-title-ar').value;
            const title_en = document.getElementById('cat-title-en').value || '';
            const parent_id = document.getElementById('cat-parent-id').value || null;
            const show_on_home = document.getElementById('cat-show-home').checked;
            const home_order = parseInt(document.getElementById('cat-home-order').value) || 0;
            const allow_in_bundles = document.getElementById('cat-allow-bundle').checked;
            const fileInput = document.getElementById('cat-images');
            
            if(!title_ar) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ!");
            
            showLoader("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...");
            try {
                let urls = []; 
                if(fileInput.files.length > 0) {
                    for(let i=0; i<fileInput.files.length; i++) urls.push(await uploadImage(fileInput.files[i]));
                }
                const imgToSave = urls.length > 0 ? urls[0] : '';
                
                await supabaseClient.from('categories').insert([{ 
                    title_ar, title_en, parent_id, show_on_home, home_order, allow_in_bundles, 
                    image: imgToSave, gallery: urls 
                }]);
                
                alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù… âœ…"); 
                document.getElementById('cat-title-ar').value=''; document.getElementById('cat-title-en').value=''; fileInput.value='';
                loadCategoriesForSelects();
            } catch(e) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£"); console.error(e); } 
            hideLoader();
        }

        async function addProduct() {
            const category_id = document.getElementById('prod-cat').value;
            const title_ar = document.getElementById('prod-title-ar').value;
            const title_en = document.getElementById('prod-title-en').value || '';
            const description_ar = document.getElementById('prod-desc-ar').value || '';
            const description_en = document.getElementById('prod-desc-en').value || '';
            const price = document.getElementById('prod-price').value;
            const cost_price = document.getElementById('prod-cost-price').value || 0;
            const stock_quantity = document.getElementById('prod-stock').value || 100;
            const badge_ar = document.getElementById('prod-badge-ar').value || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
            const badge_en = document.getElementById('prod-badge-en').value || 'None';
            const length_val = document.getElementById('prod-length').value || '';
            const width_val = document.getElementById('prod-width').value || '';
            const thickness_val = document.getElementById('prod-thickness').value || '';
            const fileInput = document.getElementById('prod-image');

            if(!category_id || !title_ar || !price || fileInput.files.length === 0) return alert("ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ù„ØµÙˆØ±Ø©!");
            
            showLoader("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...");
            try { 
                const imgUrl = await uploadImage(fileInput.files[0]); 
                await supabaseClient.from('products').insert([{ 
                    category_id, title_ar, title_en, description_ar, description_en, price, cost_price, 
                    stock_quantity, image: imgUrl, badge_ar, badge_en, length_val, width_val, thickness_val 
                }]); 
                alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ âœ…"); 
                document.getElementById('prod-title-ar').value=''; document.getElementById('prod-price').value=''; fileInput.value=''; 
                loadProductsList(); loadComprehensiveReports(); 
            } catch(e) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£"); } hideLoader();
        }

        async function addColor() {
            const product_id = document.getElementById('color-prod-id').value;
            const color_name_ar = document.getElementById('color-name-ar').value;
            const color_name_en = document.getElementById('color-name-en').value || '';
            const color_hex = document.getElementById('color-hex').value;
            const fileInput = document.getElementById('color-image');
            
            if(!product_id || !color_name_ar || fileInput.files.length === 0) return alert("ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");
            showLoader("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...");
            try { 
                const imgUrl = await uploadImage(fileInput.files[0]); 
                await supabaseClient.from('product_colors').insert([{ product_id, color_name_ar, color_name_en, color_hex, image_url: imgUrl }]); 
                alert("ØªÙ… Ø±Ø¨Ø· Ø§Ù„Ù„ÙˆÙ† âœ…"); document.getElementById('color-name-ar').value=''; fileInput.value=''; 
            } catch(e) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£"); } hideLoader();
        }

        async function addSize() { 
            const product_id = document.getElementById('size-prod-id').value, size_name = document.getElementById('size-name').value; 
            if(!product_id || !size_name) return alert("ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!"); 
            await supabaseClient.from('product_sizes').insert([{ product_id, size_name }]); 
            alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù‚Ø§Ø³ âœ…"); document.getElementById('size-name').value=''; 
        }

        // ================= Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª =================
        async function loadEditInventory() {
            showLoader("Ø³Ø­Ø¨ Ø§Ù„Ø¯Ø§ØªØ§...");
            const [prodsReq, catsReq] = await Promise.all([ supabaseClient.from('products').select('*').order('created_at', { ascending: false }), supabaseClient.from('categories').select('id, title_ar') ]);
            allProductsEdit = prodsReq.data || []; allCategoriesEdit = catsReq.data || [];
            const tbody = document.getElementById('edit-products-table'); tbody.innerHTML = '';
            
            allProductsEdit.forEach(p => {
                const catName = allCategoriesEdit.find(c => c.id === p.category_id)?.title_ar || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                tbody.innerHTML += `<tr><td><img src="${p.image}" style="width:40px;height:40px;border-radius:5px;object-fit:cover;"></td><td style="font-weight:bold;">${p.title_ar}</td><td>${catName}</td><td style="color:var(--primary);">${p.price} Ø¬.Ù…</td><td>${p.stock_quantity}</td><td><button class="btn-sm btn-edit" onclick="openEditModal('${p.id}')">ØªØ¹Ø¯ÙŠÙ„</button> <button class="btn-sm btn-delete" onclick="deleteProduct('${p.id}')">Ø­Ø°Ù</button></td></tr>`;
            }); hideLoader();
        }

        function openEditModal(id) {
            const p = allProductsEdit.find(x => x.id === id); if(!p) return;
            document.getElementById('edit-prod-id').value = p.id;
            document.getElementById('edit-prod-title-ar').value = p.title_ar;
            document.getElementById('edit-prod-title-en').value = p.title_en || '';
            document.getElementById('edit-prod-cost').value = p.cost_price;
            document.getElementById('edit-prod-price').value = p.price;
            document.getElementById('edit-prod-stock').value = p.stock_quantity;
            document.getElementById('edit-prod-badge-ar').value = p.badge_ar || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
            document.getElementById('edit-prod-badge-en').value = p.badge_en || 'None';
            document.getElementById('edit-modal').style.display = 'block';
        }

        async function saveProductEdit() {
            const id = document.getElementById('edit-prod-id').value;
            const updates = { title_ar: document.getElementById('edit-prod-title-ar').value, title_en: document.getElementById('edit-prod-title-en').value, cost_price: document.getElementById('edit-prod-cost').value, price: document.getElementById('edit-prod-price').value, stock_quantity: document.getElementById('edit-prod-stock').value, badge_ar: document.getElementById('edit-prod-badge-ar').value, badge_en: document.getElementById('edit-prod-badge-en').value };
            showLoader("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸..."); await supabaseClient.from('products').update(updates).eq('id', id);
            alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« âœ…"); document.getElementById('edit-modal').style.display = 'none'; loadEditInventory(); hideLoader();
        }
        async function deleteProduct(id) { if(confirm("Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ")) { showLoader("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù..."); await supabaseClient.from('products').delete().eq('id', id); loadEditInventory(); hideLoader(); } }

        async function loadComprehensiveReports() {
            const { data: orders } = await supabaseClient.from('orders').select('grand_total, status, discount_amount');
            let safe = 0, courier = 0, pending = 0, discounts = 0;
            if(orders) { orders.forEach(o => { if(o.status === 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„') safe += Number(o.grand_total); else if(o.status === 'Ù…Ø¹ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨') courier += Number(o.grand_total); else if(o.status !== 'Ù…Ù„ØºÙŠ' && o.status !== 'Ù…Ø±ØªØ¬Ø¹') pending += Number(o.grand_total); discounts += Number(o.discount_amount || 0); }); }
            document.getElementById('acc-safe').innerText = safe.toFixed(2) + ' Ø¬.Ù…'; document.getElementById('acc-courier').innerText = courier.toFixed(2) + ' Ø¬.Ù…'; document.getElementById('acc-pending').innerText = pending.toFixed(2) + ' Ø¬.Ù…'; document.getElementById('acc-discounts').innerText = discounts.toFixed(2) + ' Ø¬.Ù…';
            const { data: products } = await supabaseClient.from('products').select('price, cost_price, stock_quantity');
            let invCost = 0, invRetail = 0;
            if(products) { products.forEach(p => { invCost += Number(p.cost_price || 0) * Number(p.stock_quantity || 0); invRetail += Number(p.price || 0) * Number(p.stock_quantity || 0); }); }
            document.getElementById('inv-cost').innerText = invCost.toFixed(2) + ' Ø¬.Ù…'; document.getElementById('inv-retail').innerText = invRetail.toFixed(2) + ' Ø¬.Ù…'; document.getElementById('inv-profit').innerText = (invRetail - invCost).toFixed(2) + ' Ø¬.Ù…';
        }

        async function loadOrders() {
            const { data } = await supabaseClient.from('orders').select('*, order_items(*)').order('created_at', { ascending: false });
            const tbody = document.getElementById('orders-table'); tbody.innerHTML = '';
            data.forEach(o => {
                const shortId = o.id.split('-')[0].toUpperCase();
                let itemsHtml = o.order_items.map(i => `<div style="font-size:0.85em; color:#bbb;">- ${i.product_name} <b style="color:#fff">x${i.quantity}</b></div>`).join('');
                const statuses = ['Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²', 'Ù…Ø¹ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨', 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„', 'Ù…Ù„ØºÙŠ', 'Ù…Ø±ØªØ¬Ø¹'];
                let selectHtml = `<select class="status-select" onchange="updateOrderStatus('${o.id}', this.value)">`; statuses.forEach(s => { selectHtml += `<option value="${s}" ${o.status === s ? 'selected' : ''}>${s}</option>`; }); selectHtml += `</select>`;
                tbody.innerHTML += `<tr><td style="color:var(--primary); font-weight:bold;">#OKZ-${shortId}</td><td style="font-weight:bold;">${o.customer_name}<br><span style="font-size:0.8em; color:#888;">${o.customer_city}</span></td><td>${o.customer_phone}</td><td>${itemsHtml}</td><td style="color:var(--success); font-weight:bold;">${o.grand_total} Ø¬.Ù…</td><td>${selectHtml}</td></tr>`;
            });
        }
        async function updateOrderStatus(orderId, newStatus) { await supabaseClient.from('orders').update({ status: newStatus }).eq('id', orderId); loadComprehensiveReports(); }

        // Ø§Ù„Ø´Ø­Ù† ÙˆØ§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª
        async function loadCitiesForDropdown() { const { data } = await supabaseClient.from('shipping_rules').select('*').order('city_ar'); citiesData = data || []; const sel = document.getElementById('ship-city-select'); sel.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ù…Ø­Ø§ÙØ¸Ø© --</option>'; citiesData.forEach(c => sel.innerHTML += `<option value="${c.id}">${c.city_ar} (${c.city_en})</option>`); }
        function loadSelectedCityPrice() { const id = document.getElementById('ship-city-select').value; const city = citiesData.find(c => c.id === id); if(city) document.getElementById('ship-city-price').value = city.cost; }
        async function updateCityPrice() { const id = document.getElementById('ship-city-select').value, newPrice = document.getElementById('ship-city-price').value; if(!id || !newPrice) return alert("Ø§Ø®ØªØ± Ù…Ø­Ø§ÙØ¸Ø© ÙˆØ§ÙƒØªØ¨ Ø§Ù„Ø³Ø¹Ø±"); showLoader("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸..."); await supabaseClient.from('shipping_rules').update({ cost: newPrice }).eq('id', id); alert("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ğŸšš"); hideLoader(); }
        async function addPromo() { const code = document.getElementById('promo-code').value.toUpperCase(), percent = document.getElementById('promo-percent').value; await supabaseClient.from('promo_codes').insert([{ code, discount_percentage: percent }]); alert("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† ğŸ’¸"); }

        loadComprehensiveReports();
    </script>
</body>
</html>
