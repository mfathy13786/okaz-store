<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø³ÙˆÙ‚ Ø¹ÙƒØ§Ø² | Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Reem+Kufi:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>

    <style>
        :root { --primary: #e67e22; --dark: #0f0f0f; --card-bg: #1a1a1a; --text-light: #ecf0f1; --danger: #ff4757; --success: #2ed573; }
        body { font-family: 'Cairo', sans-serif; background-color: var(--dark); color: var(--text-light); margin: 0; padding: 0; overflow-x: hidden; }
        
        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .top-nav { position: sticky; top: 0; background: rgba(15, 15, 15, 0.95); backdrop-filter: blur(10px); border-bottom: 2px solid var(--primary); padding: 15px 20px; z-index: 1000; display: flex; justify-content: space-between; align-items: center; }
        .nav-logo { color:var(--primary); font-family:'Reem Kufi'; font-size:1.6em; text-decoration: none; cursor: pointer; }
        .cart-btn-nav { position: relative; cursor: pointer; color: #fff; font-size: 1.5em; }
        .cart-count { position: absolute; top: -8px; right: -12px; background: var(--primary); color: #000; font-size: 0.6em; font-weight: 900; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        .container { max-width: 1200px; margin: auto; padding: 20px; }
        .section-title { color: var(--text-light); border-right: 4px solid var(--primary); padding-right: 10px; margin: 30px 0 20px 0; }

        /* Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Swiper Slider) */
        .swiper-slide { border-radius: 15px; overflow: hidden; position: relative; cursor: pointer; border: 1px solid #333; }
        .cat-img { width: 100%; height: 180px; object-fit: cover; display: block; transition: 0.3s; }
        .swiper-slide:hover .cat-img { transform: scale(1.05); }
        .cat-title { position: absolute; bottom: 0; width: 100%; background: linear-gradient(transparent, rgba(0,0,0,0.9)); color: var(--primary); text-align: center; padding: 20px 0 10px; font-weight: 900; font-size: 1.2em; }

        /* Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª */
        .grid-layout { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .product-card { background: var(--card-bg); border-radius: 15px; border: 1px solid #333; overflow: hidden; display: flex; flex-direction: column; position: relative; transition: 0.3s; cursor: pointer; }
        .product-card:hover { border-color: var(--primary); box-shadow: 0 5px 15px rgba(230,126,34,0.2); }
        .product-badge { position: absolute; top: 10px; right: 10px; background: var(--danger); color: #fff; padding: 4px 10px; border-radius: 20px; font-size: 0.75em; font-weight: bold; z-index: 2; }
        .product-img { width: 100%; height: 180px; object-fit: cover; }
        .product-info { padding: 15px; text-align: right; display: flex; flex-direction: column; flex-grow: 1; }
        .product-title { font-weight: bold; font-size: 0.95em; margin-bottom: 5px; color: #fff; }
        .product-price { color: var(--primary); font-weight: 900; font-size: 1.2em; margin-top: auto; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„ÙÙˆØ±Ù… */
        .btn-main { background: var(--primary); color: #000; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 900; width: 100%; font-family: 'Cairo'; font-size: 1em; transition: 0.3s; }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(230,126,34,0.3); }
        .input-field { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: #222; color: #fff; margin-bottom: 15px; font-family: 'Cairo'; box-sizing: border-box; font-size: 1em; outline: none; }
        .input-field:focus { border-color: var(--primary); }

        /* Ø´Ø§Ø´Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ù„Ù…Ù‚Ø§Ø³Ø§Øª ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù† */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; overflow-y: auto; backdrop-filter: blur(5px); }
        .modal-content { background: #111; width: 95%; max-width: 500px; border-radius: 20px; padding: 20px; border: 1px solid #333; margin: 30px auto; position: relative; }
        .close-btn { position: absolute; top: 15px; left: 15px; background: #333; color: #fff; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 1.2em; }
        
        .preview-img { width: 100%; height: 300px; object-fit: cover; border-radius: 15px; margin-bottom: 15px; border: 1px solid #333; }
        .color-options, .size-options { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        .color-circle { width: 35px; height: 35px; border-radius: 50%; cursor: pointer; border: 2px solid #333; transition: 0.3s; }
        .color-circle.selected { border: 3px solid #fff; transform: scale(1.1); box-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .size-btn { background: #222; color: #fff; border: 1px solid #444; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-family: 'Cairo'; font-weight: bold; }
        .size-btn.selected { background: var(--primary); color: #000; border-color: var(--primary); }
        
        .dim-box { background: #222; padding: 10px; border-radius: 8px; display: inline-block; margin: 5px; font-size: 0.85em; color: #aaa; border: 1px dashed #444; }

        /* Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª (Autocomplete) */
        .autocomplete-container { position: relative; }
        .autocomplete-items { position: absolute; border: 1px solid #444; border-top: none; z-index: 99; top: 100%; left: 0; right: 0; background: #222; max-height: 150px; overflow-y: auto; border-radius: 0 0 8px 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .autocomplete-items div { padding: 12px; cursor: pointer; border-bottom: 1px solid #333; color: #fff; }
        .autocomplete-items div:hover { background-color: var(--primary); color: #000; font-weight: bold; }

        /* Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª */
        .cart-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding: 15px 0; }
        .qty-box { display: flex; align-items: center; gap: 10px; background: #222; padding: 5px 10px; border-radius: 8px; }
        .qty-btn { background: var(--primary); border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-weight: bold; font-size: 1.2em; color: #000; }
        .summary-box { background: #222; padding: 15px; border-radius: 10px; margin: 15px 0; border-right: 4px solid var(--primary); }
        .promo-box { display: flex; gap: 10px; margin-bottom: 15px; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ */
        .success-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 3000; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
        .success-content { background: #1a1a1a; padding: 40px 20px; border-radius: 20px; border: 1px solid var(--success); max-width: 400px; width: 90%; }
        .order-id-box { background: #222; color: var(--success); font-size: 1.5em; font-weight: 900; padding: 15px; border-radius: 10px; margin: 20px auto; letter-spacing: 2px; border: 1px dashed var(--success); }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <nav class="top-nav">
        <div class="nav-logo" onclick="window.location.reload()">Ø³ÙˆÙ‚ Ø¹ÙƒØ§Ø²</div>
        <div class="cart-btn-nav" onclick="openCart()">
            <i class="fas fa-shopping-bag"></i>
            <span class="cart-count" id="cart-count">0</span>
        </div>
    </nav>

    <div class="container">
        <div id="home-view">
            <h2 class="section-title">ØªØµÙØ­ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h2>
            <div class="swiper mySwiper">
                <div class="swiper-wrapper" id="categories-slider"></div>
            </div>

            <h2 class="section-title">Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
            <div class="grid-layout" id="all-products"></div>
        </div>

        <div id="category-view" class="hidden">
            <button onclick="showHome()" style="background:none; border:none; color:var(--primary); font-family:'Cairo'; font-size:1.1em; font-weight:bold; cursor:pointer; margin-bottom:15px;"><i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            <h2 class="section-title" id="cat-view-title"></h2>
            <div class="grid-layout" id="cat-products"></div>
        </div>
    </div>

    <div id="product-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeProductModal()"><i class="fas fa-times"></i></button>
            <img id="pd-img" class="preview-img" src="">
            <h2 id="pd-title" style="color:var(--primary); margin:0 0 10px 0;"></h2>
            <h3 id="pd-price" style="color:#fff; margin:0 0 15px 0;"></h3>
            
            <div id="pd-dimensions" style="margin-bottom:15px;"></div>

            <div id="pd-colors-section" class="hidden">
                <h4 style="margin-bottom:8px; color:#aaa;">Ø§Ø®ØªØ± Ø§Ù„Ù„ÙˆÙ†:</h4>
                <div class="color-options" id="pd-colors"></div>
            </div>

            <div id="pd-sizes-section" class="hidden">
                <h4 style="margin-bottom:8px; color:#aaa;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø§Ø³:</h4>
                <div class="size-options" id="pd-sizes"></div>
            </div>

            <button class="btn-main" id="pd-add-btn" style="margin-top:20px; font-size:1.2em;">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø© <i class="fas fa-cart-plus"></i></button>
        </div>
    </div>

    <div id="cart-modal" class="modal">
        <div class="modal-content" style="max-height: 90vh;">
            <button class="close-btn" onclick="closeCart()"><i class="fas fa-times"></i></button>
            <h2 class="section-title" style="margin-top:0;">Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h2>
            
            <div id="cart-items-container" style="max-height: 250px; overflow-y: auto; margin-bottom: 15px;"></div>

            <div id="checkout-area" class="hidden">
                <div class="promo-box">
                    <input type="text" id="promo-input" class="input-field" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… (Ø¥Ù† ÙˆØ¬Ø¯)" style="margin:0; text-transform:uppercase;">
                    <button class="btn-main" onclick="applyPromo()" style="width:100px; background:#333; color:#fff;">ØªØ·Ø¨ÙŠÙ‚</button>
                </div>
                <div id="promo-msg" style="color:var(--success); font-weight:bold; font-size:0.85em; margin-bottom:10px;"></div>

                <div class="summary-box">
                    <div style="display:flex; justify-content:space-between;"><span>Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:</span> <span><span id="summ-items">0</span> Ø¬.Ù…</span></div>
                    <div style="display:flex; justify-content:space-between; margin-top:5px;"><span>Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ø­Ù†:</span> <span><span id="summ-shipping">0</span> Ø¬.Ù…</span></div>
                    <div id="summ-discount-row" class="hidden" style="display:flex; justify-content:space-between; margin-top:5px; color:var(--danger);"><span>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…:</span> <span>-<span id="summ-discount">0</span> Ø¬.Ù…</span></div>
                    <div style="display:flex; justify-content:space-between; margin-top:10px; padding-top:10px; border-top:1px solid #444; font-size:1.3em; font-weight:900; color:var(--primary);"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ:</span> <span><span id="summ-total">0</span> Ø¬.Ù…</span></div>
                </div>

                <h3 style="color:#aaa; font-size:1.1em; border-bottom:1px solid #333; padding-bottom:5px;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„</h3>
                <input type="text" id="c-name" class="input-field" placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„">
                <input type="tel" id="c-phone" class="input-field" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ (01xxxxxxxxx)">
                
                <div class="autocomplete-container">
                    <input type="text" id="c-city-search" class="input-field" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ù…Ø­Ø§ÙØ¸ØªÙƒ Ù‡Ù†Ø§..." autocomplete="off">
                    <div id="city-list" class="autocomplete-items"></div>
                </div>
                <input type="hidden" id="c-city-final">
                <input type="hidden" id="c-shipping-cost" value="0">

                <textarea id="c-address" class="input-field" rows="2" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„ (Ø§Ù„Ù…Ù†Ø·Ù‚Ø©ØŒ Ø§Ù„Ø´Ø§Ø±Ø¹ØŒ Ø§Ù„Ø¹Ù…Ø§Ø±Ø©)"></textarea>
                
                <button id="submit-order-btn" class="btn-main" onclick="confirmOrder()" style="font-size:1.2em; padding:15px; background:var(--success); color:#fff;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù† <i class="fas fa-check-circle"></i></button>
            </div>
        </div>
    </div>

    <div id="success-modal" class="success-modal">
        <div class="success-content">
            <i class="fas fa-check-circle" style="font-size: 5em; color: var(--success); margin-bottom: 20px;"></i>
            <h2 style="color: #fff; margin-bottom: 10px;">ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!</h2>
            <p style="color: #bbb;">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ùˆ:</p>
            <div class="order-id-box" id="display-order-id">#OKZ-000</div>
            <p style="color: #bbb; margin-bottom: 30px;">Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‡Ø§ØªÙÙŠØ§Ù‹ Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø­Ù†.</p>
            <button onclick="window.location.reload()" class="btn-main">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://wkfiocqhkspsvqgyjpea.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_l2vgR8Xbt0Csw8W_Slo_1Q_9glKlIoN';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„ÙŠ Ù‡Ù†Ø³Ø­Ø¨Ù‡Ø§
        let categories = [], products = [], colors = [], sizes = [], shippingRules = [];
        let cart = JSON.parse(localStorage.getItem('okaz_cart')) || [];
        
        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£ÙˆØ±Ø¯Ø± ÙˆØ§Ù„Ù…ÙˆØ¯Ø§Ù„
        let activeProduct = null;
        let selectedColor = null;
        let selectedSize = null;
        let activeDiscountPercent = 0;
        let activePromoCode = "";

        // ================= Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ÙˆØ³Ø­Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =================
        async function initStore() {
            try {
                // Ø³Ø­Ø¨ ÙƒÙ„Ù‡ Ø¨Ø§Ù„ØªÙˆØ§Ø²ÙŠ Ø¹Ø´Ø§Ù† Ø§Ù„Ø³Ø±Ø¹Ø©
                const [catsReq, prodsReq, colorsReq, sizesReq, shipReq] = await Promise.all([
                    supabaseClient.from('categories').select('*'),
                    supabaseClient.from('products').select('*').order('created_at', { ascending: false }),
                    supabaseClient.from('product_colors').select('*'),
                    supabaseClient.from('product_sizes').select('*'),
                    supabaseClient.from('shipping_rules').select('*')
                ]);

                categories = catsReq.data || [];
                products = prodsReq.data || [];
                colors = colorsReq.data || [];
                sizes = sizesReq.data || [];
                shippingRules = shipReq.data || [];

                renderCategories();
                renderProducts(products, 'all-products');
                updateCartCount();
                setupAutocomplete();
            } catch(e) { console.error("Error loading store:", e); }
        }

        // ================= Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø© =================
        function renderCategories() {
            const slider = document.getElementById('categories-slider');
            slider.innerHTML = '';
            categories.forEach(c => {
                const imgToUse = (c.gallery && c.gallery.length > 0) ? c.gallery[0] : c.image;
                slider.innerHTML += `
                    <div class="swiper-slide" onclick="openCategory('${c.id}', '${c.title}')">
                        <img src="${imgToUse}" class="cat-img" onerror="this.src='https://via.placeholder.com/400x200?text=Ù‚Ø³Ù…'">
                        <div class="cat-title">${c.title}</div>
                    </div>
                `;
            });
            // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø±
            new Swiper(".mySwiper", { slidesPerView: 2.2, spaceBetween: 15, freeMode: true });
        }

        function renderProducts(prodArray, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            prodArray.forEach(p => {
                const badgeHtml = (p.badge && p.badge !== 'Ù„Ø§ ÙŠÙˆØ¬Ø¯') ? `<div class="product-badge">${p.badge}</div>` : '';
                container.innerHTML += `
                    <div class="product-card" onclick="openProductModal('${p.id}')">
                        ${badgeHtml}
                        <img src="${p.image}" class="product-img" onerror="this.src='https://via.placeholder.com/200'">
                        <div class="product-info">
                            <div class="product-title">${p.title}</div>
                            <div class="product-price">${p.price} Ø¬.Ù…</div>
                        </div>
                    </div>
                `;
            });
        }

        function openCategory(id, title) {
            document.getElementById('home-view').classList.add('hidden');
            document.getElementById('category-view').classList.remove('hidden');
            document.getElementById('cat-view-title').innerText = title;
            const filtered = products.filter(p => p.category_id === id);
            renderProducts(filtered, 'cat-products');
            window.scrollTo(0,0);
        }

        function showHome() {
            document.getElementById('home-view').classList.remove('hidden');
            document.getElementById('category-view').classList.add('hidden');
        }

        // ================= Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ø£Ø¨Ø¹Ø§Ø¯) =================
        function openProductModal(id) {
            activeProduct = products.find(p => p.id === id);
            selectedColor = 'Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ';
            selectedSize = 'Ù…Ù‚Ø§Ø³ Ù…ÙˆØ­Ø¯';

            document.getElementById('pd-img').src = activeProduct.image;
            document.getElementById('pd-title').innerText = activeProduct.title;
            document.getElementById('pd-price').innerText = activeProduct.price + ' Ø¬.Ù…';

            // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø©
            let dimHtml = '';
            if(activeProduct.length_val) dimHtml += `<div class="dim-box">Ø§Ù„Ø·ÙˆÙ„: ${activeProduct.length_val}</div>`;
            if(activeProduct.width_val) dimHtml += `<div class="dim-box">Ø§Ù„Ø¹Ø±Ø¶: ${activeProduct.width_val}</div>`;
            if(activeProduct.thickness_val) dimHtml += `<div class="dim-box">Ø§Ù„ØªØ®Ø§Ù†Ø©: ${activeProduct.thickness_val}</div>`;
            document.getElementById('pd-dimensions').innerHTML = dimHtml;

            // Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ØªØ§Ø­Ø©
            const prodColors = colors.filter(c => c.product_id === id);
            const colorSec = document.getElementById('pd-colors-section');
            if(prodColors.length > 0) {
                let html = '';
                prodColors.forEach((c, idx) => {
                    html += `<div class="color-circle" style="background-color:${c.color_hex};" onclick="selectColor('${c.color_name}', '${c.image_url}', this)" title="${c.color_name}"></div>`;
                });
                document.getElementById('pd-colors').innerHTML = html;
                colorSec.classList.remove('hidden');
            } else { colorSec.classList.add('hidden'); }

            // Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
            const prodSizes = sizes.filter(s => s.product_id === id);
            const sizeSec = document.getElementById('pd-sizes-section');
            if(prodSizes.length > 0) {
                let html = '';
                prodSizes.forEach(s => {
                    html += `<button class="size-btn" onclick="selectSize('${s.size_name}', this)">${s.size_name}</button>`;
                });
                document.getElementById('pd-sizes').innerHTML = html;
                sizeSec.classList.remove('hidden');
            } else { sizeSec.classList.add('hidden'); }

            document.getElementById('pd-add-btn').onclick = () => addToCart();
            document.getElementById('product-modal').style.display = 'block';
        }

        function selectColor(name, imgUrl, el) {
            selectedColor = name;
            document.getElementById('pd-img').src = imgUrl; // ØªØºÙŠÙŠØ± ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬ ÙÙˆØ±Ø§
            document.querySelectorAll('.color-circle').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
        }

        function selectSize(name, el) {
            selectedSize = name;
            document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
        }

        function closeProductModal() { document.getElementById('product-modal').style.display = 'none'; }

        // ================= Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª =================
        function addToCart() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ù† ÙƒØ§Ù† Ù„Ø§Ø²Ù… ÙŠØ®ØªØ§Ø± Ù„ÙˆÙ† ÙˆÙ…Ù‚Ø§Ø³ Ù„Ùˆ Ù…ØªÙˆÙØ±ÙŠÙ† ÙˆÙ…Ø®ØªØ§Ø±Ø´
            const hasColors = colors.filter(c => c.product_id === activeProduct.id).length > 0;
            const hasSizes = sizes.filter(s => s.product_id === activeProduct.id).length > 0;
            
            if(hasColors && selectedColor === 'Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ') return alert("Ø¨Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ÙˆÙ† Ø£ÙˆÙ„Ø§Ù‹");
            if(hasSizes && selectedSize === 'Ù…Ù‚Ø§Ø³ Ù…ÙˆØ­Ø¯') return alert("Ø¨Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù‚Ø§Ø³ Ø£ÙˆÙ„Ø§Ù‹");

            const itemKey = activeProduct.id + "_" + selectedColor + "_" + selectedSize;
            const exist = cart.find(x => x.key === itemKey);
            
            if(exist) exist.qty++;
            else cart.push({ key: itemKey, id: activeProduct.id, title: activeProduct.title, price: activeProduct.price, color: selectedColor, size: selectedSize, qty: 1 });
            
            localStorage.setItem('okaz_cart', JSON.stringify(cart));
            updateCartCount();
            closeProductModal();
            alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„Ø³Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­ ğŸ›’");
        }

        function updateCartCount() {
            const count = cart.reduce((sum, item) => sum + item.qty, 0);
            document.getElementById('cart-count').innerText = count;
        }

        function openCart() {
            renderCartItems();
            document.getElementById('cart-modal').style.display = 'block';
        }

        function closeCart() { document.getElementById('cart-modal').style.display = 'none'; }

        function changeQty(key, d) {
            const item = cart.find(x => x.key === key);
            item.qty += d;
            if(item.qty <= 0) cart = cart.filter(x => x.key !== key);
            localStorage.setItem('okaz_cart', JSON.stringify(cart));
            updateCartCount();
            renderCartItems();
        }

        function renderCartItems() {
            const container = document.getElementById('cart-items-container');
            const chkArea = document.getElementById('checkout-area');
            container.innerHTML = '';
            
            if(cart.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#888; padding:20px;">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©. Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³ÙˆÙ‚!</p>';
                chkArea.classList.add('hidden');
                return;
            }
            
            chkArea.classList.remove('hidden');
            let itemsTotal = 0;
            
            cart.forEach(item => {
                itemsTotal += item.price * item.qty;
                const details = (item.color !== 'Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ' || item.size !== 'Ù…Ù‚Ø§Ø³ Ù…ÙˆØ­Ø¯') ? `<div style="font-size:0.8em; color:#aaa;">${item.color} | ${item.size}</div>` : '';
                container.innerHTML += `
                    <div class="cart-item">
                        <div style="flex:1;">
                            <b style="color:#fff;">${item.title}</b>
                            ${details}
                            <div style="color:var(--primary); font-weight:bold;">${item.price} Ø¬.Ù…</div>
                        </div>
                        <div class="qty-box">
                            <button class="qty-btn" onclick="changeQty('${item.key}', 1)">+</button>
                            <span style="font-weight:bold; color:#fff;">${item.qty}</span>
                            <button class="qty-btn" onclick="changeQty('${item.key}', -1)">-</button>
                        </div>
                    </div>
                `;
            });
            
            calculateTotals(itemsTotal);
        }

        // ================= Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª =================
        async function applyPromo() {
            const code = document.getElementById('promo-input').value.toUpperCase();
            if(!code) return;
            const { data } = await supabaseClient.from('promo_codes').select('*').eq('code', code).eq('is_active', true);
            if(data && data.length > 0) {
                activePromoCode = code;
                activeDiscountPercent = data[0].discount_percentage;
                document.getElementById('promo-msg').innerText = `ØªÙ… ØªÙØ¹ÙŠÙ„ Ø®ØµÙ… ${activeDiscountPercent}% Ø¨Ù†Ø¬Ø§Ø­!`;
                renderCartItems(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨
            } else {
                alert("ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ!");
                activePromoCode = ""; activeDiscountPercent = 0;
                document.getElementById('promo-msg').innerText = '';
                renderCartItems();
            }
        }

        function calculateTotals(itemsTotal) {
            const shippingCost = Number(document.getElementById('c-shipping-cost').value) || 0;
            const discountAmount = (itemsTotal * activeDiscountPercent) / 100;
            const grandTotal = (itemsTotal - discountAmount) + shippingCost;

            document.getElementById('summ-items').innerText = itemsTotal;
            document.getElementById('summ-shipping').innerText = shippingCost;
            
            if(discountAmount > 0) {
                document.getElementById('summ-discount-row').classList.remove('hidden');
                document.getElementById('summ-discount').innerText = discountAmount.toFixed(2);
            } else {
                document.getElementById('summ-discount-row').classList.add('hidden');
            }
            
            document.getElementById('summ-total').innerText = grandTotal.toFixed(2);
        }

        // ================= Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª (Autocomplete) =================
        function setupAutocomplete() {
            const input = document.getElementById('c-city-search');
            const list = document.getElementById('city-list');

            input.addEventListener('input', function() {
                const val = this.value;
                list.innerHTML = '';
                if (!val) { document.getElementById('c-shipping-cost').value = 0; renderCartItems(); return; }

                // ØªØµÙÙŠØ© Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ù…ÙƒØªÙˆØ¨Ø©
                const matches = shippingRules.filter(s => s.city.includes(val));
                
                matches.forEach(match => {
                    const div = document.createElement('div');
                    div.innerHTML = `${match.city} <span style="color:var(--primary); font-size:0.8em; float:left;">${match.cost} Ø¬.Ù…</span>`;
                    div.addEventListener('click', function() {
                        input.value = match.city;
                        document.getElementById('c-city-final').value = match.city;
                        document.getElementById('c-shipping-cost').value = match.cost;
                        list.innerHTML = '';
                        renderCartItems(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± ÙÙŠ Ø§Ù„Ø³Ù„Ø©
                    });
                    list.appendChild(div);
                });
            });

            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ùˆ Ø¯Ø§Ø³ Ø¨Ø±Ø§
            document.addEventListener('click', function (e) { if (e.target !== input) list.innerHTML = ''; });
        }

        // ================= ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø³ÙŠØ±ÙØ± =================
        async function confirmOrder() {
            const n = document.getElementById('c-name').value;
            const p = document.getElementById('c-phone').value;
            const c = document.getElementById('c-city-final').value;
            const a = document.getElementById('c-address').value;
            const ship = Number(document.getElementById('c-shipping-cost').value);
            
            if(!n || !p || !c || !a) return alert("Ø¨Ø±Ø¬Ø§Ø¡ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ØŒ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŒ ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù†.");
            
            const btn = document.getElementById('submit-order-btn');
            btn.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ£ÙƒÙŠØ¯... <i class="fas fa-spinner fa-spin"></i>'; btn.disabled = true;

            const itemsTotal = Number(document.getElementById('summ-items').innerText);
            const discount = Number(document.getElementById('summ-discount').innerText) || 0;
            const grand = Number(document.getElementById('summ-total').innerText);

            try {
                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
                const { data: orderData, error: orderErr } = await supabaseClient.from('orders').insert([{
                    customer_name: n, customer_phone: p, customer_city: c, customer_address: a,
                    total_items_price: itemsTotal, shipping_cost: ship, discount_amount: discount,
                    grand_total: grand, promo_code_used: activePromoCode || null
                }]).select();

                if(orderErr) throw orderErr;
                const orderId = orderData[0].id;

                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                const itemsToInsert = cart.map(i => ({
                    order_id: orderId, product_name: i.title,
                    selected_color: i.color, selected_size: i.size,
                    quantity: i.qty, price: i.price
                }));

                await supabaseClient.from('order_items').insert(itemsToInsert);

                // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
                cart = []; localStorage.removeItem('okaz_cart'); updateCartCount();
                document.getElementById('cart-modal').style.display = 'none';
                document.getElementById('display-order-id').innerText = `#OKZ-${orderId.split('-')[0].toUpperCase()}`;
                document.getElementById('success-modal').style.display = 'flex';

            } catch(e) {
                console.error(e);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
                btn.innerHTML = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù† <i class="fas fa-check-circle"></i>'; btn.disabled = false;
            }
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ³ØªÙ…
        initStore();
    </script>
</body>
</html>
