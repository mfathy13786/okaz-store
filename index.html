<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø³ÙˆÙ‚ Ø¹ÙƒØ§Ø² | Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Reem+Kufi:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>

    <style>
        :root { --primary: #e67e22; --dark: #0f0f0f; --card-bg: #1a1a1a; --text-light: #ecf0f1; --danger: #ff4757; --success: #2ed573; }
        body { font-family: 'Cairo', sans-serif; background-color: var(--dark); color: var(--text-light); margin: 0; padding: 0; overflow-x: hidden; }
        
        .top-nav { position: sticky; top: 0; background: rgba(15, 15, 15, 0.95); backdrop-filter: blur(10px); border-bottom: 2px solid var(--primary); padding: 15px 20px; z-index: 1000; display: flex; justify-content: space-between; align-items: center; }
        .nav-logo { color:var(--primary); font-family:'Reem Kufi'; font-size:1.6em; text-decoration: none; cursor: pointer; }
        .nav-icons { display: flex; gap: 20px; align-items: center; }
        .icon-btn { position: relative; cursor: pointer; color: #fff; font-size: 1.5em; }
        .cart-count { position: absolute; top: -8px; right: -12px; background: var(--primary); color: #000; font-size: 0.6em; font-weight: 900; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        .container { max-width: 1200px; margin: auto; padding: 20px; }
        .section-title { color: var(--text-light); border-right: 4px solid var(--primary); padding-right: 10px; margin: 30px 0 20px 0; }

        /* Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .category-card { background: #111; border-radius: 15px; overflow: hidden; position: relative; cursor: pointer; border: 1px solid #333; transition: 0.3s; }
        .category-card:hover { border-color: var(--primary); }
        .cat-img { width: 100%; height: 180px; object-fit: cover; display: block; transition: 0.3s; }
        .category-card:hover .cat-img { transform: scale(1.05); }
        .cat-title { position: absolute; bottom: 0; width: 100%; background: linear-gradient(transparent, rgba(0,0,0,0.9)); color: var(--primary); text-align: center; padding: 20px 0 10px; font-weight: 900; font-size: 1.2em; }

        .grid-layout { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .product-card { background: var(--card-bg); border-radius: 15px; border: 1px solid #333; overflow: hidden; display: flex; flex-direction: column; position: relative; transition: 0.3s; cursor: pointer; }
        .product-card:hover { border-color: var(--primary); box-shadow: 0 5px 15px rgba(230,126,34,0.2); }
        .product-badge { position: absolute; top: 10px; right: 10px; background: var(--danger); color: #fff; padding: 4px 10px; border-radius: 20px; font-size: 0.75em; font-weight: bold; z-index: 2; }
        .product-img { width: 100%; height: 180px; object-fit: cover; }
        .product-info { padding: 15px; text-align: right; display: flex; flex-direction: column; flex-grow: 1; }
        .product-title { font-weight: bold; font-size: 0.95em; margin-bottom: 5px; color: #fff; }
        .product-price { color: var(--primary); font-weight: 900; font-size: 1.2em; margin-top: auto; }

        /* Ø³Ù„Ø§ÙŠØ¯Ø± ØµÙˆØ± Ø§Ù„Ù‚Ø³Ù… Ù…Ù† Ø¬ÙˆÙ‡ */
        .category-banner-slider { width: 100%; height: 250px; border-radius: 15px; overflow: hidden; margin-bottom: 25px; border: 1px solid #333; }
        .category-banner-slider img { width: 100%; height: 100%; object-fit: cover; }

        /* Forms & Modals */
        .btn-main { background: var(--primary); color: #000; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 900; width: 100%; font-family: 'Cairo'; font-size: 1em; transition: 0.3s; }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(230,126,34,0.3); }
        .input-field { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: #222; color: #fff; margin-bottom: 10px; font-family: 'Cairo'; box-sizing: border-box; font-size: 0.9em; outline: none; }
        .input-field:focus { border-color: var(--primary); }
        .flex-inputs { display: flex; gap: 10px; }
        .flex-inputs input { flex: 1; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; overflow-y: auto; backdrop-filter: blur(5px); }
        .modal-content { background: #111; width: 95%; max-width: 600px; border-radius: 20px; padding: 20px; border: 1px solid #333; margin: 30px auto; position: relative; }
        .close-btn { position: absolute; top: 15px; left: 15px; background: #333; color: #fff; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 1.2em; z-index: 10; }
        
        .preview-img { width: 100%; height: 300px; object-fit: cover; border-radius: 15px; margin-bottom: 15px; border: 1px solid #333; }
        .color-options, .size-options { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        .color-circle { width: 35px; height: 35px; border-radius: 50%; cursor: pointer; border: 2px solid #333; transition: 0.3s; }
        .color-circle.selected { border: 3px solid #fff; transform: scale(1.1); box-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .size-btn { background: #222; color: #fff; border: 1px solid #444; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-family: 'Cairo'; font-weight: bold; }
        .size-btn.selected { background: var(--primary); color: #000; border-color: var(--primary); }
        .dim-box { background: #222; padding: 8px 12px; border-radius: 8px; display: inline-block; margin: 5px; font-size: 0.85em; color: #aaa; border: 1px dashed #444; }

        /* Autocomplete */
        .autocomplete-container { position: relative; margin-bottom: 10px; }
        .autocomplete-items { position: absolute; border: 1px solid #444; border-top: none; z-index: 99; top: 100%; left: 0; right: 0; background: #222; max-height: 150px; overflow-y: auto; border-radius: 0 0 8px 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .autocomplete-items div { padding: 12px; cursor: pointer; border-bottom: 1px solid #333; color: #fff; }
        .autocomplete-items div:hover { background-color: var(--primary); color: #000; }

        /* Cart */
        .cart-item { display: flex; gap: 15px; align-items: center; border-bottom: 1px solid #333; padding: 15px 0; }
        .cart-item img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; border: 1px solid #444; }
        .qty-box { display: flex; align-items: center; gap: 10px; background: #222; padding: 5px 10px; border-radius: 8px; }
        .qty-btn { background: var(--primary); border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-weight: bold; color: #000; }
        .summary-box { background: #222; padding: 15px; border-radius: 10px; margin: 15px 0; border-right: 4px solid var(--primary); }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <nav class="top-nav">
        <div class="nav-logo" onclick="window.location.reload()">Ø³ÙˆÙ‚ Ø¹ÙƒØ§Ø²</div>
        <div class="nav-icons">
            <div class="icon-btn" onclick="openLoginModal()" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"><i class="fas fa-user-circle"></i></div>
            <div class="icon-btn" onclick="openCart()">
                <i class="fas fa-shopping-bag"></i>
                <span class="cart-count" id="cart-count">0</span>
            </div>
        </div>
    </nav>

    <div class="container">
        <div id="home-view">
            <h2 class="section-title">ØªØµÙØ­ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h2>
            <div class="grid-layout" id="categories-grid"></div>
            
            <h2 class="section-title">Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
            <div class="grid-layout" id="all-products"></div>
        </div>

        <div id="category-view" class="hidden">
            <button onclick="showHome()" style="background:none; border:none; color:var(--primary); font-family:'Cairo'; font-size:1.1em; font-weight:bold; cursor:pointer; margin-bottom:15px;"><i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            
            <div class="swiper myCategorySwiper category-banner-slider" id="cat-slider-wrapper">
                <div class="swiper-wrapper" id="cat-slider-content"></div>
                <div class="swiper-pagination"></div>
            </div>

            <h2 class="section-title" id="cat-view-title"></h2>
            <div class="grid-layout" id="cat-products"></div>
        </div>
    </div>

    <div id="product-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeProductModal()"><i class="fas fa-times"></i></button>
            <img id="pd-img" class="preview-img" src="">
            <h2 id="pd-title" style="color:var(--primary); margin:0 0 5px 0;"></h2>
            <p id="pd-desc" style="color:#aaa; font-size:0.9em; margin:0 0 10px 0;"></p>
            <h3 id="pd-price" style="color:#fff; margin:0 0 15px 0;"></h3>
            
            <div id="pd-dimensions" style="margin-bottom:15px;"></div>

            <div id="pd-colors-section" class="hidden">
                <h4 style="margin-bottom:8px; color:#aaa;">Ø§Ø®ØªØ± Ø§Ù„Ù„ÙˆÙ†:</h4>
                <div class="color-options" id="pd-colors"></div>
            </div>

            <div id="pd-sizes-section" class="hidden">
                <h4 style="margin-bottom:8px; color:#aaa;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø§Ø³:</h4>
                <div class="size-options" id="pd-sizes"></div>
            </div>

            <button class="btn-main" id="pd-add-btn" style="margin-top:20px; font-size:1.2em;">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø© <i class="fas fa-cart-plus"></i></button>
        </div>
    </div>

    <div id="cart-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeCart()"><i class="fas fa-times"></i></button>
            <h2 class="section-title" style="margin-top:0;">Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h2>
            
            <div id="cart-items-container" style="max-height: 250px; overflow-y: auto; margin-bottom: 15px;"></div>

            <div id="checkout-area" class="hidden">
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="promo-input" class="input-field" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… (Ø¥Ù† ÙˆØ¬Ø¯)" style="margin:0; text-transform:uppercase;">
                    <button class="btn-main" onclick="applyPromo()" style="width:100px; background:#333; color:#fff;">ØªØ·Ø¨ÙŠÙ‚</button>
                </div>
                <div id="promo-msg" style="color:var(--success); font-weight:bold; font-size:0.85em; margin-bottom:10px;"></div>

                <div class="summary-box">
                    <div style="display:flex; justify-content:space-between;"><span>Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:</span> <span><span id="summ-items">0</span> Ø¬.Ù…</span></div>
                    <div style="display:flex; justify-content:space-between; margin-top:5px;"><span>Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ø­Ù†:</span> <span><span id="summ-shipping">0</span> Ø¬.Ù…</span></div>
                    <div id="summ-discount-row" class="hidden" style="display:flex; justify-content:space-between; margin-top:5px; color:var(--danger);"><span>Ø§Ù„Ø®ØµÙ…:</span> <span>-<span id="summ-discount">0</span> Ø¬.Ù…</span></div>
                    <div style="display:flex; justify-content:space-between; margin-top:10px; padding-top:10px; border-top:1px solid #444; font-size:1.3em; font-weight:900; color:var(--primary);"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ:</span> <span><span id="summ-total">0</span> Ø¬.Ù…</span></div>
                </div>

                <h3 style="color:#aaa; font-size:1.1em; border-bottom:1px solid #333; padding-bottom:5px;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„</h3>
                <input type="text" id="c-name" class="input-field" placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„" autocomplete="name">
                <input type="tel" id="c-phone" class="input-field" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ (01xxxxxxxxx)" autocomplete="tel">
                <input type="email" id="c-email" class="input-field" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø¹Ø´Ø§Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø©)" autocomplete="email">
                
                <div class="autocomplete-container">
                    <input type="text" id="c-city-search" class="input-field" placeholder="Ø§ÙƒØªØ¨ Ù…Ø­Ø§ÙØ¸ØªÙƒ (Ù…Ø«Ø§Ù„: cairo Ø£Ùˆ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©)" autocomplete="off">
                    <div id="city-list" class="autocomplete-items"></div>
                </div>
                <input type="hidden" id="c-city-final"><input type="hidden" id="c-shipping-cost" value="0">

                <div class="flex-inputs">
                    <input type="text" id="c-area" class="input-field" placeholder="Ø§Ù„Ù…Ù†Ø·Ù‚Ø© / Ø§Ù„Ø­ÙŠ">
                    <input type="text" id="c-street" class="input-field" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø§Ø±Ø¹">
                </div>
                <div class="flex-inputs">
                    <input type="text" id="c-building" class="input-field" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±">
                    <input type="text" id="c-floor" class="input-field" placeholder="Ø§Ù„Ø¯ÙˆØ±">
                    <input type="text" id="c-apt" class="input-field" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø´Ù‚Ø©">
                </div>
                <input type="text" id="c-landmark" class="input-field" placeholder="Ø¹Ù„Ø§Ù…Ø© Ù…Ù…ÙŠØ²Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                
                <button id="submit-order-btn" class="btn-main" onclick="confirmOrder()" style="font-size:1.2em; padding:15px; background:var(--success); color:#fff; margin-top:10px;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù† <i class="fas fa-check-circle"></i></button>
            </div>
        </div>
    </div>

    <div id="auth-modal" class="modal">
        <div class="modal-content" style="text-align: center; max-width: 400px;">
            <button class="close-btn" onclick="document.getElementById('auth-modal').style.display='none'"><i class="fas fa-times"></i></button>
            <h2 style="color:var(--primary);">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¹ÙƒØ§Ø²</h2>
            <p style="color:#aaa; font-size:0.9em;">Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„ØªØªØ¨Ø¹ Ø·Ù„Ø¨Ø§ØªÙƒ ÙˆØ­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ</p>
            <button class="btn-main" onclick="alert('Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¬ÙˆØ¬Ù„ Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª')" style="background:#fff; color:#000; margin-bottom:15px;"><i class="fab fa-google" style="color:#DB4437;"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Google</button>
        </div>
    </div>

    <div id="success-modal" class="modal" style="display:none; justify-content:center; align-items:center; z-index:4000;">
        <div class="modal-content" style="text-align:center; border-color:var(--success);">
            <i class="fas fa-check-circle" style="font-size: 5em; color: var(--success); margin-bottom: 20px;"></i>
            <h2 style="color: #fff;">ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!</h2>
            <p style="color: #bbb;">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ùˆ:</p>
            <div style="background: #222; color: var(--success); font-size: 1.5em; font-weight: 900; padding: 15px; border-radius: 10px; margin: 20px auto; border: 1px dashed var(--success);" id="display-order-id">#OKZ-000</div>
            <button onclick="window.location.reload()" class="btn-main">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ³ÙˆÙ‚</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://wkfiocqhkspsvqgyjpea.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_l2vgR8Xbt0Csw8W_Slo_1Q_9glKlIoN';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let categories = [], products = [], colors = [], sizes = [], shippingRules = [];
        let cart = JSON.parse(localStorage.getItem('okaz_cart')) || [];
        let activeProduct = null, selectedColor = 'Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ', selectedSize = 'Ù…Ù‚Ø§Ø³ Ù…ÙˆØ­Ø¯', selectedColorImg = '';
        let activeDiscountPercent = 0, activePromoCode = "";
        let catSwiperInstance = null; // Ø¹Ø´Ø§Ù† Ù†Ø­ÙØ¸ Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± Ø¨ØªØ§Ø¹ Ø§Ù„Ù‚Ø³Ù…

        const cityAliases = {
            'cairo': 'Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©', 'cai': 'Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©', 'Ø§Ù„Ù‚Ø§Ù‡Ø±Ù‡': 'Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©',
            'alex': 'Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©', 'alexandria': 'Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©', 'Ø§Ù„Ø§Ø³ÙƒÙ†Ø¯Ø±ÙŠÙ‡': 'Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©', 'Ø§Ù„Ø§Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©': 'Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©',
            'giza': 'Ø§Ù„Ø¬ÙŠØ²Ø©', 'Ø§Ù„Ø¬ÙŠØ²Ù‡': 'Ø§Ù„Ø¬ÙŠØ²Ø©'
        };

        async function initStore() {
            try {
                const [catsReq, prodsReq, colorsReq, sizesReq, shipReq] = await Promise.all([
                    supabaseClient.from('categories').select('*'),
                    supabaseClient.from('products').select('*').order('created_at', { ascending: false }),
                    supabaseClient.from('product_colors').select('*'),
                    supabaseClient.from('product_sizes').select('*'),
                    supabaseClient.from('shipping_rules').select('*')
                ]);
                categories = catsReq.data || []; products = prodsReq.data || []; colors = colorsReq.data || []; sizes = sizesReq.data || []; shippingRules = shipReq.data || [];
                
                renderCategoriesHome();
                renderProducts(products, 'all-products');
                updateCartCount();
                setupAutocomplete();
            } catch(e) { console.error("Error", e); }
        }

        // ================= Ø§Ù„Ø£Ù‚Ø³Ø§Ù… =================
        function renderCategoriesHome() {
            const grid = document.getElementById('categories-grid');
            grid.innerHTML = '';
            categories.forEach(c => {
                const imgToUse = (c.gallery && c.gallery.length > 0) ? c.gallery[0] : c.image;
                grid.innerHTML += `<div class="category-card" onclick="openCategory('${c.id}', '${c.title}')"><img src="${imgToUse}" class="cat-img"><div class="cat-title">${c.title}</div></div>`;
            });
        }

        function openCategory(id, title) {
            document.getElementById('home-view').classList.add('hidden');
            document.getElementById('category-view').classList.remove('hidden');
            document.getElementById('cat-view-title').innerText = title;
            
            // ØªØ¯Ù…ÙŠØ± Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ø´Ø§Ù† Ù…ÙŠÙƒØ±ÙƒØ±Ø´
            if(catSwiperInstance) catSwiperInstance.destroy(true, true);
            
            const cat = categories.find(c => c.id === id);
            const sliderContent = document.getElementById('cat-slider-content');
            sliderContent.innerHTML = '';
            
            // Ø±Ø³Ù… ØµÙˆØ± Ø§Ù„Ù‚Ø³Ù… ÙƒØ³Ù„Ø§ÙŠØ¯Ø±
            if(cat.gallery && cat.gallery.length > 0) {
                document.getElementById('cat-slider-wrapper').style.display = 'block';
                cat.gallery.forEach(img => {
                    sliderContent.innerHTML += `<div class="swiper-slide"><img src="${img}"></div>`;
                });
                catSwiperInstance = new Swiper(".myCategorySwiper", { 
                    pagination: { el: ".swiper-pagination", clickable: true },
                    autoplay: { delay: 3000, disableOnInteraction: false },
                    loop: true
                });
            } else {
                document.getElementById('cat-slider-wrapper').style.display = 'none';
            }

            const filtered = products.filter(p => p.category_id === id);
            renderProducts(filtered, 'cat-products');
            window.scrollTo(0,0);
        }

        function showHome() { document.getElementById('home-view').classList.remove('hidden'); document.getElementById('category-view').classList.add('hidden'); }

        function renderProducts(prodArray, containerId) {
            const container = document.getElementById(containerId); container.innerHTML = '';
            prodArray.forEach(p => {
                const badgeHtml = (p.badge && p.badge !== 'Ù„Ø§ ÙŠÙˆØ¬Ø¯') ? `<div class="product-badge">${p.badge}</div>` : '';
                container.innerHTML += `<div class="product-card" onclick="openProductModal('${p.id}')">${badgeHtml}<img src="${p.image}" class="product-img"><div class="product-info"><div class="product-title">${p.title}</div><div class="product-price">${p.price} Ø¬.Ù…</div></div></div>`;
            });
        }

        // ================= Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙˆÙƒØ§Ø±Øª Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„Ø¹Ù…ÙŠÙ„ =================
        function openProductModal(id) {
            activeProduct = products.find(p => p.id === id);
            selectedColor = 'Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ'; selectedSize = 'Ù…Ù‚Ø§Ø³ Ù…ÙˆØ­Ø¯'; selectedColorImg = activeProduct.image;
            document.getElementById('pd-img').src = activeProduct.image;
            document.getElementById('pd-title').innerText = activeProduct.title;
            document.getElementById('pd-desc').innerText = activeProduct.description;
            document.getElementById('pd-price').innerText = activeProduct.price + ' Ø¬.Ù…';

            // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø©
            let dimHtml = '';
            if(activeProduct.length_val) dimHtml += `<div class="dim-box">Ø§Ù„Ø·ÙˆÙ„: ${activeProduct.length_val}</div>`;
            if(activeProduct.width_val) dimHtml += `<div class="dim-box">Ø§Ù„Ø¹Ø±Ø¶: ${activeProduct.width_val}</div>`;
            if(activeProduct.thickness_val) dimHtml += `<div class="dim-box">Ø§Ù„ØªØ®Ø§Ù†Ø©: ${activeProduct.thickness_val}</div>`;
            document.getElementById('pd-dimensions').innerHTML = dimHtml;

            const prodColors = colors.filter(c => c.product_id === id);
            const colorSec = document.getElementById('pd-colors-section');
            if(prodColors.length > 0) {
                let html = ''; prodColors.forEach((c) => { html += `<div class="color-circle" style="background-color:${c.color_hex};" onclick="selectColor('${c.color_name}', '${c.image_url}', this)" title="${c.color_name}"></div>`; });
                document.getElementById('pd-colors').innerHTML = html; colorSec.classList.remove('hidden');
            } else colorSec.classList.add('hidden');

            const prodSizes = sizes.filter(s => s.product_id === id);
            const sizeSec = document.getElementById('pd-sizes-section');
            if(prodSizes.length > 0) {
                let html = ''; prodSizes.forEach(s => { html += `<button class="size-btn" onclick="selectSize('${s.size_name}', this)">${s.size_name}</button>`; });
                document.getElementById('pd-sizes').innerHTML = html; sizeSec.classList.remove('hidden');
            } else sizeSec.classList.add('hidden');

            document.getElementById('pd-add-btn').onclick = () => addToCart();
            document.getElementById('product-modal').style.display = 'block';
        }

        function selectColor(name, imgUrl, el) { selectedColor = name; selectedColorImg = imgUrl; document.getElementById('pd-img').src = imgUrl; document.querySelectorAll('.color-circle').forEach(c => c.classList.remove('selected')); el.classList.add('selected'); }
        function selectSize(name, el) { selectedSize = name; document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('selected')); el.classList.add('selected'); }
        function closeProductModal() { document.getElementById('product-modal').style.display = 'none'; }
        function openLoginModal() { document.getElementById('auth-modal').style.display = 'flex'; }

        // ================= Ø§Ù„Ø³Ù„Ø© ÙˆØ§Ù„ØªØ£ÙƒÙŠØ¯ =================
        function addToCart() {
            const hasColors = colors.filter(c => c.product_id === activeProduct.id).length > 0;
            const hasSizes = sizes.filter(s => s.product_id === activeProduct.id).length > 0;
            if(hasColors && selectedColor === 'Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ') return alert("Ø§Ø®ØªØ§Ø± Ø§Ù„Ù„ÙˆÙ† ÙŠØ§ ØºØ§Ù„ÙŠ");
            if(hasSizes && selectedSize === 'Ù…Ù‚Ø§Ø³ Ù…ÙˆØ­Ø¯') return alert("Ø§Ø®ØªØ§Ø± Ø§Ù„Ù…Ù‚Ø§Ø³");

            const itemKey = activeProduct.id + "_" + selectedColor + "_" + selectedSize;
            const exist = cart.find(x => x.key === itemKey);
            if(exist) exist.qty++;
            else cart.push({ key: itemKey, id: activeProduct.id, title: activeProduct.title, price: activeProduct.price, color: selectedColor, size: selectedSize, qty: 1, img: selectedColorImg });
            
            localStorage.setItem('okaz_cart', JSON.stringify(cart)); updateCartCount(); closeProductModal(); alert("ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø© ğŸ›’");
        }

        function updateCartCount() { document.getElementById('cart-count').innerText = cart.reduce((sum, item) => sum + item.qty, 0); }
        function openCart() { renderCartItems(); document.getElementById('cart-modal').style.display = 'block'; }
        function closeCart() { document.getElementById('cart-modal').style.display = 'none'; }
        function changeQty(key, d) { const item = cart.find(x => x.key === key); item.qty += d; if(item.qty <= 0) cart = cart.filter(x => x.key !== key); localStorage.setItem('okaz_cart', JSON.stringify(cart)); updateCartCount(); renderCartItems(); }

        function renderCartItems() {
            const container = document.getElementById('cart-items-container');
            if(cart.length === 0) { container.innerHTML = '<p style="text-align:center; color:#888;">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©.</p>'; document.getElementById('checkout-area').classList.add('hidden'); return; }
            document.getElementById('checkout-area').classList.remove('hidden');
            let itemsTotal = 0; container.innerHTML = '';
            
            cart.forEach(item => {
                itemsTotal += item.price * item.qty;
                const details = (item.color !== 'Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ' || item.size !== 'Ù…Ù‚Ø§Ø³ Ù…ÙˆØ­Ø¯') ? `<div style="font-size:0.8em; color:#aaa;">${item.color} | ${item.size}</div>` : '';
                container.innerHTML += `<div class="cart-item"><img src="${item.img}" alt="img"><div style="flex:1;"><b style="color:#fff;">${item.title}</b> ${details}<div style="color:var(--primary); font-weight:bold;">${item.price} Ø¬.Ù…</div></div><div class="qty-box"><button class="qty-btn" onclick="changeQty('${item.key}', 1)">+</button><span style="font-weight:bold; color:#fff;">${item.qty}</span><button class="qty-btn" onclick="changeQty('${item.key}', -1)">-</button></div></div>`;
            });
            calculateTotals(itemsTotal);
        }

        async function applyPromo() {
            const code = document.getElementById('promo-input').value.toUpperCase();
            const { data } = await supabaseClient.from('promo_codes').select('*').eq('code', code).eq('is_active', true);
            if(data && data.length > 0) { activePromoCode = code; activeDiscountPercent = data[0].discount_percentage; document.getElementById('promo-msg').innerText = `ØªÙ… ØªÙØ¹ÙŠÙ„ Ø®ØµÙ… ${activeDiscountPercent}%`; }
            else { activePromoCode = ""; activeDiscountPercent = 0; document.getElementById('promo-msg').innerText = ''; alert("ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­!"); }
            renderCartItems();
        }

        function calculateTotals(itemsTotal) {
            const ship = Number(document.getElementById('c-shipping-cost').value) || 0;
            const discount = (itemsTotal * activeDiscountPercent) / 100;
            document.getElementById('summ-items').innerText = itemsTotal; document.getElementById('summ-shipping').innerText = ship;
            if(discount > 0) { document.getElementById('summ-discount-row').classList.remove('hidden'); document.getElementById('summ-discount').innerText = discount.toFixed(2); }
            else { document.getElementById('summ-discount-row').classList.add('hidden'); }
            document.getElementById('summ-total').innerText = ((itemsTotal - discount) + ship).toFixed(2);
        }

        function setupAutocomplete() {
            const input = document.getElementById('c-city-search'); const list = document.getElementById('city-list');
            input.addEventListener('input', function() {
                const val = this.value.toLowerCase(); list.innerHTML = '';
                if (!val) { document.getElementById('c-shipping-cost').value = 0; renderCartItems(); return; }
                const searchKey = cityAliases[val] || val;
                const matches = shippingRules.filter(s => s.city.includes(searchKey));
                matches.forEach(m => {
                    const div = document.createElement('div');
                    div.innerHTML = `${m.city} <span style="color:var(--primary); font-size:0.8em; float:left;">${m.cost} Ø¬.Ù…</span>`;
                    div.addEventListener('click', function() { input.value = m.city; document.getElementById('c-city-final').value = m.city; document.getElementById('c-shipping-cost').value = m.cost; list.innerHTML = ''; renderCartItems(); });
                    list.appendChild(div);
                });
            });
            document.addEventListener('click', e => { if (e.target !== input) list.innerHTML = ''; });
        }

        async function confirmOrder() {
            const n = document.getElementById('c-name').value, p = document.getElementById('c-phone').value, e = document.getElementById('c-email').value, city = document.getElementById('c-city-final').value;
            const area = document.getElementById('c-area').value, street = document.getElementById('c-street').value, bld = document.getElementById('c-building').value, flr = document.getElementById('c-floor').value, apt = document.getElementById('c-apt').value, lnd = document.getElementById('c-landmark').value;
            const ship = Number(document.getElementById('c-shipping-cost').value);
            
            if(!n || !p || !city || !area || !street) return alert("Ø¨Ø±Ø¬Ø§Ø¡ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© ÙˆØ§Ù„Ù…Ù†Ø·Ù‚Ø© ÙˆØ§Ù„Ø´Ø§Ø±Ø¹.");
            
            const btn = document.getElementById('submit-order-btn'); btn.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ£ÙƒÙŠØ¯... <i class="fas fa-spinner fa-spin"></i>'; btn.disabled = true;
            const itemsTotal = Number(document.getElementById('summ-items').innerText), discount = Number(document.getElementById('summ-discount').innerText) || 0, grand = Number(document.getElementById('summ-total').innerText);

            try {
                const { data: orderData, error: orderErr } = await supabaseClient.from('orders').insert([{ customer_name: n, customer_phone: p, customer_email: e, customer_city: city, customer_area: area, customer_street: street, customer_building: bld, customer_floor: flr, customer_apartment: apt, customer_landmark: lnd, total_items_price: itemsTotal, shipping_cost: ship, discount_amount: discount, grand_total: grand, promo_code_used: activePromoCode || null }]).select();
                if(orderErr) throw orderErr;
                const itemsToInsert = cart.map(i => ({ order_id: orderData[0].id, product_name: i.title, selected_color: i.color, selected_size: i.size, quantity: i.qty, price: i.price, image_url: i.img }));
                await supabaseClient.from('order_items').insert(itemsToInsert);

                cart = []; localStorage.removeItem('okaz_cart'); updateCartCount(); document.getElementById('cart-modal').style.display = 'none';
                document.getElementById('display-order-id').innerText = `#OKZ-${orderData[0].id.split('-')[0].toUpperCase()}`;
                document.getElementById('success-modal').style.display = 'flex';
            } catch(err) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„"); btn.innerHTML = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨'; btn.disabled = false; }
        }

        initStore();
    </script>
</body>
</html>
